<script>
    // --- TRANSLATION ---
    const translations = {
        id: {
            app_title: "Monitoring Hafalan Santri",
            login_welcome: "السلام عليكم ورحمة الله وبركاته<br>Selamat Datang!",
            login_welcome_text: "Terima kasih sudah mengunjungi aplikasi monitoring hafalan kami. Semoga bermanfaat.",
            login_title: "Sistem Monitoring Hafalan",
            login_subtitle: "Silakan masukkan kode akses untuk melanjutkan.",
            access_code_placeholder: "Kode Akses Anda",
            login_button: "Masuk",
            login_error: "Kode yang Anda masukkan salah.",
            hadith_text: "\"Sebaik-baik kalian adalah orang<br>yang belajar Al-Qur'an dan mengajarkannya.\"",
            tooltip_realtime: "Monitoring Real-time",
            tooltip_guardian: "Akses Wali Santri",
            tooltip_report: "Laporan Terstruktur",
            footer_text: "Project dibuat oleh team (muhammad nahya fadlallah)",
            unique_code_copied: "Kode akses berhasil disalin!",
            complaint_info: "Info Pengaduan"
        },
        en: {
            app_title: "Student Memorization Monitoring",
            login_welcome: "السلام عليكم ورحمة الله وبركاته<br>Welcome!",
            login_welcome_text: "Thank you for visiting our memorization monitoring application. We hope you find it useful.",
            login_title: "Memorization Monitoring System",
            login_subtitle: "Please enter the access code to continue.",
            access_code_placeholder: "Your Access Code",
            login_button: "Login",
            login_error: "The code you entered is incorrect.",
            hadith_text: "\"The best of you are those<br>who learn the Qur'an and teach it.\"",
            tooltip_realtime: "Real-time Monitoring",
            tooltip_guardian: "Guardian Access",
            tooltip_report: "Structured Reports",
            footer_text: "Project created by the team (muhammad nahya fadlallah)",
            unique_code_copied: "Access code copied successfully!",
            complaint_info: "Complaint Info"
        },
        ja: {
            app_title: "生徒の暗記モニタリング",
            login_welcome: "السلام عليكم ورحمة الله وبركاته<br>ようこそ！",
            login_welcome_text: "私たちの暗記モニタリングアプリケーションをご覧いただきありがとうございます。お役に立てば幸いです。",
            login_title: "暗記モニタリングシステム",
            login_subtitle: "続行するにはアクセスコードを入力してください。",
            access_code_placeholder: "アクセスコード",
            login_button: "ログイン",
            login_error: "入力したコードが間違っています。",
            hadith_text: "「あなた方の中で最も優れた者は<br>クルアーンを学び、それを教える者である。」",
            tooltip_realtime: "リアルタイムモニタリング",
            tooltip_guardian: "保護者アクセス",
            tooltip_report: "構造化レポート",
            footer_text: "プロジェクト作成者チーム (muhammad nahya fadlallah)",
            unique_code_copied: "アクセスコードが正常にコピーされました！",
            complaint_info: "苦情情報"
        },
        ar: {
            app_title: "مراقبة حفظ الطلاب",
            login_welcome: "السلام عليكم ورحمة الله وبركاته<br>أهلاً وسهلاً!",
            login_welcome_text: "شكراً لزيارتكم تطبيقنا لمراقبة الحفظ. نأمل أن يكون مفيداً لكم.",
            login_title: "نظام مراقبة الحفظ",
            login_subtitle: "الرجاء إدخال رمز الدخول للمتابعة.",
            access_code_placeholder: "رمز الدخول الخاص بك",
            login_button: "دخول",
            login_error: "الرمز الذي أدخلته غير صحيح.",
            hadith_text: "خيركم من تعلم القرآن وعلمه",
            tooltip_realtime: "مراقبة فورية",
            tooltip_guardian: "وصول ولي الأمر",
            tooltip_report: "تقارير منظمة",
            footer_text: "تم إنشاء المشروع بواسطة فريق (محمد نحيا فضل الله)",
            unique_code_copied: "تم نسخ رمز الدخول بنجاح!",
            complaint_info: "معلومات الشكوى"
        },
        ru: {
            app_title: "Мониторинг запоминания студентов",
            login_welcome: "السلام عليكم ورحمة الله وبركاته<br>Добро пожаловать!",
            login_welcome_text: "Спасибо, что посетили наше приложение для мониторинга запоминания. Надеемся, оно будет вам полезно.",
            login_title: "Система мониторинга запоминания",
            login_subtitle: "Пожалуйста, введите код доступа, чтобы продолжить.",
            access_code_placeholder: "Ваш код доступа",
            login_button: "Войти",
            login_error: "Вы ввели неверный код.",
            hadith_text: "\"Лучшими из вас являются те,<br>кто изучает Коран dan учит ему других.\"",
            tooltip_realtime: "Мониторинг в реальном времени",
            tooltip_guardian: "Доступ для опекунов",
            tooltip_report: "Структурированные отчеты",
            footer_text: "Проект создан командой (мухаммад нахья фадлаллах)",
            unique_code_copied: "Код доступа успешно скопирован!",
            complaint_info: "Информация о жалобах"
        },
        jw: {
            app_title: "Monitoring Apalan Santri",
            login_welcome: "السلام عليكم ورحمة الله وبركاته<br>Sugeng Rawuh!",
            login_welcome_text: "Matur nuwun sampun ngunjungi aplikasi monitoring apalan kita. Mugi-mugi mupangati.",
            login_title: "Sistem Monitoring Apalan",
            login_subtitle: "Monggo ketik kode akses kangge nglanjutaken.",
            access_code_placeholder: "Kode Akses Panjenengan",
            login_button: "Mlebet",
            login_error: "Kode ingkang panjenengan ketik salah.",
            hadith_text: "\"Sak apik-apike sliramu yaiku wong<br>sing sinau Al-Qur'an lan ngajarake.\"",
            tooltip_realtime: "Monitoring Real-time",
            tooltip_guardian: "Akses Wali Santri",
            tooltip_report: "Laporan Rapi",
            footer_text: "Proyek digarap dening tim (muhammad nahya fadlallah)",
            unique_code_copied: "Kode akses kasil disalin!",
            complaint_info: "Info Pengaduan"
        }
    };

    function setLanguage(lang) {
        document.documentElement.lang = lang;
        document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';

        const elements = document.querySelectorAll('[data-translate-key]');
        elements.forEach(el => {
            const key = el.getAttribute('data-translate-key');
            if (translations[lang] && translations[lang][key]) {
                if(el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    el.placeholder = translations[lang][key];
                } else {
                    el.innerHTML = translations[lang][key];
                }
            }
        });
        if (translations[lang] && translations[lang].app_title) {
            document.title = translations[lang].app_title;
        }
        localStorage.setItem('selectedLanguage', lang);
    }

    // --- APPLICATION STATE ---
    let appDataCache = {};
    let loginContext = null;

    const pages = {
        roleSelection: document.getElementById('role-selection-page'),
        pondokRegister: document.getElementById('pondok-register-page'),
        pondokLogin: document.getElementById('pondok-login-page'),
        accessCode: document.getElementById('access-code-page'),
        waliDashboard: document.getElementById('wali-dashboard-page'),
        detailSantri: document.getElementById('detail-santri-page'),
        guruDashboard: document.getElementById('guru-dashboard-page'),
        guruForm: document.getElementById('guru-form-page'),
        guruManagement: document.getElementById('guru-management-page'),
        jadwalDonasi: document.getElementById('jadwal-donasi-page'),
        about: document.getElementById('about-page'),
    };
    function showPage(pageName) {
        Object.values(pages).forEach(page => {
            if (page) page.classList.add('hidden');
        });
        if (pages[pageName]) {
            pages[pageName].classList.remove('hidden');
            pages[pageName].classList.add('flex');
        }
    }
    
    // FUNGSI NAVIGASI
    function checkLoginState() {
        const role = sessionStorage.getItem('role');
        const pondokDbId = sessionStorage.getItem('currentPondokId');
        if (role && pondokDbId) {
            if (role === 'guru') {
                renderGuruDashboard();
                showPage('guruDashboard');
            } else if (role === 'wali') {
                renderWaliDashboard();
                showPage('waliDashboard');
            }
        } else {
            showPage('roleSelection');
        }
    }

    function goBackFromJadwal() {
        const role = sessionStorage.getItem('role');
        if (role === 'guru') {
            backToGuruDashboard();
        } else if (role === 'wali') {
            backToWaliDashboard();
        } else {
            showPage('roleSelection');
        }
    }

    function backToWaliDashboard() { 
        renderWaliDashboard(); 
        showPage('waliDashboard'); 
    }

    function backToGuruDashboard() {
        renderGuruDashboard();
        showPage('guruDashboard');
    }

    // --- UTILITY FUNCTIONS ---
    function showToast(type, message) {
        console.log(`Toast: ${message}`);
        alert(message);
    }

    function copyAccessCode() {
        const codeEl = document.getElementById('unique-access-code');
        const range = document.createRange();
        range.selectNode(codeEl);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                alert(translations[localStorage.getItem('selectedLanguage') || 'id'].unique_code_copied);
            }
        } catch (err) {
            console.error('Failed to copy text:', err);
            alert("Gagal menyalin kode. Silakan salin manual: " + codeEl.textContent);
        }
        window.getSelection().removeAllRanges();
    }
    
    function copyDonationNumber() {
        const numberEl = document.getElementById('donation-number');
        const range = document.createRange();
        range.selectNode(numberEl);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                alert('Nomor telepon berhasil disalin!');
            }
        } catch (err) {
            console.error('Failed to copy text:', err);
            alert("Gagal menyalin nomor. Silakan salin manual: " + numberEl.textContent);
        }
        window.getSelection().removeAllRanges();
    }

    // --- API & DATA HANDLING ---
    async function fetchData() {
        const pondokDbId = sessionStorage.getItem('currentPondokId');
        if (!pondokDbId) return null;
        if (appDataCache[pondokDbId]) {
            return appDataCache[pondokDbId];
        }
        try {
            const response = await fetch('/api/get-data', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pondokDbId: pondokDbId })
            });
            const result = await response.json();
            if (result.success) {
                appDataCache[pondokDbId] = result.data;
                return appDataCache[pondokDbId];
            } else {
                console.error("Gagal mengambil data dari server:", result.message);
                return null;
            }
        } catch (error) {
            console.error("Gagal mengirim data ke server:", error);
            return null;
        }
    }
    
    async function saveData(endpoint, payload) {
        const currentPondokId = sessionStorage.getItem('currentPondokId');
        if (!currentPondokId) {
            alert("Sesi login berakhir. Silakan login kembali.");
            logout();
            return false;
        }
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.success) {
                appDataCache = {};
                return true;
            } else {
                console.error("Gagal menyimpan data:", result.message);
                alert("Gagal menyimpan data: " + result.message);
                return false;
            }
        } catch (error) {
            console.error("Gagal mengirim data ke server:", error);
            alert("Error koneksi ke server.");
            return false;
        }
    }
    
    async function uploadFile(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            const response = await fetch('/unggah', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                return result.file_url;
            } else {
                alert('Gagal mengunggah foto: ' + result.message);
                return null;
            }
        } catch (error) {
            alert('Error koneksi saat mengunggah foto.');
            return null;
        }
    }

    // --- AUTHENTICATION FLOW ---
    function handleRoleSelection(role) {
        showWelcomeVideo();
        loginContext = role;
        if (role === 'wali') {
            showPage('accessCode');
        } else if (role === 'guru') {
            showPage('pondokLogin');
        }
    }
    
    document.getElementById('pondok-register-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const pondokId = document.getElementById('register-pondok-id').value.trim();
        const password = document.getElementById('register-password').value;
        const errorEl = document.getElementById('register-error');
        if (!pondokId.includes('#') || password.length < 6) {
            errorEl.textContent = "Format Nama Pondok salah atau kata sandi terlalu pendek.";
            errorEl.classList.remove('hidden');
            return;
        }
        const pondokName = pondokId.split('#')[0].trim();
        try {
            const response = await fetch('/api/register', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pondokId, password, pondokName })
            });
            const result = await response.json();
            if (result.success) {
                alert(`Pendaftaran berhasil! Kode Akses Unik Anda: ${result.accessCode}. Salin kode ini dan berikan kepada wali santri.`);
                showPage('pondokLogin');
            } else {
                errorEl.textContent = result.message;
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            errorEl.textContent = "Terjadi kesalahan saat mendaftar.";
            errorEl.classList.remove('hidden');
        }
    });

    document.getElementById('pondok-login-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const pondokId = document.getElementById('login-pondok-id').value.trim();
        const password = document.getElementById('login-password').value;
        const errorEl = document.getElementById('pondok-login-error');
        try {
            const response = await fetch('/api/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ pondokId, password })
            });
            const result = await response.json();
            if (result.success) {
                sessionStorage.setItem('currentPondokId', result.pondokDbId);
                sessionStorage.setItem('pondokName', result.pondokName);
                sessionStorage.setItem('role', 'guru');
                checkLoginState();
            } else {
                errorEl.textContent = result.message;
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            errorEl.textContent = "Terjadi kesalahan saat login.";
            errorEl.classList.remove('hidden');
        }
    });

    document.getElementById('access-code-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const accessCode = document.getElementById('access-code').value.trim();
        const errorEl = document.getElementById('access-code-error');
        errorEl.classList.add('hidden'); // Reset pesan error

        try {
            const response = await fetch('/api/wali-login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ accessCode })
            });
            const result = await response.json();

            if (result.success) {
                sessionStorage.setItem('currentPondokId', result.pondokDbId);
                sessionStorage.setItem('pondokName', result.pondokName);
                sessionStorage.setItem('role', 'wali');
                checkLoginState();
            } else {
                errorEl.textContent = result.message;
                errorEl.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error:", error);
            errorEl.textContent = "Terjadi kesalahan koneksi. Silakan coba lagi.";
            errorEl.classList.remove('hidden');
        }
    });

    function logout() {
        sessionStorage.clear();
        loginContext = null;
        document.getElementById('access-code').value = '';
        document.getElementById('pondok-login-form').reset();
        showPage('roleSelection');
    }

    // --- DASHBOARD RENDERING ---
    async function renderWaliDashboard() {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) return;
        const gallery = document.getElementById('santri-gallery');
        gallery.innerHTML = '';
        pondokData.santri.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(santri => {
            const card = document.createElement('div');
            card.className = 'text-center cursor-pointer group santri-card';
            card.dataset.name = santri.nama;
            card.innerHTML = `
                <div class="relative">
                    <img src="${santri.foto}" alt="Foto ${santri.nama}" class="w-full h-auto aspect-square rounded-full object-cover transition-transform duration-300 group-hover:scale-105 border-4 border-white shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';">
                    <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-full transition-all duration-300 flex items-center justify-center">
                        <span class="text-white opacity-0 group-hover:opacity-100 font-bold">Lihat Detail</span>
                    </div>
                </div>
                <p class="mt-4 font-semibold text-gray-800">${santri.nama}</p>
                <p class="text-sm text-gray-500">Kelas ${santri.kelas}</p>
            `;
            card.onclick = () => showSantriDetail(santri.id);
            gallery.appendChild(card);
        });
    }

    async function showSantriDetail(santriId) {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) return;

        const santri = pondokData.santri.find(s => s.id === santriId);
        if (!santri) {
            console.error("Santri tidak ditemukan di data.");
            return;
        }

        const guru = pondokData.guru.find(g => g.mengajar_kelas === santri.kelas);
        const hafalan = pondokData.hafalan.filter(h => h.santri_id === santriId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));

        document.getElementById('detail-foto').src = santri.foto;
        document.getElementById('detail-foto').onerror = () => { document.getElementById('detail-foto').src = 'https://placehold.co/400x400?text=Error'; };
        document.getElementById('detail-nama').textContent = santri.nama;
        document.getElementById('detail-kelas').textContent = `Kelas ${santri.kelas}`;
        document.getElementById('detail-pengajar').textContent = guru ? `Pengajar: ${guru.nama}` : 'Pengajar belum diatur';

        const statusEl = document.getElementById('detail-status-target');
        if (santri.tercapai) {
            statusEl.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800';
            statusEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>Mencapai Target`;
        } else {
            statusEl.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800';
            statusEl.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.21 3.03-1.742 3.03H4.42c-1.532 0-2.492-1.696-1.742-3.03l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-8a1 1 0 011-1h.01a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>Belum Mencapai Target`;
        }

        document.getElementById('total-hafalan-juz').textContent = santri.total_hafalan_juz || '0';
        document.getElementById('target-harian').textContent = santri.target_harian || '-';
        document.getElementById('target-mingguan').textContent = santri.target_mingguan || '-';
        document.getElementById('target-bulanan').textContent = santri.target_bulanan || '-';
        document.getElementById('target-tahunan').textContent = santri.target_tahunan || '-';

        const chartsContainer = document.getElementById('progress-charts');
        chartsContainer.innerHTML = '';
        const historyBody = document.getElementById('hafalan-history');
        historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">Memuat data...</td></tr>';
        if (hafalan.length > 0) {
            historyBody.innerHTML = '';
            hafalan.forEach(h => {
                const row = historyBody.insertRow();
                row.innerHTML = `<td class="py-4 px-6 text-sm text-gray-900">${new Date(h.tanggal).toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}</td><td class="py-4 px-6 text-sm text-gray-900 font-medium">${h.setoran}</td><td class="py-4 px-6 text-sm text-gray-500">${h.jenis}</td><td class="py-4 px-6 text-sm"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${h.penilaian === 'Lancar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${h.penilaian}</span></td>`;
            });
        } else {
            historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-500">Belum ada riwayat setoran.</td></tr>';
        }
        showPage('detailSantri');
    }

    async function renderGuruDashboard() {
        const pondokData = await fetchData();
        if (!pondokData) return;

        document.getElementById('unique-access-code').textContent = pondokData.uniqueAccessCode || 'Tidak ada kode';
        document.getElementById('whatsapp-link').href = `https://wa.me/?text=${encodeURIComponent('Halo, wali santri! Berikut adalah kode akses unik untuk monitoring hafalan anak Anda: ' + pondokData.uniqueAccessCode)}`;

        const listContainer = document.getElementById('guru-santri-list');
        listContainer.innerHTML = '';
        pondokData.santri.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(santri => {
            const item = document.createElement('div');
            item.className = 'bg-white p-4 rounded-lg shadow-sm flex justify-between items-center';
            item.innerHTML = `<div class="flex items-center space-x-4"><img src="${santri.foto}" alt="${santri.nama}" class="w-12 h-12 rounded-full object-cover" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';"><div><p class="font-bold text-gray-900">${santri.nama}</p><p class="text-sm text-gray-500">Kelas ${santri.kelas}</p></div></div><div class="flex space-x-2"><button onclick="showGuruForm(${santri.id})" class="px-4 py-2 text-sm font-semibold text-white bg-teal-500 rounded-md hover:bg-teal-600">Ubah Data</button><button onclick="deleteSantri(${santri.id})" class="px-4 py-2 text-sm font-semibold text-white bg-red-500 rounded-md hover:bg-red-600">Hapus</button></div>`;
            listContainer.appendChild(item);
        });
    }

    // FUNGSI showGuruForm - SUDAH DIPERBAIKI
    async function showGuruForm(santriId) {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) {
            console.error("Data pondok tidak ditemukan atau tidak memiliki properti 'santri'.");
            alert("Gagal memuat data santri. Silakan coba lagi.");
            return;
        }

        const form = document.getElementById('santri-form');
        form.reset();
        document.getElementById('hafalan-management-section').classList.add('hidden');
        document.getElementById('santri-id').value = santriId || '';

        if (santriId) {
            const santri = pondokData.santri.find(s => s.id === santriId);
            if (!santri) {
                console.error(`Santri dengan ID ${santriId} tidak ditemukan.`);
                alert("Santri tidak ditemukan.");
                return;
            }

            document.getElementById('form-title').textContent = `Ubah Data: ${santri.nama}`;
            document.getElementById('nama').value = santri.nama;
            document.getElementById('kelas').value = santri.kelas;
            document.getElementById('total-hafalan-juz').value = santri.total_hafalan_juz || '';

            if (santri.tercapai !== undefined) {
                document.getElementById('form-target-harian').value = santri.target_harian || '';
                document.getElementById('form-target-mingguan').value = santri.target_mingguan || '';
                document.getElementById('form-target-bulanan').value = santri.target_bulanan || '';
                document.getElementById('form-target-tahunan').value = santri.target_tahunan || '';
                
                const checkedRadio = document.querySelector(`input[name="tercapai"]:checked`);
                if (checkedRadio) {
                    checkedRadio.checked = false;
                }
                const newCheckedRadio = document.querySelector(`input[name="tercapai"][value="${santri.tercapai}"]`);
                if (newCheckedRadio) {
                    newCheckedRadio.checked = true;
                }
            }

            document.getElementById('hafalan-management-section').classList.remove('hidden');
            renderGuruHafalanTable(santriId);
        } else {
            document.getElementById('form-title').textContent = 'Tambah Santri Baru';
        }
        showPage('guruForm');
    }
    document.getElementById('santri-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const form = this;
        const pondokId = sessionStorage.getItem('currentPondokId');

        // Step 1: Unggah file foto
        const fotoInput = document.getElementById('foto');
        let fotoUrl = null;
        if (fotoInput.files.length > 0) {
            fotoUrl = await uploadFile(fotoInput.files[0]);
            if (!fotoUrl) return;
        } else {
            const santriId = document.getElementById('santri-id').value;
            if (santriId) {
                const cachedPondokData = appDataCache[pondokId];
                if (cachedPondokData && cachedPondokData.santri) {
                    const santri = cachedPondokData.santri.find(s => s.id === parseInt(santriId));
                    if (santri) fotoUrl = santri.foto;
                }
            }
        }
        
        // Step 2: Kirim data santri ke server
        const santriId = document.getElementById('santri-id').value ? parseInt(document.getElementById('santri-id').value) : null;
        const nama = document.getElementById('nama').value;
        const kelas = document.getElementById('kelas').value;
        const totalHafalanJuz = document.getElementById('total-hafalan-juz').value;
        const harian = document.getElementById('form-target-harian').value;
        const mingguan = document.getElementById('form-target-mingguan').value;
        const bulanan = document.getElementById('form-target-bulanan').value;
        const tahunan = document.getElementById('form-target-tahunan').value;
        const tercapai = document.querySelector('input[name="tercapai"]:checked')?.value === 'true';

        const santriData = {
            id: santriId,
            nama,
            kelas,
            foto: fotoUrl,
            total_hafalan_juz: totalHafalanJuz,
            target: {
                harian,
                mingguan,
                bulanan,
                tahunan,
                tercapai
            }
        };

        const saveSuccess = await saveData('/api/save-santri', {
            pondokId: pondokId,
            santriData: santriData
        });
        
        if(saveSuccess) {
            alert('Data santri berhasil disimpan!');
            backToGuruDashboard();
        } else {
            alert("Gagal menyimpan data di server.");
        }
    });

    // FUNGSI deleteSantri - SUDAH DIPERBAIKI
    async function deleteSantri(santriId) {
        if (confirm('Apakah Anda yakin ingin menghapus data santri ini? Semua data hafalan yang terkait juga akan dihapus.')) {
            const payload = { santriId: santriId };
            const saveSuccess = await saveData('/api/delete-santri', { santriId });
            if(saveSuccess) {
                alert('Data santri berhasil dihapus!');
                const pondokData = await fetchData();
                renderGuruDashboard();
            } else {
                alert("Gagal menghapus data di server.");
            }
        }
    }

    function backToGuruDashboard() {
        renderGuruDashboard();
        showPage('guruDashboard');
    }

    // --- GURU MANAGEMENT ---
    async function showGuruManagementPage() {
        document.getElementById('guru-form').reset();
        document.getElementById('guru-id').value = '';
        await renderGuruList();
        showPage('guruManagement');
    }

    async function renderGuruList() {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.guru) return;
        const tableBody = document.getElementById('guru-list-table');
        tableBody.innerHTML = '';
        pondokData.guru.sort((a,b) => a.nama.localeCompare(b.nama)).forEach(guru => {
            const row = tableBody.insertRow();
            row.innerHTML = `
                <td class="py-4 px-6 text-sm font-medium text-gray-900">${guru.nama}</td>
                <td class="py-4 px-6 text-sm text-gray-500">${guru.mengajar_kelas}</td>
                <td class="py-4 px-6 text-sm font-medium space-x-2">
                    <button onclick="editGuru(${guru.id})" class="text-teal-600 hover:text-teal-900">Ubah</button>
                    <button onclick="deleteGuru(${guru.id})" class="text-red-600 hover:text-red-900">Hapus</button>
                </td>
            `;
        });
    }

    document.getElementById('guru-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const pondokId = sessionStorage.getItem('currentPondokId');
        if (!pondokId) return;

        const guruId = document.getElementById('guru-id').value ? parseInt(document.getElementById('guru-id').value) : null;
        const nama = document.getElementById('guru-nama').value;
        const kelas = document.getElementById('guru-kelas').value;

        const guruData = { id: guruId, nama, mengajar_kelas: kelas };
        
        const saveSuccess = await saveData('/api/save-guru', { pondokId, guruData });
        if(saveSuccess) {
            renderGuruList();
            this.reset();
            document.getElementById('guru-id').value = '';
        } else {
            alert("Gagal menyimpan data guru.");
        }
    });

    async function editGuru(guruId) {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.guru) return;
        const guru = pondokData.guru.find(g => g.id === guruId);
        if (guru) {
            document.getElementById('guru-id').value = guru.id;
            document.getElementById('guru-nama').value = guru.nama;
            document.getElementById('guru-kelas').value = guru.mengajar_kelas;
            window.scrollTo(0, 0);
        }
    }

    async function deleteGuru(guruId) {
        if (!confirm('Apakah Anda yakin ingin menghapus data guru ini?')) return;
        const pondokId = sessionStorage.getItem('currentPondokId');
        const saveSuccess = await saveData('/api/delete-guru', { pondokId, guruId });
        if(saveSuccess) {
            alert('Data guru berhasil dihapus!');
            renderGuruList();
        } else {
            alert("Gagal menghapus data guru.");
        }
    }

    // --- HAFALAN MANAGEMENT (GURU) ---
    async function renderGuruHafalanTable(santriId) {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.hafalan) return;
        const tableBody = document.getElementById('guru-hafalan-table');
        tableBody.innerHTML = '';
        const hafalanList = pondokData.hafalan.filter(h => h.santri_id === santriId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
        if (hafalanList.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada setoran.</td></tr>';
            return;
        }
        hafalanList.forEach(h => {
            const row = tableBody.insertRow();
            row.innerHTML = `<td class="py-2 px-4">${h.tanggal}</td><td class="py-2 px-4 font-medium">${h.setoran}</td><td class="py-2 px-4">${h.jenis}</td><td class="py-2 px-4">${h.penilaian}</td><td class="py-2 px-4"><button onclick="deleteHafalan(${h.id}, ${santriId})" class="text-red-500 hover:text-red-700">Hapus</button></td>`;
        });
    }

    document.getElementById('hafalan-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const pondokId = sessionStorage.getItem('currentPondokId');
        if (!pondokId) return;

        const santriId = parseInt(document.getElementById('santri-id').value);
        const newHafalan = {
            tanggal: document.getElementById('hafalan-tanggal').value,
            setoran: document.getElementById('hafalan-setoran').value,
            jenis: document.getElementById('hafalan-jenis').value,
            penilaian: document.getElementById('hafalan-penilaian').value,
            santriId: santriId,
        };

        const saveSuccess = await saveData('/api/save-hafalan', { pondokId, hafalanData: newHafalan });
        if(saveSuccess) {
            alert('Data hafalan berhasil disimpan!');
            renderGuruHafalanTable(santriId);
            this.reset();
        } else {
            alert("Gagal menambahkan setoran hafalan.");
        }
    });

    async function deleteHafalan(hafalanId, santriId) {
        if (!confirm('Apakah Anda yakin ingin menghapus setoran hafalan ini?')) return;
        const pondokId = sessionStorage.getItem('currentPondokId');
        const saveSuccess = await saveData('/api/delete-hafalan', { pondokId, hafalanId });
        if(saveSuccess) {
            alert('Setoran hafalan berhasil dihapus!');
            renderGuruHafalanTable(santriId);
        } else {
            alert("Gagal menghapus setoran hafalan.");
        }
    }

    // --- UTILITY & OTHER FEATURES ---
    function togglePasswordVisibility(inputId, toggleButton) {
        const input = document.getElementById(inputId);
        const eyeIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>`;
        const eyeSlashIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.243 4.243L6.228 6.228" /></svg>`;
        if (input.type === "password") {
            input.type = "text";
            toggleButton.innerHTML = eyeSlashIcon;
        } else {
            input.type = "password";
            toggleButton.innerHTML = eyeIcon;
        }
    }

    function showAboutPage() {
        showPage('about');
    }

    function showWelcomeVideo() {
        if (!sessionStorage.getItem('welcomeVideoShown')) {
            const modal = document.getElementById('video-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            sessionStorage.setItem('welcomeVideoShown', 'true');
        }
    }

    function closeVideoModal() {
        const modal = document.getElementById('video-modal');
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            modal.style.opacity = '1';
        }, 300);
    }

    function showJadwalDonasiPage() {
        fetchJadwalSholat();
        showPage('jadwalDonasi');
    }

    // --- PRAYER TIMES AND ALARM LOGIC ---
    let alarmInterval = null;
    let prayerTimesToday = {};

    function getCoordinates() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => resolve({
                        latitude: position.coords.latitude,
                        longitude: position.coords.longitude
                    }),
                    error => reject(error)
                );
            } else {
                reject(new Error("Geolocation is not supported by this browser."));
            }
        });
    }

    async function fetchJadwalSholat() {
        const container = document.getElementById('jadwal-sholat-container');
        const lokasiEl = document.getElementById('jadwal-lokasi');
        container.innerHTML = `<div class="col-span-full text-center">Memuat...</div>`;

        let latitude = -6.2088;
        let longitude = 106.8456;
        let locationName = "Jakarta, Indonesia";

        try {
            const coords = await getCoordinates();
            latitude = coords.latitude;
            longitude = coords.longitude;
            const geoNameResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=id`);
            if (geoNameResponse.ok) {
                const geoNameData = await geoNameResponse.json();
                locationName = `${geoNameData.city || geoNameData.locality}, ${geoNameData.countryName}`;
            } else {
                locationName = "Lokasi Anda Saat Ini";
            }
        } catch (error) {
            console.warn("Gagal mendapatkan lokasi GPS, menggunakan lokasi default (Jakarta).", error);
        }

        lokasiEl.textContent = `Untuk wilayah ${locationName} dan sekitarnya.`;
        try {
            const date = new Date();
            const year = date.getFullYear();
            const month = date.getMonth() + 1;

            const response = await fetch(`https://api.aladhan.com/v1/calendar?latitude=${latitude}&longitude=${longitude}&month=${month}&year=${year}`);
            if (!response.ok) throw new Error(`API Waktu Solat Error: ${response.status}`);

            const data = await response.json();
            const todayTimings = data.data[date.getDate() - 1].timings;
            container.innerHTML = '';
            const jadwalPenting = {
                'Subuh': todayTimings.Fajr, 'Zuhur': todayTimings.Dhuhr, 'Asar': todayTimings.Asr,
                'Magrib': todayTimings.Maghrib, 'Isya': todayTimings.Isha, 'Imsak': todayTimings.Imsak,
            };
            prayerTimesToday = {
                'Fajr': todayTimings.Fajr.substring(0, 5), 'Dhuhr': todayTimings.Dhuhr.substring(0, 5),
                'Asr': todayTimings.Asr.substring(0, 5), 'Maghrib': todayTimings.Maghrib.substring(0, 5),
                'Isha': todayTimings.Isha.substring(0, 5),
            };
            for (const [nama, waktu] of Object.entries(jadwalPenting)) {
                container.innerHTML += `
                    <div class="bg-teal-50 p-4 rounded-lg shadow-sm">
                        <p class="font-semibold text-teal-800">${nama}</p>
                        <p class="text-2xl font-bold text-gray-800">${waktu.substring(0, 5)}</p>
                    </div>`;
            }

            setupPrayerAlarm();
        } catch (error) {
            container.innerHTML = `<div class="col-span-full text-center text-red-500">Gagal memuat jadwal solat. Pastikan anda mempunyai sambungan internet.</div>`;
            console.error("Error fetching prayer times:", error);
        }
    }

    function handleAlarmToggleChange() {
        const isChecked = document.getElementById('alarm-toggle').checked;
        localStorage.setItem('alarmEnabled', isChecked);
        if(isChecked) {
            const audio = document.getElementById('azan-alarm');
            audio.play().then(() => audio.pause()).catch(e => console.log("User interaction needed to play audio."));
            setupPrayerAlarm();
            alert('Alarm Azan diaktifkan. Notifikasi akan muncul saat waktu salat tiba.');
        } else {
            if(alarmInterval) clearInterval(alarmInterval);
            alert('Alarm Azan dinonaktifkan.');
        }
    }

    function setupPrayerAlarm() {
        if(alarmInterval) clearInterval(alarmInterval);
        const alarmEnabled = localStorage.getItem('alarmEnabled') === 'true';
        if(!alarmEnabled) return;
        alarmInterval = setInterval(checkPrayerTimes, 30000);
    }

    function checkPrayerTimes() {
        const now = new Date();
        const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

        for(const [prayer, time] of Object.entries(prayerTimesToday)) {
            if(time === currentTime) {
                const prayerName = {Fajr: "Subuh", Dhuhr: "Zuhur", Asr: "Asar", Maghrib: "Magrib", Isha: "Isya"}[prayer];
                playAlarm(prayerName);
            }
        }
    }

    function playAlarm(prayerName) {
        const audio = document.getElementById('azan-alarm');
        audio.play().catch(e => {
            console.error("Gagal memutar audio alarm:", e);
            // Fallback for failed playback
            const notification = document.getElementById('alarm-notification');
            document.getElementById('alarm-text').textContent = `Waktu Salat ${prayerName} telah tiba.`;
            notification.classList.remove('hidden');
            setTimeout(() => dismissAlarm(), 5000); // hide after 5 seconds
        });

        const notification = document.getElementById('alarm-notification');
        document.getElementById('alarm-text').textContent = `Telah Masuk Waktu Salat ${prayerName}`;
        notification.classList.remove('hidden');
        setTimeout(() => dismissAlarm(), 300000);
    }

    function dismissAlarm() {
        const audio = document.getElementById('azan-alarm');
        audio.pause();
        audio.currentTime = 0;
        const notification = document.getElementById('alarm-notification');
        notification.classList.add('hidden');
    }

    // --- INITIALIZATION ---
    document.addEventListener('DOMContentLoaded', () => {
        const savedLang = localStorage.getItem('selectedLanguage') || 'id';
        document.getElementById('language-selector').value = savedLang;
        setLanguage(savedLang);

        const alarmToggle = document.getElementById('alarm-toggle');
        alarmToggle.checked = localStorage.getItem('alarmEnabled') === 'true';
        alarmToggle.addEventListener('change', handleAlarmToggleChange);

        const kelasSelectSantri = document.getElementById('kelas');
        const kelasSelectGuru = document.getElementById('guru-kelas');

        kelasSelectSantri.innerHTML = '';
        kelasSelectGuru.innerHTML = '';

        for (let i = 65; i <= 90; i++) {
            const letter = String.fromCharCode(i);
            const optionSantri = document.createElement('option');
            optionSantri.value = letter;
            optionSantri.textContent = `Kelas ${letter}`;
            kelasSelectSantri.appendChild(optionSantri);
            const optionGuru = document.createElement('option');
            optionGuru.value = letter;
            optionGuru.textContent = `Kelas ${letter}`;
            kelasSelectGuru.appendChild(optionGuru);
        }

        const targetHarianSelect = document.getElementById('form-target-harian');
        for (let i = 1; i <= 15; i++) {
            targetHarianSelect.add(new Option(`${i} Baris`, `${i} Baris`));
        }

        const targetMingguanSelect = document.getElementById('form-target-mingguan');
        targetMingguanSelect.add(new Option('Setengah Halaman', 'Setengah Halaman'));
        for (let i = 1; i <= 20; i++) {
            targetMingguanSelect.add(new Option(`${i} Halaman`, `${i} Halaman`));
        }

        checkLoginState();
        showPage('roleSelection');
    });
    </script>
</body>
</html>