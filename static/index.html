<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Hafalan Santri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/static/service-worker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
    <style>
      :root {
      --color-primary-light: #f0f4f8;
      --color-secondary-light: #ffffff;
      --color-text-light: #1f2937;
      --color-text-secondary-light: #6b7280;
      --color-accent-gold: #FFD700;
      }
      body {
      font-family: 'Inter', sans-serif;
      /* Background dihapus, menggunakan kelas Tailwind CSS (bg-gray-900) */
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      color: #e0e0e0;
      transition: background-color 0.5s ease;
      position: relative;
      }
      .main-content {
      background: linear-gradient(135deg, rgba(0, 0, 51, 0.8), rgba(0, 0, 0, 0.8));
      backdrop-filter: blur(10px);
      border-radius: 1rem;
      border: 1px solid rgba(255, 215, 0, 0.2);
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
      }
      /* Modern Panel Design */
      .modern-panel {
      background: linear-gradient(135deg, rgba(0, 0, 51, 0.8), rgba(0, 0, 0, 0.8));
      border: 1px solid #333;
      box-shadow: 0 4px 60px rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(20px);
      position: relative;
      overflow: hidden;
      border-radius: 1rem;
      }
      .modern-panel::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: conic-gradient(from 0deg, rgba(255, 255, 255, 0) 0%, rgba(255, 215, 0, 0.5) 10%, rgba(255, 215, 0, 0) 20%);
      animation: rotate-border 6s linear infinite;
      z-index: -1;
      }
      @keyframes rotate-border {
      from {
      transform: rotate(0deg);
      }
      to {
      transform: rotate(360deg);
      }
      }
      /* New Futuristic Panel Style */
      .futuristic-panel {
        background: linear-gradient(135deg, rgba(0, 0, 51, 0.6), rgba(0, 0, 0, 0.6));
        border: 1px solid rgba(77, 159, 202, 0.5);
        box-shadow: 0 0 15px rgba(77, 159, 202, 0.3);
        backdrop-filter: blur(5px);
        border-radius: 0.75rem;
        padding: 1.5rem;
        transition: all 0.3s ease;
      }
      .futuristic-panel:hover {
        box-shadow: 0 0 25px rgba(77, 159, 202, 0.6);
      }
      /* Futuristic Icons with Glowing Effect */
      .futuristic-icon-panel .icon-item {
      position: relative;
      color: #ccc;
      transition: all 0.3s ease;
      }
      .futuristic-icon-panel .icon-item:hover {
      color: var(--color-accent-gold);
      transform: scale(1.1);
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.6);
      }
      /* Custom scrollbar */
      ::-webkit-scrollbar {
      width: 8px;
      }
      ::-webkit-scrollbar-track {
      background: #2d3748;
      }
      ::-webkit-scrollbar-thumb {
      background: #64748b;
      border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
      background: #4a5568;
      }
      .fade-in {
      animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
      from {
      opacity: 0;
      transform: translateY(10px);
      }
      to {
      opacity: 1;
      transform: translateY(0);
      }
      }
      /* Tooltip for features */
      .feature-tooltip .tooltip-text {
      visibility: hidden;
      width: 160px;
      background-color: #334155;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 8px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -80px;
      opacity: 0;
      transition: opacity 0.3s;
      }
      .feature-tooltip:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
      }
      /* Video Modal */
      #welcome-modal {
      transition: opacity 0.3s ease;
      }
      /* Custom toggle switch for alarm */
      .toggle-checkbox:checked {
      right: 0;
      border-color: #FFD700;
      }
      .toggle-checkbox:checked + .toggle-label {
      background-color: #FFD700;
      }
      /* Dark mode toggle switch */
      .quiz-option {
      transition: all 0.2s ease-in-out;
      }
      .quiz-option.selected {
      border: 2px solid #FFD700;
      background-color: #3b3a2e;
      font-weight: 600;
      }
      .quiz-option.correct {
      background-color: #1a533c;
      border: 2px solid #10B981;
      }
      .quiz-option.incorrect {
      background-color: #631717;
      border: 2px solid #EF4444;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 transition-colors duration-500">
    <!-- Welcome Modal with Elegant Visuals (Only shown once at app start) -->
    <div id="welcome-modal" class="fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4">
      <div class="relative w-full max-w-xl text-center">
        <h3 class="text-4xl sm:text-5xl font-bold text-white mb-8 transition-all duration-1000 ease-in-out transform -translate-y-10 opacity-0" id="welcome-title" style="font-family: 'MCS Hijaz S_U normal', serif;">السلام عليكم ورحمة الله وبركاته</h3>
        <p class="text-xl sm:text-2xl text-white italic mb-4 transition-all duration-1000 ease-in-out transform translate-y-10 opacity-0" id="welcome-subtitle">
          Selamat Datang di Aplikasi SantriQ
        </p>
        <p class="text-lg text-white transition-all duration-1000 ease-in-out transform translate-y-10 opacity-0" id="welcome-message">
         SANTRI AL-QUR'AN.
        </p>
      </div>
    </div>
    <!-- Main App Container -->
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
      <div id="role-selection-page" class="flex flex-col items-center justify-center min-h-screen p-4 bg-gray-900">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl text-center relative modern-panel">
          <h2 class="text-4xl font-bold text-gray-100">SantriQ</h2>
          <p class="text-gray-400">Silakan pilih peran Anda untuk melanjutkan:</p>
          <div class="space-y-4 pt-4">
            <button onclick="window.handleRoleSelection('wali')" class="w-full px-4 py-3 font-semibold text-white bg-teal-700 rounded-lg hover:bg-teal-800">
            Saya Wali Santri
            </button>
            <button onclick="window.handleRoleSelection('guru')" class="w-full px-4 py-3 font-semibold text-gray-900 bg-yellow-100 rounded-lg hover:bg-yellow-200">
            Saya Pengurus / Guru
            </button>
          </div>
        </div>
        <div class="flex flex-col items-center mt-8 w-full max-w-sm mx-auto space-y-6">
          <div class="flex flex-wrap justify-center space-x-4 futuristic-icon-panel">
            <div class="feature-tooltip relative">
              <div class="w-12 h-12 futuristic-panel !p-0 rounded-full shadow-md flex items-center justify-center icon-item">
                <i class="fas fa-chart-line h-6 w-6"></i>
              </div>
              <span class="tooltip-text">Monitoring Real-time</span>
            </div>
            <div class="feature-tooltip relative">
              <div class="w-12 h-12 futuristic-panel !p-0 rounded-full shadow-md flex items-center justify-center icon-item">
                <i class="fas fa-users-cog h-6 w-6"></i>
              </div>
              <span class="tooltip-text">Akses Wali Santri</span>
            </div>
            <div class="feature-tooltip relative">
              <div class="w-12 h-12 futuristic-panel !p-0 rounded-full shadow-md flex items-center justify-center icon-item">
                <i class="fas fa-file-alt h-6 w-6"></i>
              </div>
              <span class="tooltip-text">Laporan Terstruktur</span>
            </div>
          </div>
          <div class="text-left text-center">
            <p class="text-sm italic text-gray-400 mt-2">"Sebaik-baik kalian adalah orang<br>yang belajar Al-Qur'an dan mengajarkannya."</p>
          </div>
        </div>
        <footer class="mt-8 text-center text-sm text-gray-500">
          <button onclick="window.showAboutPage()" class="text-yellow-400 hover:text-yellow-500 underline mb-2">Tentang Aplikasi</button>
          <p>Project dibuat oleh (MUHAMMAD NAHYA FADLALLAH) ©2025 All Rights Reserved</p>
          <a href="https://wa.me/6285520767908" target="_blank" class="block mt-4 text-center">
          <span class="text-sm font-semibold text-gray-400">PUSAT BANTUAN</span>
          </a>
        </footer>
      </div>
      <div id="pondok-register-page" class="hidden flex-col items-center justify-center min-h-screen p-4 bg-gray-900">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl relative modern-panel">
          <h2 class="text-2xl font-bold text-center text-gray-100">Daftarkan Pondok Anda</h2>
          <form id="pondok-register-form" class="space-y-6">
            <div>
              <label for="register-pondok-id" class="block text-sm font-medium text-gray-300">Nama Pondok & Nomor Unik</label>
              <input type="text" id="register-pondok-id" placeholder="Contoh: PPTI#12345" class="mt-1 w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
              <p class="text-xs text-gray-500 mt-1">Gunakan tanda pagar (#) untuk memisahkan nama dan nomor unik.</p>
            </div>
            <div>
              <label for="register-password" class="block text-sm font-medium text-gray-300">Buat Kata Sandi</label>
              <div class="relative mt-1">
                <input type="password" id="register-password" placeholder="Minimal 6 karakter" class="w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
                <button type="button" onclick="window.togglePasswordVisibility('register-password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                <i class="fas fa-eye text-gray-500"></i>
                </button>
              </div>
            </div>
            <button type="submit" class="w-full px-4 py-3 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">
            Daftar
            </button>
          </form>
          <p id="register-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
          <p class="text-center text-sm text-gray-400">
            Sudah punya akun? <button onclick="window.showPage('pondokLogin')" class="font-semibold text-yellow-400 hover:underline">Masuk di sini</button>
          </p>
          <p class="text-center text-sm mt-4 text-gray-500">
            <button onclick="window.showPage('roleSelection')" class="hover:underline">Kembali ke pilihan peran</button>
          </p>
        </div>
      </div>
      <div id="pondok-login-page" class="hidden flex-col items-center justify-center min-h-screen p-4 bg-gray-900">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl relative modern-panel">
          <p class="text-4xl text-yellow-400 text-center" style="font-family: 'MCS Hijaz S_U normal', serif;">بسم الله الرحمن الرحيم</p>
          <h2 class="text-2xl font-bold text-center text-gray-100">Login Pengurus / Guru</h2>
          <form id="pondok-login-form" class="space-y-6">
            <div>
              <label for="login-pondok-id" class="block text-sm font-medium text-gray-300">Nama Pondok & Nomor Unik</label>
              <input type="text" id="login-pondok-id" placeholder="Contoh: PPTI#12345" class="mt-1 w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
            </div>
            <div>
              <label for="login-password" class="block text-sm font-medium text-gray-300">Kata Sandi</label>
              <div class="relative mt-1">
                <input type="password" id="login-password" placeholder="Kata Sandi Anda" class="w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
                <button type="button" onclick="window.togglePasswordVisibility('login-password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                <i class="fas fa-eye text-gray-500"></i>
                </button>
              </div>
            </div>
            <button type="submit" class="w-full px-4 py-3 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">
            Login
            </button>
          </form>
          <p id="pondok-login-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
          <p class="text-center text-sm text-gray-400">
            Belum punya akun? <button onclick="window.showPage('pondokRegister')" class="font-semibold text-yellow-400 hover:underline">Daftar di sini</button>
          </p>
          <p class="text-center text-sm mt-4 text-gray-500">
            <button onclick="window.showPage('roleSelection')" class="hover:underline">Kembali ke pilihan peran</button>
          </p>
        </div>
      </div>
      <div id="access-code-page" class="hidden flex-col items-center justify-center min-h-screen p-4 bg-gray-900">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl relative modern-panel">
          <h2 class="text-2xl font-bold text-center text-gray-100">Kode Akses Wali Santri</h2>
          <p class="text-sm text-center text-gray-400">Silakan masukkan kode akses yang diberikan oleh pengurus.</p>
          <form id="access-code-form" class="space-y-6">
            <div>
              <label for="access-code" class="block text-sm font-medium text-gray-300">Kode Akses</label>
              <input type="text" id="access-code" placeholder="Masukkan kode" class="mt-1 w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
            </div>
            <button type="submit" class="w-full px-4 py-3 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">
            Masuk
            </button>
          </form>
          <p id="access-code-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
          <p class="text-center text-sm mt-4 text-gray-500">
            <button onclick="window.showPage('roleSelection')" class="hover:underline">Kembali ke pilihan peran</button>
          </p>
        </div>
      </div>
	 </div>
      <!-- ================== WALI DASHBOARD ================== -->
      <div id="wali-dashboard-page" 
        class="hidden fade-in main-content p-8 rounded-xl shadow-lg flex flex-col h-screen">
        <!-- Header -->
        <header class="flex flex-col items-center justify-center text-center mb-8 pb-4 border-b border-gray-700 flex-shrink-0">
          <h1 class="text-3xl font-bold text-yellow-400">Dashboard Wali Santri</h1>
          <p class="text-gray-400">Pilih kelas anak Anda untuk melihat detail progres hafalan.</p>
          <div class="w-full md:w-auto mt-4 md:mt-0 flex flex-wrap justify-center items-center space-x-2 space-y-2 md:space-x-4 md:space-y-0">
            <button onclick="window.showJadwalDonasiPage()" 
              class="px-4 py-2 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">
            Jadwal & Donasi
            </button>
            <button onclick="window.logout()" 
              class="px-4 py-2 font-semibold text-white bg-gray-700 rounded-lg hover:bg-gray-600">
            Keluar
            </button>
          </div>
        </header>
        <!-- Daftar Kelas -->
        <div id="kelas-list-container" class="overflow-y-auto flex-grow px-2 py-4">
          <div id="kelas-grid" 
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            <!-- Tombol kelas akan dirender di sini -->
          </div>
        </div>
        <!-- Daftar Santri -->
        <div id="santri-list-container" class="hidden overflow-y-auto flex-grow px-2 py-4">
          <button onclick="window.renderWaliDashboard()" 
            class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" 
              viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" 
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" 
                clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
          <h2 id="current-class-title" 
            class="text-2xl font-bold mb-4 text-gray-100 text-center"></h2>
          <div id="santri-gallery" 
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
          </div>
          <p id="no-results" class="text-center text-gray-500 py-10 hidden">
            Santri tidak ditemukan.
          </p>
        </div>
      </div>
      <!-- ================== DETAIL SANTRI ================== -->
      <div id="detail-santri-page" class="hidden fade-in p-4 bg-gray-900">
        <!-- Header -->
        <header class="mb-4">
         <button onclick="window.showSantriListByKelas(sessionStorage.getItem('currentWaliKelas'))"
            class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" 
              viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" 
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" 
                clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
        </header>
        <!-- Konten detail santri -->
        <div class="p-8 rounded-xl shadow-lg relative main-content">
          <!-- Foto + info santri -->
          <div class="flex flex-col items-center md:flex-row md:items-start 
            text-center md:text-left md:space-x-8 pb-8 border-b border-gray-700">
            <img id="detail-foto" src="" alt="Foto Santri" 
              class="w-32 h-32 rounded-full object-cover border-4 border-yellow-400 shadow-md mb-4 md:mb-0" 
              onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';">
            <div class="flex flex-col items-center md:items-start">
              <h2 id="detail-nama" class="text-3xl font-bold text-gray-100"></h2>
              <p id="detail-kelas" class="text-xl text-gray-400"></p>
              <p id="detail-pengajar" class="text-md text-yellow-400 font-semibold mt-1"></p>
              <div id="detail-status-target" 
                class="mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold"></div>
            </div>
          </div>
          <!-- Grafik futuristik -->
          <div class="py-8 border-b border-gray-700">
            <h3 class="text-2xl font-bold mb-6 text-center text-yellow-400">Grafik Progres Santri</h3>
            <div id="hafalan-future-chart" class="w-full h-80 futuristic-panel p-4"></div>
          </div>
          <div class="py-8 border-b border-gray-700">
            <h3 class="text-2xl font-bold mb-6 text-center text-yellow-400">Laporan Pencapaian Target</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 text-center">
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-gray-400">Total Hafalan Juz</p>
                <p id="total-hafalan-juz" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-gray-400">Target Harian</p>
                <p id="target-harian" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-gray-400">Target Mingguan</p>
                <p id="target-mingguan" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-gray-400">Target Bulanan</p>
                <p id="target-bulanan" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-gray-400">Target Tahunan</p>
                <p id="target-tahunan" class="text-lg font-bold text-yellow-400"></p>
              </div>
            </div>
          </div>
          <div class="pt-8">
            <h3 class="text-2xl font-bold mb-6 text-center text-yellow-400">Riwayat Setoran Hafalan</h3>
            <div class="overflow-x-auto futuristic-panel">
              <table class="min-w-full">
                <thead class="bg-gray-900">
                  <tr>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Tanggal</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Setoran</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Jenis</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Penilaian Guru</th>
                  </tr>
                </thead>
                <tbody id="hafalan-history" class="divide-y divide-gray-700"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div id="jadwal-donasi-page" class="hidden fade-in p-4 bg-gray-900">
        <header class="mb-4">
          <button onclick="window.goBackFromJadwal()" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali ke Dashboard
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg space-y-12 relative main-content">
          <div>
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-2">Jadwal Solat Hari Ini</h2>
            <div class="flex flex-col md:flex-row items-center justify-center space-x-3 my-4">
              <label for="alarm-toggle" class="font-semibold text-gray-300">Alarm Azan:</label>
              <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="alarm-toggle" id="alarm-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="alarm-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
              </div>
            </div>
            <p id="jadwal-lokasi" class="text-center text-gray-400 mb-6">Memuat data untuk lokasi anda...</p>
            <div id="jadwal-sholat-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
            </div>
          </div>
          <div>
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6">Donasi Pengembangan Aplikasi</h2>
            <div class="max-w-md mx-auto futuristic-panel p-6 rounded-lg text-center shadow-sm">
              <p class="text-gray-300 mb-4">Dukungan anda sangat berarti bagi kami untuk terus mengembangkan aplikasi ini agar lebih bermanfaat bagi ummat. Salurkan donasi terbaik anda melalui e-wallet berikut:</p>
              <div class="flex items-center justify-center space-x-2 my-4">
                <span id="donation-number" class="text-2xl font-bold text-gray-200 p-2 rounded-md border-2 border-dashed border-gray-600">0856 3777 508</span>
                <button onclick="window.copyDonationNumber()" class="px-4 py-3 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">Salin</button>
              </div>
              <div class="flex justify-center space-x-4 mt-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Logo_dana_blue.svg" alt="DANA" class="h-8">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/eb/Logo_ovo_purple.svg" alt="OVO" class="h-8">
              </div>
              <p class="text-sm text-gray-400 mt-4">a.n. Tim Pengembang MUHAMMAD NAHYA FADLALLAH</p>
            </div>
          </div>
        </div>
      </div>
      <div id="guru-dashboard-page" class="hidden fade-in main-content p-8 rounded-xl shadow-lg flex flex-col h-screen">
        <header class="flex flex-col items-center justify-center text-center mb-8 pb-4 border-b border-gray-700 flex-shrink-0">
          <h1 class="text-3xl font-bold text-yellow-400">Panel Guru</h1>
          <p class="text-gray-400 mb-4">Kelola data hafalan santri.</p>
          <div class="flex items-center space-x-2 mt-2 flex-wrap justify-center">
            <button onclick="window.showJadwalDonasiPage()" class="px-3 py-2 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">Jadwal & Donasi</button>
            <button onclick="window.showGuruManagementPage()" class="px-3 py-2 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">
            Kelola Data Guru
            </button>
            <button onclick="window.showGuruForm(null)" class="px-3 py-2 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500">
            + Tambah Santri Baru
            </button>
            <button onclick="window.logout()" class="px-3 py-2 text-sm font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200">Keluar</button>
          </div>
        </header>
        <div id="santri-grid-container" class="overflow-y-auto flex-grow px-2">
          <div id="guru-santri-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          </div>
        </div>
        <div id="unique-access-code-section" class="futuristic-panel mt-8 text-center flex-shrink-0">
          <h3 class="text-xl font-bold text-yellow-400 mb-4">Kode Akses Wali Santri</h3>
          <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <p id="unique-access-code" class="text-2xl font-mono tracking-widest text-gray-200 p-2 rounded-md border border-yellow-400 shadow-sm"></p>
            <button onclick="window.copyAccessCode()" class="px-4 py-2 bg-yellow-400 text-black rounded-md hover:bg-yellow-500">
            Salin Kode
            </button>
            <a id="whatsapp-link" href="#" target="_blank" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12.04 2.167c-5.495 0-9.96 4.465-9.96 9.96 0 1.634.437 3.275 1.258 4.71L2.16 21.84l4.966-1.306c1.37.78 2.912 1.185 4.914 1.185 5.494 0 9.96-4.465 9.96-9.96 0-5.495-4.466-9.96-9.96-9.96zM17.47 16.32c-.156.467-.936.463-1.603.224-.666-.238-2.618-1.01-3.036-1.166-.418-.157-.723-.235-1.028.235-.305.47-.936 1.165-1.14 1.413-.204.248-.408.27-.76.092-.352-.178-1.464-.539-2.79-1.722-1.028-.9-1.714-2.28-1.92-2.65-.204-.37-.02-.574.156-.76.155-.178.303-.306.46-.539.155-.234.204-.418.305-.652.102-.234.05-.438-.02-.652-.07-.215-.65-.585-.898-.82-.248-.235-.497-.196-.701-.196-.205 0-.46-.079-.708-.079-.247 0-.666.236-.936.63-.27.394-.97 1.173-.97 2.858 0 1.685 1.002 3.308 1.142 3.556.14.248 1.968 3.018 4.8 4.228 2.834 1.21 2.834.814 3.33 1.05.496.236.936.204 1.306.027.37-.177 1.092-.497 1.248-.73.155-.233.223-.448.33-.63z" />
              </svg>
              Bagikan di WhatsApp
            </a>
          </div>
        </div>
      </div>
      <div id="guru-form-page" class="hidden fade-in p-4 bg-gray-900">
        <header class="mb-4">
          <button onclick="window.backToGuruDashboard()" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali ke Panel Guru
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 id="form-title" class="text-2xl font-bold mb-6 text-yellow-400"></h2>
          <form id="santri-form" class="space-y-6" enctype="multipart/form-data">
            <input type="hidden" id="santri-id">
            <input type="hidden" id="current-photo-url">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="nama" class="block text-sm font-medium text-gray-300">Nama Lengkap Santri</label>
                <input type="text" id="nama" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="kelas" class="block text-sm font-medium text-gray-300">Kelas</label>
                <select id="kelas" class="mt-1 block w-full px-4 py-3 futuristic-panel" required></select>
              </div>
            </div>
            <div>
              <label for="foto" class="block text-sm font-medium text-gray-300">Unggah Foto Santri</label>
              <input type="file" id="foto" name="file" accept="image/*" class="mt-1 block w-full px-4 py-3 futuristic-panel">
              <p id="foto-status" class="text-sm text-gray-400 mt-2"></p>
            </div>
            <div class="pt-4 border-t border-gray-700">
              <h3 class="text-lg font-medium text-gray-100">Data Target Hafalan</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div>
   				 <label for="total-hafalan-juz-guru" class="block text-sm font-medium text-gray-300">Total Hafalan Juz</label>
    			   <input type="number" id="total-hafalan-juz-guru" placeholder="Contoh: 5" class="mt-1 block w-full px-4 py-3 futuristic-panel">
				</div>
              <div>
                <label for="form-target-harian" class="block text-sm font-medium text-gray-300">Target Harian</label>
                <select id="form-target-harian" class="mt-1 block w-full px-4 py-3 futuristic-panel"></select>
              </div>
              <div>
                <label for="form-target-mingguan" class="block text-sm font-medium text-gray-300">Target Mingguan</label>
                <select id="form-target-mingguan" class="mt-1 block w-full px-4 py-3 futuristic-panel"></select>
              </div>
              <div>
                <label for="form-target-bulanan" class="block text-sm font-medium text-gray-300">Target Bulanan</label>
                <input type="text" id="form-target-bulanan" placeholder="Contoh: 1 Juz" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="form-target-tahunan" class="block text-sm font-medium text-gray-300">Target Tahunan</label>
                <input type="text" id="form-target-tahunan" placeholder="Contoh: 5 Juz" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300">Status Pencapaian Target</label>
              <div class="mt-2 flex items-center space-x-4">
                <label class="inline-flex items-center">
                <input type="radio" name="tercapai" value="true" class="form-radio h-4 w-4 text-yellow-400">
                <span class="ml-2 text-gray-300">Mencapai Target</span>
                </label>
                <label class="inline-flex items-center">
                <input type="radio" name="tercapai" value="false" class="form-radio h-4 w-4 text-yellow-400">
                <span class="ml-2 text-gray-300">Belum Mencapai Target</span>
                </label>
              </div>
            </div>
            <div class="flex justify-end pt-2">
              <button type="submit" class="px-6 py-2 bg-yellow-400 text-black rounded-md hover:bg-yellow-500">Simpan Data Santri</button>
            </div>
          </form>
          <div id="hafalan-management-section" class="hidden pt-8 border-t border-gray-700 mt-8">
            <h3 class="text-xl font-bold mb-4 text-yellow-400">Kelola Setoran Hafalan</h3>
            <form id="hafalan-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end futuristic-panel mb-6">
              <div>
                <label for="hafalan-tanggal" class="block text-sm font-medium text-gray-300">Tanggal</label>
                <input type="date" id="hafalan-tanggal" class="mt-1 w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="hafalan-setoran" class="block text-sm font-medium text-gray-300">Setoran</label>
                <input type="text" id="hafalan-setoran" placeholder="Contoh: An-Naba: 1-20" class="mt-1 w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="hafalan-jenis" class="block text-sm font-medium text-gray-300">Jenis</label>
                <select id="hafalan-jenis" class="mt-1 w-full px-4 py-3 futuristic-panel">
                  <option>Hafalan Baru</option>
                  <option>Muroja'ah</option>
                </select>
              </div>
              <div>
                <label for="hafalan-penilaian" class="block text-sm font-medium text-gray-300">Penilaian</label>
                <select id="hafalan-penilaian" class="mt-1 w-full px-4 py-3 futuristic-panel">
                  <option>Lancar</option>
                  <option>Perlu Diulang</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">Tambah</button>
            </form>
            <div class="overflow-x-auto">
              <table class="min-w-full futuristic-panel">
                <thead class="bg-gray-900">
                  <tr>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Tanggal</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Setoran</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Jenis</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Penilaian Guru</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider">Aksi</th>
                  </tr>
                </thead>
                <tbody id="guru-hafalan-table" class="divide-y divide-gray-700"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div id="guru-management-page" class="hidden fade-in p-4 bg-gray-900">
        <header class="mb-4">
          <button onclick="window.backToGuruDashboard()" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali ke Panel Guru
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 class="text-2xl font-bold mb-6 text-yellow-400">Kelola Data Guru</h2>
          <form id="guru-form" class="space-y-4 futuristic-panel mb-8">
            <input type="hidden" id="guru-id">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
              <div>
                <label for="guru-nama" class="block text-sm font-medium text-gray-300">Nama Guru (Ustadz/Ustadzah)</label>
                <input type="text" id="guru-nama" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="guru-kelas" class="block text-sm font-medium text-gray-300">Mengajar Kelas</label>
                <select id="guru-kelas" class="mt-1 block w-full px-4 py-3 futuristic-panel" required></select>
              </div>
              <button type="submit" class="px-6 py-2 bg-yellow-400 text-black rounded-md hover:bg-yellow-500 w-full">Simpan Guru</button>
            </div>
          </form>
          <h3 class="text-xl font-bold mb-4 text-yellow-400">Daftar Guru Terdaftar</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full futuristic-panel">
              <thead class="bg-gray-900">
                <tr>
                  <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase">Nama Guru</th>
                  <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase">Mengajar Kelas</th>
                  <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase">Aksi</th>
                </tr>
              </thead>
              <tbody id="guru-list-table" class="divide-y divide-gray-700">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="about-page" class="hidden fade-in p-4 bg-gray-900">
        <header class="mb-4">
          <button onclick="window.showPage('roleSelection')" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6">Tentang Aplikasi Monitoring Hafalan</h2>
          <div class="space-y-6 text-gray-300 leading-relaxed">
            <section>
              <h3 class="text-xl font-semibold text-yellow-400 mb-2">Latar Belakang Pembuatan</h3>
              <p>
                Dalam dunia pendidikan Islam, khususnya di pondok pesantren tahfidz, proses memonitor perkembangan hafalan Al-Qur'an setiap santri adalah sebuah tugas yang krusial namun seringkali menantang. Guru (Ustadz/Ustadzah) harus mencatat setiap setoran, mengidentifikasi kelemahan, dan melaporkannya kepada wali santri. Di sisi lain, wali santri seringkali merasa kesulitan untuk mendapatkan informasi yang real-time dan terstruktur mengenai progres anak-anak mereka. Proses yang masih manual menggunakan buku atau catatan terpisah rentan terhadap kesalahan, kehilangan data, dan memakan waktu. Aplikasi ini lahir dari kebutuhan untuk menjembatani kesenjangan komunikasi tersebut dan mendigitalisasi proses monitoring agar lebih efisien, transparan, dan akurat.
              </p>
            </section>
            <section>
              <h3 class="text-xl font-semibold text-yellow-400 mb-2">Tujuan Utama Aplikasi</h3>
              <p>
                Tujuan utama kami mengembangkan platform ini adalah untuk menciptakan sebuah ekosistem digital yang terintegrasi bagi pondok pesantren, yang berfokus pada tiga pilar utama:
              </p>
              <ul class="list-disc list-inside pl-4 mt-2 space-y-1">
                <li><strong>Memudahkan Guru:</strong> Menyediakan alat yang praktis bagi para guru untuk mencatat, mengelola, dan menganalisis data hafalan santri dengan cepat dan mudah, sehingga mereka dapat lebih fokus pada proses pengajaran.</li>
                <li><strong>Memberikan Ketenangan bagi Wali Santri:</strong> Memberikan akses langsung kepada wali santri untuk memantau pencapaian, riwayat setoran, dan target hafalan anak mereka kapan saja dan di mana saja.</li>
                <li><strong>Meningkatkan Motivasi Santri:</strong> Dengan adanya target yang jelas dan progres yang dapat dilihat secara visual, kami berharap para santri akan lebih termotivasi untuk mencapai target hafalan mereka.</li>
              </ul>
            </section>
            <section>
              <p class="text-center italic text-gray-400 pt-4 border-t border-gray-700 mt-8">
                Kami percaya bahwa teknologi dapat menjadi alat yang ampuh untuk mendukung pendidikan Al-Qur'an. Semoga aplikasi ini dapat memberikan manfaat yang luas dan menjadi bagian dari ladang amal jariyah kita semua. Aamiin.
              </p>
            </section>
          </div>
        </div>
      </div>
    </div>
    <audio id="azan-alarm" src="https://archive.org/download/AzanMakkah/Azan%20Makkah.mp3" preload="auto"></audio>
    <div id="alarm-notification" class="hidden fixed bottom-5 right-5 bg-yellow-400 text-black p-4 rounded-lg shadow-2xl z-50 transform transition-all duration-300">
      <div class="flex items-start">
        <div class="mr-3">
          <p class="font-bold text-lg" id="alarm-text"></p>
          <p class="text-sm">Waktunya menunaikan salat.</p>
        </div>
        <button onclick="window.dismissAlarm()" class="text-gray-800 hover:text-black">&times;</button>
      </div>
    </div>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>
    <audio id="success-ding" src="https://actions.google.com/sounds/v1/foley/ding_a_ling.ogg" preload="auto"></audio>
	  
    <script type="module">
        const pages = {
            roleSelection: document.getElementById('role-selection-page'),
            pondokRegister: document.getElementById('pondok-register-page'),
            pondokLogin: document.getElementById('pondok-login-page'),
            accessCode: document.getElementById('access-code-page'),
            waliDashboard: document.getElementById('wali-dashboard-page'),
            detailSantri: document.getElementById('detail-santri-page'),
            guruDashboard: document.getElementById('guru-dashboard-page'),
            guruForm: document.getElementById('guru-form-page'),
            guruManagement: document.getElementById('guru-management-page'),
            jadwalDonasi: document.getElementById('jadwal-donasi-page'),
            about: document.getElementById('about-page'),
        };

        let appDataCache = {};
        let loginContext = null;
        let alarmInterval = null;
        let prayerTimesToday = {};
        let resizeTimeout;

        // --- Semua Fungsi-Fungsi Aplikasi Anda ---
        /**
         * Fungsi untuk menggambar grafik progres hafalan santri menggunakan D3.js.
         * Grafik ini menampilkan perkembangan kumulatif hafalan dari waktu ke waktu.
         * @param {Array<Object>} data - Array objek hafalan, setiap objek harus memiliki `tanggal` dan `penilaian`.
         */
        window.renderFutureChart = function(data) {
            console.log("Mencoba menggambar grafik dengan data:", data);
            
            d3.select("#hafalan-future-chart svg").remove();
            const container = d3.select("#hafalan-future-chart");
            if (!container.node()) {
                console.error("Elemen container untuk grafik tidak ditemukan.");
                return;
            }
            
            const width = container.node().getBoundingClientRect().width;
            const height = 300;
            const margin = { top: 20, right: 30, bottom: 40, left: 40 };

            const svg = container.append("svg")
                .attr("width", width)
                .attr("height", height)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Memfilter data yang valid dan mengurutkannya
            const validData = data.filter(d => d && d.tanggal && d.penilaian && !isNaN(d.tanggal.getTime()));
            if (validData.length < 2) { // Minimal 2 titik data untuk menggambar garis
                d3.select("#hafalan-future-chart svg").append("text")
                    .attr("x", width / 2)
                    .attr("y", height / 2)
                    .attr("text-anchor", "middle")
                    .attr("fill", "#ccc")
                    .text(validData.length === 0 ? "Tidak ada data setoran untuk menampilkan grafik." : "Tambahkan lebih dari satu setoran untuk melihat grafik.");
                console.log("Data tidak valid atau kurang dari 2. Gagal menggambar grafik.");
                return;
            }
            
            validData.sort((a, b) => a.tanggal - b.tanggal);

            // Menghitung skor kumulatif
            let cumulativeScore = 0;
            const cumulativeData = validData.map(d => {
                const score = d.penilaian === 'Lancar' ? 2 : 1; 
                cumulativeScore += score;
                return { tanggal: d.tanggal, nilai: cumulativeScore, penilaian: d.penilaian };
            });
            console.log("Data kumulatif untuk grafik:", cumulativeData);

            // Membuat skala untuk sumbu X dan Y
            const x = d3.scaleTime()
                .domain(d3.extent(cumulativeData, d => d.tanggal))
                .range([0, width - margin.left - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(cumulativeData, d => d.nilai) + 5])
                .nice()
                .range([height - margin.top - margin.bottom, 0]);

            // Membuat path area di bawah garis
            const area = d3.area()
                .x(d => x(d.tanggal))
                .y0(y(0))
                .y1(d => y(d.nilai));

            // Membuat path garis
            const line = d3.line()
                .x(d => x(d.tanggal))
                .y(d => y(d.nilai));

            // Menambahkan gradient ke area
            const gradient = d3.select("#hafalan-future-chart svg").append("defs").append("linearGradient")
                .attr("id", "area-gradient")
                .attr("x1", "0%").attr("x2", "0%")
                .attr("y1", "0%").attr("y2", "100%");
            gradient.append("stop").attr("offset", "0%").attr("stop-color", "#FFD700").attr("stop-opacity", 0.5);
            gradient.append("stop").attr("offset", "100%").attr("stop-color", "#FFD700").attr("stop-opacity", 0);

            // Menggambar area dan garis
            svg.append("path")
                .datum(cumulativeData)
                .attr("fill", "url(#area-gradient)")
                .attr("stroke", "#FFD700")
                .attr("stroke-width", 2)
                .attr("d", line);

            // Menambahkan sumbu X
            svg.append("g")
                .attr("transform", `translate(0,${height - margin.top - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(d3.timeWeek.every(1)).tickFormat(d3.timeFormat("%b %d")))
                .attr("color", "#ccc");

            // Menambahkan sumbu Y
            svg.append("g")
                .call(d3.axisLeft(y))
                .attr("color", "#ccc");
                
            // Menambahkan tooltip untuk interaksi
            const tooltip = d3.select("body").append("div")
                .attr("class", "tooltip")
                .style("position", "absolute")
                .style("background-color", "#333")
                .style("border-radius", "5px")
                .style("padding", "8px")
                .style("color", "#fff")
                .style("pointer-events", "none")
                .style("opacity", 0);

            svg.selectAll("circle")
                .data(cumulativeData)
                .enter()
                .append("circle")
                .attr("cx", d => x(d.tanggal))
                .attr("cy", d => y(d.nilai))
                .attr("r", 5)
                .attr("fill", d => d.penilaian === 'Lancar' ? 'green' : 'red')
                .attr("stroke", "#1a1a1a")
                .attr("stroke-width", 2)
                .on("mouseover", (event, d) => {
                    tooltip.style("opacity", 1)
                        .html(`<strong>Tanggal:</strong> ${d.tanggal.toLocaleDateString('id-ID')}<br><strong>Penilaian:</strong> ${d.penilaian}<br><strong>Skor Kumulatif:</strong> ${d.nilai}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 20) + "px");
                })
                .on("mouseout", () => {
                    tooltip.style("opacity", 0);
                });
        }
        
        /**
         * Fungsi untuk menyesuaikan ukuran grafik saat jendela browser diubah ukurannya.
         * Menggunakan debounce untuk mencegah panggilan berlebihan saat mengubah ukuran.
         */
        function resizeChart() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const currentPage = Object.keys(pages).find(key => !pages[key].classList.contains('hidden'));
                if (currentPage === 'detailSantri' && appDataCache.hafalan) {
                    const santriId = sessionStorage.getItem('currentSantriId');
                    if (santriId) {
                        const hafalan = appDataCache.hafalan.filter(h => h.santri_id === parseInt(santriId));
                        const chartData = hafalan.map(h => {
                            const score = h.penilaian === 'Lancar' ? 2 : 1;
                            return { tanggal: new Date(h.tanggal), nilai: score, penilaian: h.penilaian };
                        });
                        window.renderFutureChart(chartData);
                    }
                }
            }, 250); // Debounce time
        }
        window.addEventListener('resize', resizeChart);


        window.showPage = function(pageName) {
            Object.values(pages).forEach(page => {
                if (page) {
                    page.classList.add('hidden');
                    page.classList.remove('flex');
                }
            });
            if (pages[pageName]) {
                pages[pageName].classList.remove('hidden');
                pages[pageName].classList.add('flex');
            }
        }
        window.showHomePage = function() {
            showPage('roleSelection');
        }

        window.checkLoginState = function() {
            const role = sessionStorage.getItem('role');
            const pondokDbId = sessionStorage.getItem('currentPondokId');
            if (role && pondokDbId) {
                if (role === 'guru') {
                    renderGuruDashboard();
                    showPage('guruDashboard');
                } else if (role === 'wali') {
                    renderWaliDashboard();
                    showPage('waliDashboard');
                }
            } else {
                showPage('roleSelection');
            }
        }

        window.goBackFromJadwal = function() {
            const role = sessionStorage.getItem('role');
            if (role === 'guru') {
                backToGuruDashboard();
            } else if (role === 'wali') {
                backToWaliDashboard();
            } else {
                showPage('roleSelection');
            }
        }

        window.backToWaliDashboard = function() {
            renderWaliDashboard();
            showPage('waliDashboard');
        }

        window.backToGuruDashboard = function() {
            renderGuruDashboard();
            showPage('guruDashboard');
        }

        window.showToast = function(type, message) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `p-4 mb-3 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0`;
            
            let bgColor = '';
            if (type === 'success') {
                bgColor = 'bg-green-500';
            } else if (type === 'error') {
                bgColor = 'bg-red-500';
            } else if (type === 'info') {
                bgColor = 'bg-blue-500';
            } else if (type === 'notification') {
                bgColor = 'bg-yellow-400';
            }
            
            toast.classList.add(bgColor);
            toast.innerHTML = `<div class="flex items-center"><div class="flex-shrink-0"><i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-2"></i></div><div><p class="font-bold">${message}</p></div></div>`;
            toastContainer.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
                toast.classList.add('translate-x-0', 'opacity-100');
            }, 100);

            setTimeout(() => {
                toast.classList.remove('translate-x-0', 'opacity-100');
                toast.classList.add('translate-x-full', 'opacity-0');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        }

        window.copyAccessCode = function() {
            const codeEl = document.getElementById('unique-access-code');
            const range = document.createRange();
            range.selectNode(codeEl);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('success', "Kode akses berhasil disalin!");
                }
            } catch (err) {
                console.error('Failed to copy text:', err);
                showToast('error', "Gagal menyalin kode. Silakan salin manual: " + codeEl.textContent);
            }
            window.getSelection().removeAllRanges();
        }

        window.copyDonationNumber = function() {
            const numberEl = document.getElementById('donation-number');
            const range = document.createRange();
            range.selectNode(numberEl);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast('success', 'Nomor telepon berhasil disalin!');
                }
            } catch (err) {
                console.error('Failed to copy text:', err);
                showToast('error', "Gagal menyalin nomor. Silakan salin manual: " + numberEl.textContent);
            }
            window.getSelection().removeAllRanges();
        }

        window.fetchData = async function() {
            const pondokDbId = sessionStorage.getItem('currentPondokId');
            if (!pondokDbId) return null;
            if (appDataCache[pondokDbId]) {
                return appDataCache[pondokDbId];
            }
            try {
                const response = await fetch('/api/get-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pondokDbId: pondokDbId })
                });
                const result = await response.json();
                if (result.success) {
                    appDataCache[pondokDbId] = result.data;
                    return appDataCache[pondokDbId];
                } else {
                    console.error("Gagal mengambil data dari server:", result.message);
                    return null;
                }
            } catch (error) {
                console.error("Gagal mengirim data ke server:", error);
                return null;
            }
        }

        window.saveData = async function(endpoint, payload) {
            const currentPondokId = sessionStorage.getItem('currentPondokId');
            if (!currentPondokId) {
                showToast('error', "Sesi login berakhir. Silakan login kembali.");
                logout();
                return false;
            }
            try {
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.success) {
                    appDataCache = {};
                    // Play a success sound for the guru when data is saved
                    const successDing = document.getElementById('success-ding');
                    if (successDing) {
                        successDing.play().catch(e => console.error("Error playing success sound:", e));
                    }
                    return true;
                } else {
                    console.error("Gagal menyimpan data:", result.message);
                    showToast('error', "Gagal menyimpan data: " + result.message);
                    return false;
                }
            } catch (error) {
                console.error("Gagal mengirim data ke server:", error);
                showToast('error', "Error koneksi ke server.");
                return false;
            }
        }

        window.uploadFile = async function(file) {
            const formData = new FormData();
            formData.append('file', file);
            try {
                const response = await fetch('/unggah', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    return result.file_url;
                } else {
                    showToast('error', 'Gagal mengunggah foto: ' + result.message);
                    return null;
                }
            } catch (error) {
                showToast('error', 'Error koneksi saat mengunggah foto.');
                return null;
            }
        }
        
        window.requestNotificationPermission = function() {
            if (!("Notification" in window)) {
                console.log("Browser ini tidak mendukung notifikasi desktop");
            } else if (Notification.permission === "granted") {
                console.log("Izin notifikasi sudah diberikan.");
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(function (permission) {
                    if (permission === "granted") {
                        showToast('info', "Notifikasi diaktifkan!");
                    }
                });
            }
        }

        window.sendNotification = function(title, body) {
            if (Notification.permission === "granted") {
                const options = {
                    body: body,
                    icon: 'https://placehold.co/64x64/2a9d8f/ffffff?text=SQ'
                };
                const notification = new Notification(title, options);
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus();
                }
            } else {
                console.log("Izin notifikasi tidak diberikan.");
            }
        }

        window.sendNotificationToGuardian = function(santriName, setoran, penilaian) {
            sendNotification("Update Hafalan Santri", `${santriName} telah selesai menyetorkan hafalannya. Setoran: ${setoran}. Penilaian: ${penilaian}.`);
        }

        window.handleRoleSelection = function(role) {
            loginContext = role;
            if (role === 'wali') {
                showPage('accessCode');
            } else if (role === 'guru') {
                showPage('pondokLogin');
            }
        }

        window.logout = function() {
            sessionStorage.clear();
            loginContext = null;
            const accessCodeInput = document.getElementById('access-code');
            if (accessCodeInput) {
                accessCodeInput.value = '';
            }
            const pondokLoginForm = document.getElementById('pondok-login-form');
            if (pondokLoginForm) {
                pondokLoginForm.reset();
            }
            showPage('roleSelection');
        }

        window.renderWaliDashboard = async function() {
            const pondokData = await fetchData();
            if (!pondokData || !pondokData.santri) return;
            const kelasListContainer = document.getElementById('kelas-list-container');
            const santriListContainer = document.getElementById('santri-list-container');
            if (kelasListContainer) kelasListContainer.classList.remove('hidden');
            if (santriListContainer) santriListContainer.classList.add('hidden');
            const kelasGrid = document.getElementById('kelas-grid');
            if (!kelasGrid) return;
            kelasGrid.innerHTML = '';
            
            const uniqueKelas = [...new Set(pondokData.santri.map(s => s.kelas))].sort();
            uniqueKelas.forEach(kelas => {
                const card = document.createElement('div');
                card.className = 'text-center cursor-pointer p-6 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 futuristic-panel';
                card.innerHTML = `<div class="flex items-center justify-center mb-4 text-4xl text-yellow-400"><i class="fas fa-mosque"></i></div><h3 class="text-xl font-bold text-yellow-400">Kelas ${kelas}</h3><p class="text-sm text-gray-400 mt-2">Lihat daftar santri</p>`;
                card.onclick = () => window.showSantriListByKelas(kelas);
                kelasGrid.appendChild(card);
            });
        }
                
        window.showSantriDetail = async function(santriId) {
            const pondokData = await fetchData();
            if (!pondokData || !pondokData.santri) {
                console.error("Gagal memuat data pondok.");
                showPage('waliDashboard');
                showToast('error', "Gagal memuat detail santri. Silakan coba lagi.");
                return;
            }
            
            const santri = pondokData.santri.find(s => s.id === santriId);
            if (!santri) {
                console.error("Santri tidak ditemukan di data.");
                showPage('waliDashboard');
                showToast('error', "Santri tidak ditemukan.");
                return;
            }
            
            sessionStorage.setItem('currentWaliKelas', santri.kelas);
            sessionStorage.setItem('currentSantriId', santriId);
            
            const guru = pondokData.guru.find(g => g.mengajar_kelas === santri.kelas);
            const hafalan = pondokData.hafalan
                .filter(h => h.santri_id === santriId)
                .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
            
            document.getElementById('detail-foto').src = santri.foto || 'https://placehold.co/400x400?text=No+Photo';
            document.getElementById('detail-nama').textContent = santri.nama;
            document.getElementById('detail-kelas').textContent = `Kelas ${santri.kelas}`;
            document.getElementById('detail-pengajar').textContent = guru ? `Pengajar: ${guru.nama}` : 'Pengajar belum diatur';
            
            const statusEl = document.getElementById('detail-status-target');
            if (santri.tercapai) {
                statusEl.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800';
                statusEl.innerHTML = `✅ Mencapai Target`;
            } else {
                statusEl.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800';
                statusEl.innerHTML = `⚠️ Belum Mencapai Target`;
            }
            
            const target = santri.target || {};
            document.getElementById('total-hafalan-juz').textContent = santri.total_hafalan_juz || '-';
            document.getElementById('target-harian').textContent = target.harian || '-';
            document.getElementById('target-mingguan').textContent = target.mingguan || '-';
            document.getElementById('target-bulanan').textContent = target.bulanan || '-';
            document.getElementById('target-tahunan').textContent = target.tahunan || '-';
            
            // Perbaikan utama untuk grafik: menggunakan penilaian untuk nilai
            const chartData = hafalan.map(h => {
                const score = h.penilaian === 'Lancar' ? 2 : 1;
                let dateObject = new Date(h.tanggal);
                if (isNaN(dateObject.getTime())) {
                    // Coba parsing manual untuk format "dd/mm/yyyy"
                    const parts = h.tanggal.split('/');
                    if (parts.length === 3) {
                        dateObject = new Date(`${parts[2]}-${parts[1]}-${parts[0]}`);
                    }
                }
                return {
                    tanggal: dateObject,
                    nilai: score,
                    penilaian: h.penilaian // Menambahkan penilaian untuk tooltip
                };
            }).filter(d => !isNaN(d.tanggal.getTime())); // Filter data dengan tanggal yang tidak valid
            
            renderFutureChart(chartData);
            
            const historyBody = document.getElementById('hafalan-history');
            if (historyBody) {
                historyBody.innerHTML = '';
                if (hafalan.length > 0) {
                    hafalan.forEach(h => {
                        const row = historyBody.insertRow();
                        row.innerHTML = `<td class="py-4 px-6 text-sm text-gray-200">${new Date(h.tanggal).toLocaleDateString('id-ID')}</td><td class="py-4 px-6 text-sm text-gray-200 font-medium">${h.setoran}</td><td class="py-4 px-6 text-sm text-gray-400">${h.jenis}</td><td class="py-4 px-6 text-sm"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${h.penilaian === 'Lancar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${h.penilaian}</span></td>`;
                    });
                } else {
                    historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-gray-400">Belum ada riwayat setoran.</td></tr>';
                }
            }
            showPage('detailSantri');
        }

        window.renderGuruDashboard = async function() {
            const pondokData = await fetchData();
            if (!pondokData || !pondokData.santri) return;
            const uniqueAccessCodeElement = document.getElementById('unique-access-code');
            if (uniqueAccessCodeElement) {
                uniqueAccessCodeElement.textContent = pondokData.uniqueAccessCode || 'Tidak ada kode';
            }
            const whatsappLinkElement = document.getElementById('whatsapp-link');
            if (whatsappLinkElement) {
                whatsappLinkElement.href = `https://wa.me/?text=${encodeURIComponent('Halo, wali santri! Berikut adalah kode akses unik untuk monitoring hafalan anak Anda: ' + pondokData.uniqueAccessCode)}`;
            }
            const listContainer = document.getElementById('guru-santri-list');
            if (listContainer) {
                listContainer.innerHTML = '';
                pondokData.santri.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(santri => {
                    const fotoUrl = santri.foto || 'https://placehold.co/400x400?text=No+Photo';
                    const card = document.createElement('div');
                    card.className = 'text-center cursor-pointer group santri-card futuristic-panel p-4 rounded-lg shadow-md';
                    card.onclick = () => window.showGuruForm(`${santri.id}`);
                    card.innerHTML = `
                        <div class="relative">
                            <img src="${fotoUrl}" alt="Foto ${santri.nama}" class="w-full h-auto aspect-square rounded-full object-cover transition-transform duration-300 group-hover:scale-105 border-4 border-yellow-400 shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';">
                        </div>
                        <p class="mt-4 font-semibold text-gray-200">${santri.nama}</p>
                        <p class="text-sm text-gray-400">${santri.kelas}</p>
                        <div class="flex space-x-2 mt-4 justify-center">
                            <button onclick="event.stopPropagation(); window.showGuruForm('${santri.id}')" class="px-2 py-1 text-xs font-semibold text-black bg-yellow-400 rounded-md hover:bg-yellow-500">Ubah Data</button>
                            <button onclick="event.stopPropagation(); window.deleteSantri('${santri.id}')" class="px-2 py-1 text-xs font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Hapus</button>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }
        }

        window.showGuruForm = async function(santriIdString) {
            const santriId = santriIdString === 'null' ? null : parseInt(santriIdString);
            const pondokData = await fetchData();
            if (!pondokData || !pondokData.santri) {
                console.error("Data pondok tidak ditemukan atau tidak memiliki properti 'santri'.");
                showToast('error', "Gagal memuat data santri. Silakan coba lagi.");
                return;
            }
            const form = document.getElementById('santri-form');
            if (form) form.reset();
            const hafalanSection = document.getElementById('hafalan-management-section');
            if (hafalanSection) hafalanSection.classList.add('hidden');
            const santriIdInput = document.getElementById('santri-id');
            if (santriIdInput) santriIdInput.value = santriId || '';
            const fotoStatus = document.getElementById('foto-status');

            if (santriId) {
                const santri = pondokData.santri.find(s => s.id === santriId);
                if (!santri) {
                    console.error(`Santri dengan ID ${santriId} tidak ditemukan.`);
                    showToast('error', "Santri tidak ditemukan.");
                    return;
                }
                const formTitle = document.getElementById('form-title');
                if (formTitle) formTitle.textContent = `Ubah Data: ${santri.nama}`;
                const namaInput = document.getElementById('nama');
                if (namaInput) namaInput.value = santri.nama;
                const kelasSelect = document.getElementById('kelas');
                if (kelasSelect) kelasSelect.value = santri.kelas;
                
                const currentPhotoUrl = document.getElementById('current-photo-url');
                if (currentPhotoUrl) currentPhotoUrl.value = santri.foto || '';
                if (fotoStatus) fotoStatus.textContent = santri.foto ? 'Foto sudah ada, tidak perlu diunggah lagi.' : 'Belum ada foto. Unggah sekarang.';

                const target = santri.target || {};
                const totalHafalanJuzInput = document.getElementById('total-hafalan-juz-guru');
                if (totalHafalanJuzInput) totalHafalanJuzInput.value = santri.total_hafalan_juz || '';
                const formTargetHarian = document.getElementById('form-target-harian');
                if (formTargetHarian) formTargetHarian.value = target.harian || '';
                const formTargetMingguan = document.getElementById('form-target-mingguan');
                if (formTargetMingguan) formTargetMingguan.value = target.mingguan || '';
                const formTargetBulanan = document.getElementById('form-target-bulanan');
                if (formTargetBulanan) formTargetBulanan.value = target.bulanan || '-';
                const formTargetTahunan = document.getElementById('form-target-tahunan');
                if (formTargetTahunan) formTargetTahunan.value = target.tahunan || '-';
                const checkedRadio = document.querySelector(`input[name="tercapai"]:checked`);
                if (checkedRadio) {
                    checkedRadio.checked = santri.tercapai;
                }
                document.querySelector(`input[name="tercapai"][value="${santri.tercapai}"]`).checked = true;

                if (hafalanSection) hafalanSection.classList.remove('hidden');
                window.renderGuruHafalanTable(santriId);
            } else {
                const formTitle = document.getElementById('form-title');
                if (formTitle) formTitle.textContent = 'Tambah Santri Baru';
                if (fotoStatus) fotoStatus.textContent = 'Unggah foto baru untuk santri ini.';
                const totalHafalanJuzInput = document.getElementById('total-hafalan-juz-guru');
                if (totalHafalanJuzInput) totalHafalanJuzInput.value = '';
            }
            showPage('guruForm');
        }

        window.deleteSantri = async function(santriIdString) {
            const santriId = parseInt(santriIdString);
            if (!confirm('Apakah Anda yakin ingin menghapus data santri ini? Semua data hafalan yang terkait juga akan dihapus.')) {
                return;
            }
            const saveSuccess = await saveData('/api/delete-santri', { santriId });
            if (saveSuccess) {
                showToast('success', 'Data santri berhasil dihapus!');
                window.renderGuruDashboard();
            } else {
                showToast('error', "Gagal menghapus data di server.");
            }
        }

        window.showGuruManagementPage = async function() {
            const guruForm = document.getElementById('guru-form');
            if (guruForm) guruForm.reset();
            const guruIdInput = document.getElementById('guru-id');
            if (guruIdInput) guruIdInput.value = '';
            await window.renderGuruList();
            showPage('guruManagement');
        }

        window.renderGuruList = async function() {
            const pondokData = await fetchData();
            if (!pondokData || !pondokData.guru) return;
            const tableBody = document.getElementById('guru-list-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            pondokData.guru.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(guru => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="py-4 px-6 text-sm font-medium text-gray-100">${guru.nama}</td><td class="py-4 px-6 text-sm text-gray-400">${guru.mengajar_kelas}</td><td class="py-4 px-6 text-sm font-medium space-x-2"><button onclick="window.editGuru('${guru.id}')" class="text-yellow-400 hover:text-yellow-500">Ubah</button><button onclick="window.deleteGuru('${guru.id}')" class="text-red-600 hover:text-red-700">Hapus</button></td>`;
            });
        }

        // Tambahkan kode fungsi-fungsi ini di sini
        window.togglePasswordVisibility = function(inputId, toggleButton) {
            const input = document.getElementById(inputId);
            const eyeIcon = `<i class="fas fa-eye text-gray-500"></i>`;
            const eyeSlashIcon = `<i class="fas fa-eye-slash text-gray-500"></i>`;
            if (input.type === "password") {
                input.type = "text";
                toggleButton.innerHTML = eyeSlashIcon;
            } else {
                input.type = "password";
                toggleButton.innerHTML = eyeIcon;
            }
        }
        window.showAboutPage = function() { showPage('about'); }
        window.playWelcomeAnimation = function() {
            const modal = document.getElementById('welcome-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            const title = document.getElementById('welcome-title');
            const subtitle = document.getElementById('welcome-subtitle');
            const message = document.getElementById('welcome-message');
            setTimeout(() => { title.classList.remove('-translate-y-10', 'opacity-0'); title.classList.add('translate-y-0', 'opacity-100'); }, 100);
            setTimeout(() => { subtitle.classList.remove('translate-y-10', 'opacity-0'); subtitle.classList.add('translate-y-0', 'opacity-100'); }, 600);
            setTimeout(() => { message.classList.remove('translate-y-10', 'opacity-0'); message.classList.add('translate-y-0', 'opacity-100'); }, 1100);
            setTimeout(() => { modal.classList.add('hidden'); showPage('roleSelection'); }, 3000);
        }
        window.showJadwalDonasiPage = function() { window.fetchJadwalSholat(); showPage('jadwalDonasi'); }
        window.getCoordinates = function() {
            return new Promise((resolve, reject) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => resolve({ latitude: position.coords.latitude, longitude: position.coords.longitude }),
                        error => reject(error)
                    );
                } else {
                    reject(new Error("Geolocation is not supported by this browser."));
                }
            });
        }
        window.fetchJadwalSholat = async function() {
            const container = document.getElementById('jadwal-sholat-container');
            const lokasiEl = document.getElementById('jadwal-lokasi');
            if (!container || !lokasiEl) return;
            container.innerHTML = `<div class="col-span-full text-center">Memuat...</div>`;
            let latitude = -6.2088;
            let longitude = 106.8456;
            let locationName = "Jakarta, Indonesia";
            try {
                const coords = await window.getCoordinates();
                latitude = coords.latitude;
                longitude = coords.longitude;
                const geoNameResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=id`);
                if (geoNameResponse.ok) {
                    const geoNameData = await geoNameResponse.json();
                    locationName = `${geoNameData.city || geoNameData.locality}, ${geoNameData.countryName}`;
                } else {
                    locationName = "Lokasi Anda Saat Ini";
                }
            } catch (error) {
                container.innerHTML = `<div class="col-span-full text-center text-red-500">Gagal memuat jadwal solat. Pastikan anda mempunyai sambungan internet.</div>`;
                console.error("Error fetching prayer times:", error);
            }
        }
        window.handleAlarmToggleChange = function() {
            const isChecked = document.getElementById('alarm-toggle').checked;
            localStorage.setItem('alarmEnabled', isChecked);
            if (isChecked) {
                const audio = document.getElementById('azan-alarm');
                audio.play().then(() => audio.pause()).catch(e => console.log("User interaction needed to play audio."));
                window.setupPrayerAlarm();
                window.showToast('info', 'Alarm Azan diaktifkan. Notifikasi akan muncul saat waktu salat tiba.');
            } else {
                if (alarmInterval) clearInterval(alarmInterval);
                window.showToast('info', 'Alarm Azan dinonaktifkan.');
            }
        }
        window.setupPrayerAlarm = function() {
            if (alarmInterval) clearInterval(alarmInterval);
            const alarmEnabled = localStorage.getItem('alarmEnabled') === 'true';
            if (!alarmEnabled) return;
            alarmInterval = setInterval(window.checkPrayerTimes, 30000);
        }
        window.checkPrayerTimes = function() {
            const now = new Date();
            const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
            for (const [prayer, time] of Object.entries(prayerTimesToday)) {
                if (time === currentTime) {
                    const prayerName = { Fajr: "Subuh", Dhuhr: "Zuhur", Asr: "Asar", Maghrib: "Magrib", Isha: "Isya" }[prayer];
                    window.playAlarm(prayerName);
                }
            }
        }
        window.playAlarm = function(prayerName) {
            const audio = document.getElementById('azan-alarm');
            audio.pause();
            audio.currentTime = 0;
            const notification = document.getElementById('alarm-notification');
            notification.classList.add('hidden');
        }
        window.dismissAlarm = function() {
            const audio = document.getElementById('azan-alarm');
            audio.pause();
            audio.currentTime = 0;
            const notification = document.getElementById('alarm-notification');
            notification.classList.add('hidden');
        }
        window.showSantriListByKelas = function(kelas) {
            // 1. Ambil data dengan kunci yang sudah diubah ke angka
            const pondokId = sessionStorage.getItem('currentPondokId');
            const pondokData = appDataCache[pondokId];
            if (!pondokData) {
                // Jika data tidak ada, kembali ke halaman utama
                window.showPage('waliDashboard');
                return;
            }
            
            //  Tangani navigasi antar halaman utama
            //    showPage akan menyembunyikan halaman detail dan menampilkan dashboard wali
            window.showPage('waliDashboard');
            //  Tangani navigasi antar sub-halaman
            //    Ini yang membedakan tampilan kelas dan tampilan daftar santri
            const kelasListContainer = document.getElementById('kelas-list-container');
            const santriListContainer = document.getElementById('santri-list-container');
            if (kelasListContainer) kelasListContainer.classList.add('hidden');
            if (santriListContainer) santriListContainer.classList.remove('hidden');
            const filteredSantri = pondokData.santri.filter(s => s.kelas === kelas).sort((a, b) => a.nama.localeCompare(b.nama));
            const currentClassTitle = document.getElementById('current-class-title');
            const santriGallery = document.getElementById('santri-gallery');
            if (currentClassTitle) {
            currentClassTitle.textContent = `Daftar Santri Kelas ${kelas}`;
            }

            sessionStorage.setItem('currentWaliKelas', kelas);
            if (santriGallery) {
                santriGallery.innerHTML = '';
                if (filteredSantri.length === 0) {
                    santriGallery.innerHTML = '<p class="text-center text-gray-500 py-10">Tidak ada santri di kelas ini.</p>';
                } else {
                    filteredSantri.forEach(santri => {
                        const fotoUrl = santri.foto || 'https://placehold.co/400x400?text=No+Photo';
                        const card = document.createElement('div');
                        card.className = 'text-center cursor-pointer group santri-card';
                        card.dataset.name = santri.nama;
                        card.innerHTML = `<div class="relative"><img src="${fotoUrl}" alt="Foto ${santri.nama}" class="w-full h-auto aspect-square rounded-full object-cover transition-transform duration-300 group-hover:scale-105 border-4 border-yellow-400 shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';"><div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-full transition-all duration-300 flex items-center justify-center"><span class="text-white opacity-0 group-hover:opacity-100 font-bold">Lihat Detail</span></div></div><p class="mt-4 font-semibold text-gray-200">${santri.nama}</p><p class="text-sm text-gray-400">Kelas ${santri.kelas}</p>`;
                        card.onclick = () => window.showSantriDetail(santri.id);
                        santriGallery.appendChild(card);
                    });
                }
            }
        }
        window.editGuru = async function(guruIdString) {
            const guruId = parseInt(guruIdString);
            const pondokData = await window.fetchData();
            if (!pondokData || !pondokData.guru) return;
            const guru = pondokData.guru.find(g => g.id === guruId);
            if (guru) {
                document.getElementById('guru-id').value = guru.id;
                document.getElementById('guru-nama').value = guru.nama;
                document.getElementById('guru-kelas').value = guru.mengajar_kelas;
                window.scrollTo(0, 0);
            }
        }

        window.deleteGuru = async function(guruIdString) {
            const guruId = parseInt(guruIdString);
            if (!confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
                return;
            }
            const pondokId = sessionStorage.getItem('currentPondokId');
            const saveSuccess = await window.saveData('/api/delete-guru', { pondokId, guruId });
            if (saveSuccess) {
                window.showToast('success', 'Data guru berhasil dihapus!');
                window.renderGuruList();
            } else {
                window.showToast('error', "Gagal menghapus data guru.");
            }
        }

        window.renderGuruHafalanTable = async function(santriId) {
            const pondokData = await window.fetchData();
            if (!pondokData || !pondokData.hafalan) return;
            const tableBody = document.getElementById('guru-hafalan-table');
            if (!tableBody) return;
            tableBody.innerHTML = '';
            const hafalanList = pondokData.hafalan.filter(h => h.santri_id === santriId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
            if (hafalanList.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Belum ada setoran.</td></tr>';
                return;
            }
            hafalanList.forEach(h => {
                const row = tableBody.insertRow();
                row.innerHTML = `<td class="py-2 px-4">${h.tanggal}</td><td class="py-2 px-4 font-medium">${h.setoran}</td><td class="py-2 px-4">${h.jenis}</td><td class="py-2 px-4">${h.penilaian}</td><td class="py-2 px-4"><button onclick="window.deleteHafalan('${h.id}', '${santriId}')" class="text-red-500 hover:text-red-700">Hapus</button></td>`;
            });
        }
        window.deleteHafalan = async function(hafalanIdString, santriIdString) {
            const hafalanId = parseInt(hafalanIdString);
            const santriId = parseInt(santriIdString);
            if (!confirm('Apakah Anda yakin ingin menghapus setoran hafalan ini?')) {
                return;
            }
            const pondokId = sessionStorage.getItem('currentPondokId');
            const saveSuccess = await window.saveData('/api/delete-hafalan', { pondokId, hafalanId });
            if (saveSuccess) {
                window.showToast('success', 'Setoran hafalan berhasil dihapus!');
                window.renderGuruHafalanTable(santriId);
            } else {
                window.showToast('error', "Gagal menghapus setoran hafalan.");
            }
        }
        
        window.updateTotalHafalan = async function() {
            // Ambil ID santri dari input tersembunyi
            const santriId = document.getElementById('santri-id').value;
            
            // Ambil nilai total hafalan juz dari input
            const totalHafalanJuzInput = document.getElementById('total-hafalan-juz-guru').value;

            console.log("ID Santri saat ini:", santriId);
            console.log("Total Hafalan Juz:", totalHafalanJuzInput);

            // Periksa apakah ID santri dan nilai total hafalan juz ada
            if (!santriId || totalHafalanJuzInput === "") {
                console.error("ID Santri atau total hafalan juz tidak ditemukan.");
                window.showToast('error', "ID Santri atau total hafalan juz tidak ditemukan.");
                return;
            }
            
            // Pastikan nilai yang dimasukkan adalah angka
            const totalHafalanJuz = parseInt(totalHafalanJuzInput);
            if (isNaN(totalHafalanJuz)) {
                console.error("Total Hafalan Juz harus berupa angka.");
                window.showToast('error', "Total Hafalan Juz harus berupa angka.");
                return;
            }
            
            const santri = (await window.fetchData()).santri.find(s => s.id === santriId);
            if (!santri) {
                window.showToast('error', "Santri tidak ditemukan.");
                return;
            }

            const santriData = {
                ...santri,
                total_hafalan_juz: totalHafalanJuz,
                target: { ...santri.target }
            };

            const saveSuccess = await window.saveData('/api/save-santri', { pondokId: sessionStorage.getItem('currentPondokId'), santriData: santriData });
            if (saveSuccess) {
                console.log("Total hafalan berhasil diperbarui!");
                window.showToast('success', "Total hafalan berhasil diperbarui!");
                // Perbarui cache data setelah perubahan
                await window.fetchData();
            } else {
                console.error("Gagal memperbarui total hafalan.");
                window.showToast('error', "Gagal memperbarui total hafalan.");
            }
        }


        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {

            const alarmToggle = document.getElementById('alarm-toggle');
            if (alarmToggle) {
                alarmToggle.checked = localStorage.getItem('alarmEnabled') === 'true';
                alarmToggle.addEventListener('change', window.handleAlarmToggleChange);
            }
            
            const genderedKelas = [];
            for (let i = 65; i <= 90; i++) {
                const letter = String.fromCharCode(i);
                genderedKelas.push(`Kelas ${letter} putra`, `Kelas ${letter} putri`);
            }
            
            const kelasSelectSantri = document.getElementById('kelas');
            if (kelasSelectSantri) {
                kelasSelectSantri.innerHTML = '';
                genderedKelas.forEach(kelas => {
                    kelasSelectSantri.add(new Option(kelas, kelas));
                });
            }
            const kelasSelectGuru = document.getElementById('guru-kelas');
            if (kelasSelectGuru) {
                kelasSelectGuru.innerHTML = '';
                genderedKelas.forEach(kelas => {
                    kelasSelectGuru.add(new Option(kelas, kelas));
                });
            }

            const targetHarianSelect = document.getElementById('form-target-harian');
            if (targetHarianSelect) {
                targetHarianSelect.innerHTML = '';
                for (let i = 1; i <= 20; i++) {
                    targetHarianSelect.add(new Option(`${i} Halaman`, `${i} Halaman`));
                }
            }
            const targetMingguanSelect = document.getElementById('form-target-mingguan');
            if (targetMingguanSelect) {
                targetMingguanSelect.innerHTML = '';
                for (let i = 1; i <= 20; i++) {
                    targetMingguanSelect.add(new Option(`${i} Halaman`, `${i} Halaman`));
                }
            }

            // --- Semua Event Listener ---
            const pondokRegisterForm = document.getElementById('pondok-register-form');
            if (pondokRegisterForm) {
                pondokRegisterForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const pondokId = document.getElementById('register-pondok-id').value.trim();
                    const password = document.getElementById('register-password').value;
                    const errorEl = document.getElementById('register-error');
                    if (!pondokId.includes('#') || password.length < 6) {
                        errorEl.textContent = "Format Nama Pondok salah atau kata sandi terlalu pendek.";
                        errorEl.classList.remove('hidden');
                        return;
                    }
                    const pondokName = pondokId.split('#')[0].trim();
                    try {
                        const response = await fetch('/api/register', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pondokId, password, pondokName })
                        });
                        const result = await response.json();
                        if (result.success) {
                            window.showToast('success', `Pendaftaran berhasil! Kode Akses Unik Anda: ${result.accessCode}. Salin kode ini dan berikan kepada wali santri.`);
                            window.showPage('pondokLogin');
                        } else {
                            errorEl.textContent = result.message;
                            errorEl.classList.remove('hidden');
                        }
                    } catch (error) {
                        errorEl.textContent = "Terjadi kesalahan saat mendaftar.";
                        errorEl.classList.remove('hidden');
                    }
                });
            }

            const pondokLoginForm = document.getElementById('pondok-login-form');
            if (pondokLoginForm) {
                pondokLoginForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const pondokId = document.getElementById('login-pondok-id').value.trim();
                    const password = document.getElementById('login-password').value;
                    const errorEl = document.getElementById('pondok-login-error');
                    try {
                        const response = await fetch('/api/login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ pondokId, password })
                        });
                        const result = await response.json();
                        if (result.success) {
                            sessionStorage.setItem('currentPondokId', result.pondokDbId);
                            sessionStorage.setItem('pondokName', result.pondokName);
                            sessionStorage.setItem('role', 'guru');
                            window.checkLoginState();
                        } else {
                            errorEl.textContent = result.message;
                            errorEl.classList.remove('hidden');
                        }
                    } catch (error) {
                        errorEl.textContent = "Terjadi kesalahan saat login.";
                        errorEl.classList.remove('hidden');
                    }
                });
            }

            const accessCodeForm = document.getElementById('access-code-form');
            if (accessCodeForm) {
                accessCodeForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const accessCode = document.getElementById('access-code').value.trim();
                    const errorEl = document.getElementById('access-code-error');
                    errorEl.classList.add('hidden');
                    try {
                        const response = await fetch('/api/wali-login', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ accessCode })
                        });
                        const result = await response.json();
                        if (result.success) {
                            sessionStorage.setItem('currentPondokId', result.pondokDbId);
                            sessionStorage.setItem('pondokName', result.pondokName);
                            sessionStorage.setItem('role', 'wali');
                            window.checkLoginState();
                        } else {
                            errorEl.textContent = result.message;
                            errorEl.classList.remove('hidden');
                        }
                    } catch (error) {
                        console.error("Error:", error);
                        errorEl.textContent = "Terjadi kesalahan koneksi. Silakan coba lagi.";
                        errorEl.classList.remove('hidden');
                    }
                });
            }

            const santriForm = document.getElementById('santri-form');
            if (santriForm) {
                santriForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const form = this;
                    const pondokId = sessionStorage.getItem('currentPondokId');
                    const fotoInput = document.getElementById('foto');
                    const currentPhotoUrl = document.getElementById('current-photo-url').value;
                    let fotoUrl = currentPhotoUrl || null;
                    if (fotoInput.files.length > 0) {
                        fotoUrl = await window.uploadFile(fotoInput.files[0]);
                        if (!fotoUrl) return;
                    }
                    const santriId = document.getElementById('santri-id').value ? parseInt(document.getElementById('santri-id').value) : null;
                    const nama = document.getElementById('nama').value;
                    const kelas = document.getElementById('kelas').value;
                    
                    const totalHafalanJuz = document.getElementById('total-hafalan-juz-guru').value;
                    const harian = document.getElementById('form-target-harian').value;
                    const mingguan = document.getElementById('form-target-mingguan').value;
                    const bulanan = document.getElementById('form-target-bulanan').value;
                    const tahunan = document.getElementById('form-target-tahunan').value;
                    const tercapai = document.querySelector('input[name="tercapai"]:checked')?.value === 'true';
                    
                    const santriData = {
                        id: santriId,
                        nama: nama,
                        kelas: kelas,
                        foto: fotoUrl,
                        total_hafalan_juz: totalHafalanJuz,
                        target: { harian, mingguan, bulanan, tahunan, tercapai }
                    };
                    const saveSuccess = await window.saveData('/api/save-santri', { pondokId: pondokId, santriData: santriData });
                    if (saveSuccess) {
                        window.showToast('success', 'Data santri berhasil disimpan!');
                        // Perbarui cache data setelah perubahan
                        await window.fetchData();
                        window.backToGuruDashboard();
                    } else {
                        window.showToast('error', "Gagal menyimpan data di server.");
                    }
                });
            }

            const guruForm = document.getElementById('guru-form');
            if (guruForm) {
                guruForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const pondokId = sessionStorage.getItem('currentPondokId');
                    if (!pondokId) return;
                    const guruId = document.getElementById('guru-id').value ? parseInt(document.getElementById('guru-id').value) : null;
                    const nama = document.getElementById('guru-nama').value;
                    const kelas = document.getElementById('guru-kelas').value;
                    const guruData = { id: guruId, nama, mengajar_kelas: kelas };
                    const saveSuccess = await window.saveData('/api/save-guru', { pondokId, guruData });
                    if (saveSuccess) {
                        window.renderGuruList();
                        this.reset();
                        document.getElementById('guru-id').value = '';
                        window.showToast('success', 'Data guru berhasil disimpan!');
                    } else {
                        window.showToast('error', "Gagal menyimpan data guru.");
                    }
                });
            }
            
            const hafalanForm = document.getElementById('hafalan-form');
            if (hafalanForm) {
                hafalanForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const pondokId = sessionStorage.getItem('currentPondokId');
                    if (!pondokId) return;
                    const santriId = parseInt(document.getElementById('santri-id').value);
                    const newHafalan = {
                        tanggal: document.getElementById('hafalan-tanggal').value,
                        setoran: document.getElementById('hafalan-setoran').value,
                        jenis: document.getElementById('hafalan-jenis').value,
                        penilaian: document.getElementById('hafalan-penilaian').value,
                        santriId: santriId,
                    };
                    const saveSuccess = await window.saveData('/api/save-hafalan', { pondokId, hafalanData: newHafalan });
                    if (saveSuccess) {
                        const santri = (await window.fetchData()).santri.find(s => s.id === santriId);
                        window.sendNotificationToGuardian(santri.nama, newHafalan.setoran, newHafalan.penilaian);
                        window.showToast('success', 'Data hafalan berhasil disimpan!');
                        window.renderGuruHafalanTable(santriId);
                        this.reset();
                    } else {
                        window.showToast('error', "Gagal menambahkan setoran hafalan.");
                    }
                });
            }

            // --- Panggil Fungsi Inisialisasi Aplikasi ---
            window.playWelcomeAnimation();
        });
    </script>
  </body>
</html>
