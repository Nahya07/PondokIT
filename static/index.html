<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitoring Hafalan Santri</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
    <link rel="manifest" href="/static/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', function() {
          navigator.serviceWorker.register('/static/service-worker.js').then(function(registration) {
            console.log('ServiceWorker registration successful with scope: ', registration.scope);
          }, function(err) {
            console.log('ServiceWorker registration failed: ', err);
          });
        });
      }
    </script>
    <style>
      :root {
        --bg-color: #f0f4f8;
        --text-color: #1f2937;
        --text-color-secondary: #6b7280;
        --panel-bg: #ffffff;
        --border-color: #e2e8f0;
        --shadow-color: rgba(0, 0, 0, 0.1);
        --accent-color: #FFD700;
        --graph-line-color: #2563eb;
        --graph-fill-color: rgba(37, 99, 235, 0.2);
        --graph-grid-color: rgba(0, 0, 0, 0.1);
        --graph-text-color: #4b5563;
      }
      .dark-mode {
        --bg-color: #1a202c;
        --text-color: #e2e8f0;
        --text-color-secondary: #9ca3af;
        --panel-bg: #2d3748;
        --border-color: #4a5568;
        --shadow-color: rgba(0, 0, 0, 0.5);
        --accent-color: #FFD700;
        --graph-line-color: #FFD700;
        --graph-fill-color: rgba(255, 215, 0, 0.2);
        --graph-grid-color: rgba(255, 255, 255, 0.1);
        --graph-text-color: #d1d5db;
      }
      body {
        font-family: 'Inter', sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        transition: background-color 0.5s ease, color 0.5s ease;
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        position: relative;
      }
      .main-content {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 0 30px var(--shadow-color);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        transition: background 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
      }
      .modern-panel, .futuristic-panel {
        background: var(--panel-bg);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 60px var(--shadow-color);
        backdrop-filter: blur(20px);
        position: relative;
        overflow: hidden;
        border-radius: 1rem;
        transition: background 0.5s ease, border-color 0.5s ease, box-shadow 0.5s ease;
      }
      .dark-mode .modern-panel, .dark-mode .futuristic-panel {
        background: linear-gradient(135deg, rgba(0, 0, 51, 0.8), rgba(0, 0, 0, 0.8));
        border: 1px solid rgba(255, 215, 0, 0.2);
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.1);
      }
      .modern-panel::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: conic-gradient(from 0deg, rgba(255, 255, 255, 0) 0%, rgba(255, 215, 0, 0.5) 10%, rgba(255, 215, 0, 0) 20%);
        animation: rotate-border 6s linear infinite;
        z-index: -1;
      }
      @keyframes rotate-border {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .futuristic-panel {
        padding: 1.5rem;
      }
      .futuristic-panel:hover {
        box-shadow: 0 0 25px rgba(77, 159, 202, 0.6);
      }
      .dark-mode .futuristic-panel:hover {
        box-shadow: 0 0 25px rgba(255, 215, 0, 0.6);
      }
      .futuristic-icon-panel .icon-item {
        position: relative;
        color: var(--text-color);
        transition: all 0.3s ease;
      }
      .futuristic-icon-panel .icon-item:hover {
        color: var(--accent-color);
        transform: scale(1.1);
        text-shadow: 0 0 10px rgba(255, 215, 0, 0.8), 0 0 20px rgba(255, 215, 0, 0.6);
      }
      .shimmer-text {
        background: linear-gradient(90deg, var(--text-color), var(--accent-color), var(--text-color));
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer 5s linear infinite;
      }
      @keyframes shimmer {
        to {
          background-position: 200% center;
        }
      }

      /* CSS untuk efek kilau pada tulisan Arab */
      .shimmer-arabic {
        font-family: 'MCS Hijaz S_U normal', serif; /* Mempertahankan font yang asli */
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.2), #fff, rgba(255, 255, 255, 0.2));
        background-size: 200% auto;
        background-clip: text;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: shimmer-arabic-anim 3s linear infinite;
      }
      @keyframes shimmer-arabic-anim {
        from {
          background-position: -200% center;
        }
        to {
          background-position: 200% center;
        }
      }

      /* New CSS classes for theme-aware text colors */
      .text-theme {
        color: var(--text-color);
      }
      .text-theme-secondary {
        color: var(--text-color-secondary);
      }
      ::-webkit-scrollbar {
        width: 8px;
      }
      ::-webkit-scrollbar-track {
        background: var(--panel-bg);
      }
      ::-webkit-scrollbar-thumb {
        background: var(--border-color);
        border-radius: 4px;
      }
      ::-webkit-scrollbar-thumb:hover {
        background: var(--accent-color);
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .feature-tooltip .tooltip-text {
        visibility: hidden;
        width: 160px;
        background-color: var(--panel-bg);
        color: var(--text-color);
        text-align: center;
        border-radius: 6px;
        padding: 8px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -80px;
        opacity: 0;
        transition: opacity 0.3s;
      }
      .feature-tooltip:hover .tooltip-text {
        visibility: visible;
        opacity: 1;
      }
      #welcome-modal {
        transition: opacity 0.3s ease;
      }
      .toggle-checkbox:checked {
        right: 0;
        border-color: var(--accent-color);
      }
      .toggle-checkbox:checked + .toggle-label {
        background-color: var(--accent-color);
      }
      .progress-container {
        width: 100%;
        background-color: #e2e8f0;
        border-radius: 9999px;
        overflow: hidden;
      }
      .progress-bar {
        height: 1.5rem;
        background-color: #FFD700;
        transition: width 0.5s ease-in-out;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: black;
      }
    </style>
  </head>
  <body class="transition-colors duration-500">
    <div id="app" class="container mx-auto p-4 md:p-8 max-w-7xl">
      <div id="role-selection-page" class="flex flex-col items-center justify-center min-h-screen p-4">
        
        <div class="fixed top-4 right-4 flex flex-col space-y-2 z-50">
          <button id="theme-toggle" class="p-3 rounded-full shadow-lg transition-colors duration-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-yellow-400">
            <span id="theme-icon" class="text-xl">🌞</span>
          </button>
        </div>
        
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl text-center relative modern-panel">
          <h2 class="text-4xl font-bold text-theme shimmer-text" id="app-title">SantriQ</h2>
          <p class="text-theme-secondary" id="select-role-text">Silakan pilih peran Anda untuk melanjutkan:</p>
          <div class="space-y-4 pt-4">
            
            <button onclick="window.handleRoleSelection('wali')" class="w-full px-4 py-3 font-semibold text-white bg-teal-700 rounded-lg hover:bg-teal-800" id="wali-button">
            Saya Wali Santri
            </button>
            <button onclick="window.handleRoleSelection('guru')" class="w-full px-4 py-3 font-semibold text-gray-900 bg-yellow-100 rounded-lg hover:bg-yellow-200" id="guru-button">
            Saya Pengurus / Guru
            </button>
            <button onclick="window.showPage('menghafal')" class="w-full px-4 py-3 font-semibold text-white bg-gray-600 rounded-lg hover:bg-gray-700" id="menghafal-button">
            Metode Menghafal Al-Qur'an 30 Juz
            </button>
          </div>
        </div>
        <div class="flex flex-col items-center mt-8 w-full max-w-sm mx-auto space-y-6">
          <div class="flex flex-wrap justify-center space-x-4 futuristic-icon-panel">
            <div class="feature-tooltip relative">
              <div class="w-12 h-12 futuristic-panel !p-0 rounded-full shadow-md flex items-center justify-center icon-item">
                <i class="fas fa-chart-line h-6 w-6"></i>
              </div>
              <span class="tooltip-text" id="tooltip-realtime">Monitoring Real-time</span>
            </div>
            <div class="feature-tooltip relative">
              <div class="w-12 h-12 futuristic-panel !p-0 rounded-full shadow-md flex items-center justify-center icon-item">
                <i class="fas fa-users-cog h-6 w-6"></i>
              </div>
              <span class="tooltip-text" id="tooltip-access">Akses Wali Santri</span>
            </div>
            <div class="feature-tooltip relative">
              <div class="w-12 h-12 futuristic-panel !p-0 rounded-full shadow-md flex items-center justify-center icon-item">
                <i class="fas fa-file-alt h-6 w-6"></i>
              </div>
              <span class="tooltip-text" id="tooltip-report">Laporan Terstruktur</span>
            </div>
          </div>
          <div class="text-left text-center">
            <p class="text-sm italic text-theme-secondary mt-2" id="quote-text">"Sebaik-baik kalian adalah orang<br>yang belajar Al-Qur'an dan mengajarkannya."</p>
          </div>
        </div>
        <footer class="mt-8 text-center text-sm text-theme-secondary">
          <button onclick="window.showAboutPage()" class="text-yellow-400 hover:text-yellow-500 underline mb-2" id="about-button">Tentang Aplikasi</button>
          <p id="copyright-text">Project dibuat oleh (MUHAMMAD NAHYA FADLALLAH) ©2025 All Rights Reserved</p>
          <a href="https://wa.me/6285520767908" target="_blank" class="block mt-4 text-center">
          <span class="text-sm font-semibold text-theme-secondary" id="help-center-text">PUSAT BANTUAN</span>
          </a>
        </footer>
      </div>
      <div id="pondok-register-page" class="hidden flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl relative modern-panel">
          <h2 class="text-2xl font-bold text-center text-theme" id="register-title">Daftarkan Pondok Anda</h2>
          <form id="pondok-register-form" class="space-y-6">
            <div>
              <label for="register-pondok-id" class="block text-sm font-medium text-theme" id="register-pondok-label">Nama Pondok & Nomor Unik</label>
              <input type="text" id="register-pondok-id" placeholder="Contoh: PPTI#12345" class="mt-1 w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
              <p class="text-xs text-theme-secondary mt-1" id="register-pondok-hint">Gunakan tanda pagar (#) untuk memisahkan nama dan nomor unik.</p>
            </div>
            <div>
              <label for="register-password" class="block text-sm font-medium text-theme" id="register-password-label">Buat Kata Sandi</label>
              <div class="relative mt-1">
                <input type="password" id="register-password" placeholder="Minimal 6 karakter" class="w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
                <button type="button" onclick="window.togglePasswordVisibility('register-password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                <i class="fas fa-eye text-theme-secondary"></i>
                </button>
              </div>
            </div>
            <button type="submit" class="w-full px-4 py-3 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="register-button">
            Daftar
            </button>
          </form>
          <p id="register-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
          <p class="text-center text-sm text-theme-secondary">
            <span id="have-account-text">Sudah punya akun?</span> <button onclick="window.showPage('pondokLogin')" class="font-semibold text-yellow-400 hover:underline" id="login-link-1">Masuk di sini</button>
          </p>
          <p class="text-center text-sm mt-4 text-theme-secondary">
            <button onclick="window.showPage('roleSelection')" class="hover:underline" id="back-to-role-1">Kembali ke pilihan peran</button>
          </p>
        </div>
      </div>
      <div id="pondok-login-page" class="hidden flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl relative modern-panel">
          <p class="text-4xl text-yellow-400 text-center" style="font-family: 'MCS Hijaz S_U normal', serif;">بسم الله الرحمن الرحيم</p>
          <h2 class="text-2xl font-bold text-center text-theme" id="login-title">Login Pengurus / Guru</h2>
          <form id="pondok-login-form" class="space-y-6">
            <div>
              <label for="login-pondok-id" class="block text-sm font-medium text-theme" id="login-pondok-label">Nama Pondok & Nomor Unik</label>
              <input type="text" id="login-pondok-id" placeholder="Contoh: PPTI#12345" class="mt-1 w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
            </div>
            <div>
              <label for="login-password" class="block text-sm font-medium text-theme" id="login-password-label">Kata Sandi</label>
              <div class="relative mt-1">
                <input type="password" id="login-password" placeholder="Kata Sandi Anda" class="w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
                <button type="button" onclick="window.togglePasswordVisibility('login-password', this)" class="absolute inset-y-0 right-0 pr-3 flex items-center text-sm leading-5">
                <i class="fas fa-eye text-theme-secondary"></i>
                </button>
              </div>
            </div>
            <button type="submit" class="w-full px-4 py-3 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="login-button">
            Login
            </button>
          </form>
          <p id="pondok-login-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
          <p class="text-center text-sm text-theme-secondary">
            <span id="no-account-text">Belum punya akun?</span> <button onclick="window.showPage('pondokRegister')" class="font-semibold text-yellow-400 hover:underline" id="register-link-2">Daftar di sini</button>
          </p>
          <p class="text-center text-sm mt-4 text-theme-secondary">
            <button onclick="window.showPage('roleSelection')" class="hover:underline" id="back-to-role-2">Kembali ke pilihan peran</button>
          </p>
        </div>
      </div>
      <div id="access-code-page" class="hidden flex-col items-center justify-center min-h-screen p-4">
        <div class="w-full max-w-sm p-8 space-y-6 rounded-xl shadow-2xl relative modern-panel">
          <h2 class="text-2xl font-bold text-center text-theme" id="access-code-title">Kode Akses Wali Santri</h2>
          <p class="text-sm text-center text-theme-secondary" id="access-code-subtitle">Silakan masukkan kode akses yang diberikan oleh pengurus.</p>
          <form id="access-code-form" class="space-y-6">
            <div>
              <label for="access-code" class="block text-sm font-medium text-theme" id="access-code-label">Kode Akses</label>
              <input type="text" id="access-code" placeholder="Masukkan kode" class="mt-1 w-full px-4 py-3 rounded-lg focus:ring-4 focus:ring-yellow-200 futuristic-panel" required>
            </div>
            <button type="submit" class="w-full px-4 py-3 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="access-code-button">
            Masuk
            </button>
          </form>
          <p id="access-code-error" class="text-red-500 text-sm mt-2 hidden text-center"></p>
          <p class="text-center text-sm mt-4 text-theme-secondary">
            <button onclick="window.showPage('roleSelection')" class="hover:underline" id="back-to-role-3">Kembali ke pilihan peran</button>
          </p>
        </div>
      </div>
	 </div>
      <!-- ================== WALI DASHBOARD ================== -->
      <div id="wali-dashboard-page" 
        class="hidden fade-in main-content p-8 rounded-xl shadow-lg flex flex-col h-screen">
        <!-- Header -->
        <header class="flex flex-col items-center justify-center text-center mb-8 pb-4 border-b border-border-color flex-shrink-0">
          <h1 class="text-3xl font-bold text-yellow-400" id="wali-dashboard-title">Dashboard Wali Santri</h1>
          <p class="text-theme-secondary" id="wali-dashboard-subtitle">Pilih kelas anak Anda untuk melihat detail progres hafalan.</p>
          <div class="w-full md:w-auto mt-4 md:mt-0 flex flex-wrap justify-center items-center space-x-2 space-y-2 md:space-x-4 md:space-y-0">
            <button onclick="window.showFeedPage('wali')" 
              class="px-4 py-2 font-semibold text-black bg-blue-400 rounded-lg hover:bg-blue-500" id="feed-btn-wali">
              <i class="fas fa-home mr-1"></i> Beranda
            </button>
            <button onclick="window.showJadwalDonasiPage()" 
              class="px-4 py-2 font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="jadwal-donasi-btn">
            Jadwal & Donasi
            </button>
            <button onclick="window.logout()" 
              class="px-4 py-2 font-semibold text-white bg-gray-700 rounded-lg hover:bg-gray-600" id="logout-btn-1">
            Keluar
            </button>
          </div>
        </header>
        <!-- Daftar Kelas -->
        <div id="kelas-list-container" class="overflow-y-auto flex-grow px-2 py-4">
          <div id="kelas-grid" 
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
            <!-- Tombol kelas akan dirender di sini -->
          </div>
        </div>
        <!-- Daftar Santri -->
        <div id="santri-list-container" class="hidden overflow-y-auto flex-grow px-2 py-4">
          <button onclick="window.renderWaliDashboard()" 
            class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-dashboard-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" 
              viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" 
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" 
                clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
          <h2 id="current-class-title" 
            class="text-2xl font-bold mb-4 text-theme text-center"></h2>
          <div id="santri-gallery" 
            class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-6">
          </div>
          <p id="no-results" class="text-center text-theme-secondary py-10 hidden">
            Santri tidak ditemukan.
          </p>
        </div>
      </div>
      <!-- ================== DETAIL SANTRI ================== -->
      <div id="detail-santri-page" class="hidden fade-in p-4">
        <!-- Header -->
        <header class="mb-4">
         <button onclick="window.showSantriListByKelas(sessionStorage.getItem('currentWaliKelas'))"
            class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-santri-list-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" 
              viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" 
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" 
                clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
        </header>
        <!-- Konten detail santri -->
        <div class="p-8 rounded-xl shadow-lg relative main-content">
          <!-- Foto + info santri -->
          <div class="flex flex-col items-center md:flex-row md:items-start 
            text-center md:text-left md:space-x-8 pb-8 border-b border-border-color">
            <img id="detail-foto" src="" alt="Foto Santri" 
              class="w-32 h-32 rounded-full object-cover border-4 border-yellow-400 shadow-md mb-4 md:mb-0" 
              onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';">
            <div class="flex flex-col items-center md:items-start">
              <h2 id="detail-nama" class="text-3xl font-bold text-theme"></h2>
              <p id="detail-kelas" class="text-xl text-theme-secondary"></p>
              <p id="detail-pengajar" class="text-md text-yellow-400 font-semibold mt-1"></p>
              <div id="detail-status-target" 
                class="mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold"></div>
            </div>
          </div>
          <!-- Grafik futuristik -->
          
          <div class="py-8 border-b border-border-color">
            <h3 class="text-2xl font-bold mb-6 text-center text-yellow-400" id="report-title">Laporan Pencapaian Target</h3>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 text-center">
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-theme-secondary" id="total-juz-label">Total Hafalan Juz</p>
                <p id="total-hafalan-juz" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-theme-secondary" id="daily-target-label">Target Harian</p>
                <p id="target-harian" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-theme-secondary" id="weekly-target-label">Target Mingguan</p>
                <p id="target-mingguan" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-theme-secondary" id="monthly-target-label">Target Bulanan</p>
                <p id="target-bulanan" class="text-lg font-bold text-yellow-400"></p>
              </div>
              <div class="futuristic-panel">
                <p class="text-sm font-medium text-theme-secondary" id="yearly-target-label">Target Tahunan</p>
                <p id="target-tahunan" class="text-lg font-bold text-yellow-400"></p>
              </div>
            </div>
          </div>

          <!-- Bagian Grafik -->
          <div class="pt-8 border-b border-border-color">
            <h3 class="text-2xl font-bold mb-4 text-center text-yellow-400" id="progress-chart-title">Progres Hafalan</h3>
            <div class="bg-panel-bg p-4 rounded-lg">
                <canvas id="hafalan-progres-chart"></canvas>
            </div>
          </div>
          <!-- Akhir Bagian Grafik -->

          <div class="pt-8">
            <h3 class="text-2xl font-bold mb-6 text-center text-yellow-400" id="history-title">Riwayat Setoran Hafalan</h3>
            <div class="overflow-x-auto futuristic-panel">
              <table class="min-w-full">
                <thead class="bg-gray-900">
                  <tr>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-date-label">Tanggal</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-setoran-label">Setoran</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-type-label">Jenis</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-grade-label">Penilaian Guru</th>
                  </tr>
                </thead>
                <tbody id="hafalan-history" class="divide-y divide-border-color"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div id="jadwal-donasi-page" class="hidden fade-in p-4">
        <header class="mb-4">
          <button onclick="window.goBackFromJadwal()" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-dashboard-btn-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali ke Dashboard
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg space-y-12 relative main-content">
          <div>
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-2" id="prayer-schedule-title">Jadwal Solat Hari Ini</h2>
            <div class="flex flex-col md:flex-row items-center justify-center space-x-3 my-4">
              <label for="alarm-toggle" class="font-semibold text-theme" id="azan-alarm-label">Alarm Azan:</label>
              <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                <input type="checkbox" name="alarm-toggle" id="alarm-toggle" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" />
                <label for="alarm-toggle" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-700 cursor-pointer"></label>
              </div>
            </div>
            <p id="jadwal-lokasi" class="text-center text-theme-secondary mb-6">Memuat data untuk lokasi anda...</p>
            <div id="jadwal-sholat-container" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 text-center">
            </div>
          </div>
          <div>
            <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6">Infaq Jariyah untuk Generasi Penghafal Qur'an</h2>
            <div class="max-w-md mx-auto futuristic-panel p-6 rounded-lg text-center shadow-sm">
              <p class="text-theme-secondary mb-4">Dukungan Anda memastikan SantriQ tetap menjadi jembatan amal saleh. Bantu kami menjaga data hafalan santri tetap aman dan real-time.</p>
              <p class="text-yellow-400 font-semibold italic mb-2">Jadikan donasi Anda sebagai saham akhirat!</p>
              <p class="text-sm text-theme-secondary mb-4">Kami mempunyai tanggungan biaya per-bulan sebesar Rp 450.000 untuk biaya hosting, domain, save data & pengembangan fitur tadabbur sebesar Rp 150.000.</p>
              
              <!-- Progress Bar Section -->
              <div class="space-y-2 mt-4">
                <div class="progress-container">
                  <div class="progress-bar" style="width: 10%;" id="infaq-progress-bar">10%</div>
                </div>
                <p class="text-sm text-theme-secondary">Target Bulanan: Rp 600.000</p>
              </div>

              <div class="flex items-center justify-center space-x-2 my-4">
                <span id="donation-number" class="text-2xl font-bold text-theme p-2 rounded-md border-2 border-dashed border-border-color">0856 3777 508</span>
                <button onclick="window.copyDonationNumber()" class="px-4 py-3 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500 flex items-center">
                  Salin <i class="ml-2 fas fa-copy"></i>
                </button>
              </div>
              <div class="flex justify-center space-x-4 mt-4">
                <img src="https://upload.wikimedia.org/wikipedia/commons/7/72/Logo_dana_blue.svg" alt="DANA" class="h-8">
                <img src="https://upload.wikimedia.org/wikipedia/commons/e/eb/Logo_ovo_purple.svg" alt="OVO" class="h-8">
              </div>
              <p class="text-sm text-theme-secondary mt-4">Amanah Anda kami jaga. a.n. Tim Pengembang: [M.Nahya Fadlallah]</p>
            </div>
          </div>
        </div>
      </div>
      <div id="guru-dashboard-page" class="hidden fade-in main-content p-8 rounded-xl shadow-lg flex flex-col h-screen">
        <header class="flex flex-col items-center justify-center text-center mb-8 pb-4 border-b border-border-color flex-shrink-0">
          <h1 class="text-3xl font-bold text-yellow-400" id="guru-dashboard-title">Panel Guru</h1>
          <p class="text-theme-secondary mb-4" id="guru-dashboard-subtitle">Kelola data hafalan santri.</p>
	<div class="flex items-center space-x-2 mt-2 flex-wrap justify-center">
            <button onclick="window.showFeedPage('guru')" class="px-3 py-2 text-sm font-semibold text-black bg-blue-400 rounded-lg hover:bg-blue-500" id="feed-btn-guru"><i class="fas fa-home mr-1"></i> Beranda</button>
            <button onclick="window.showJadwalDonasiPage()" class="px-3 py-2 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="jadwal-donasi-btn-2">Jadwal & Donasi</button>
            <button onclick="window.showGuruManagementPage()" class="px-3 py-2 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="manage-guru-btn">
            Kelola Data Guru
            </button>
            <button onclick="window.showGuruForm(null)" class="px-3 py-2 text-sm font-semibold text-black bg-yellow-400 rounded-lg hover:bg-yellow-500" id="add-santri-btn">
            + Tambah Santri Baru
            </button>
            <button onclick="window.logout()" class="px-3 py-2 text-sm font-semibold text-red-600 bg-red-100 rounded-lg hover:bg-red-200" id="logout-btn-2">Keluar</button>
          </div>
        </header>
        <div id="santri-grid-container" class="overflow-y-auto flex-grow px-2">
          <div id="guru-santri-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
          </div>
        </div>
        <div id="unique-access-code-section" class="futuristic-panel mt-8 text-center flex-shrink-0">
          <h3 class="text-xl font-bold text-yellow-400 mb-4" id="access-code-section-title">Kode Akses Wali Santri</h3>
          <div class="flex flex-col sm:flex-row items-center justify-center space-y-4 sm:space-y-0 sm:space-x-4">
            <p id="unique-access-code" class="text-2xl font-mono tracking-widest text-theme p-2 rounded-md border border-yellow-400 shadow-sm"></p>
            <button onclick="window.copyAccessCode()" class="px-4 py-2 bg-yellow-400 text-black rounded-md hover:bg-yellow-500" id="copy-access-code-btn">
            Salin Kode
            </button>
            <a id="whatsapp-link" href="#" target="_blank" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12.04 2.167c-5.495 0-9.96 4.465-9.96 9.96 0 1.634.437 3.275 1.258 4.71L2.16 21.84l4.966-1.306c1.37.78 2.912 1.185 4.914 1.185 5.494 0 9.96-4.465 9.96-9.96 0-5.495-4.466-9.96-9.96-9.96zM17.47 16.32c-.156.467-.936.463-1.603.224-.666-.238-2.618-1.01-3.036-1.166-.418-.157-.723-.235-1.028.235-.305.47-.936 1.165-1.14 1.413-.204.248-.408.27-.76.092-.352-.178-1.464-.539-2.79-1.722-1.028-.9-1.714-2.28-1.92-2.65-.204-.37-.02-.574.156-.76.155-.178.303-.306.46-.539.155-.234.204-.418.305-.652.102-.234.05-.438-.02-.652-.07-.215-.65-.585-.898-.82-.248-.235-.497-.196-.701-.196-.205 0-.46-.079-.708-.079-.247 0-.666.236-.936.63-.27.394-.97 1.173-.97 2.858 0 1.685 1.002 3.308 1.142 3.556.14.248 1.968 3.018 4.8 4.228 2.834 1.21 2.834.814 3.33 1.05.496.236.936.204 1.306.027.37-.177 1.092-.497 1.248-.73.155-.233.223-.448.33-.63z" />
              </svg>
              <span id="whatsapp-share-text">Bagikan di WhatsApp</span>
            </a>
          </div>
        </div>
      </div>
      <div id="guru-form-page" class="hidden fade-in p-4">
        <header class="mb-4">
          <button onclick="window.backToGuruDashboard()" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-guru-dashboard-btn">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali ke Panel Guru
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 id="form-title" class="text-2xl font-bold mb-6 text-yellow-400"></h2>
          <form id="santri-form" class="space-y-6" enctype="multipart/form-data">
            <input type="hidden" id="santri-id">
            <input type="hidden" id="current-photo-url">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label for="nama" class="block text-sm font-medium text-theme" id="santri-name-label">Nama Lengkap Santri</label>
                <input type="text" id="nama" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="kelas" class="block text-sm font-medium text-theme" id="class-label">Kelas</label>
                <select id="kelas" class="mt-1 block w-full px-4 py-3 futuristic-panel" required></select>
              </div>
            </div>
            <div>
              <label for="foto" class="block text-sm font-medium text-theme" id="upload-photo-label">Unggah Foto Santri</label>
              <input type="file" id="foto" name="file" accept="image/*" class="mt-1 block w-full px-4 py-3 futuristic-panel">
              <p id="foto-status" class="text-sm text-theme-secondary mt-2"></p>
            </div>
            <div class="pt-4 border-t border-border-color">
              <h3 class="text-lg font-medium text-theme" id="target-data-title">Data Target Hafalan</h3>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
			<div>
   				 <label for="total-hafalan-juz-guru" class="block text-sm font-medium text-theme" id="total-juz-guru-label">Total Hafalan Juz</label>
    			   <input type="number" id="total-hafalan-juz-guru" placeholder="Contoh: 5" class="mt-1 block w-full px-4 py-3 futuristic-panel">
				</div>
              <div>
                <label for="form-target-harian" class="block text-sm font-medium text-theme" id="daily-target-label-form">Target Harian</label>
                <select id="form-target-harian" class="mt-1 block w-full px-4 py-3 futuristic-panel"></select>
              </div>
              <div>
                <label for="form-target-mingguan" class="block text-sm font-medium text-theme" id="weekly-target-label-form">Target Mingguan</label>
                <select id="form-target-mingguan" class="mt-1 block w-full px-4 py-3 futuristic-panel"></select>
              </div>
              <div>
                <label for="form-target-bulanan" class="block text-sm font-medium text-theme" id="monthly-target-label-form">Target Bulanan</label>
                <input type="text" id="form-target-bulanan" placeholder="Contoh: 1 Juz" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="form-target-tahunan" class="block text-sm font-medium text-theme" id="yearly-target-label-form">Target Tahunan</label>
                <input type="text" id="form-target-tahunan" placeholder="Contoh: 5 Juz" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-theme" id="target-status-label">Status Pencapaian Target</label>
              <div class="mt-2 flex items-center space-x-4">
                <label class="inline-flex items-center">
                <input type="radio" name="tercapai" value="true" class="form-radio h-4 w-4 text-yellow-400">
                <span class="ml-2 text-theme" id="achieved-label">Mencapai Target</span>
                </label>
                <label class="inline-flex items-center">
                <input type="radio" name="tercapai" value="false" class="form-radio h-4 w-4 text-yellow-400">
                <span class="ml-2 text-theme" id="not-achieved-label">Belum Mencapai Target</span>
                </label>
              </div>
            </div>
            <div class="flex justify-end pt-2">
              <button type="submit" class="px-6 py-2 bg-yellow-400 text-black rounded-md hover:bg-yellow-500" id="save-santri-btn">Simpan Data Santri</button>
            </div>
          </form>
          <div id="hafalan-management-section" class="hidden pt-8 border-t border-border-color mt-8">
            <h3 class="text-xl font-bold mb-4 text-yellow-400" id="manage-hafalan-title">Kelola Setoran Hafalan</h3>
            <form id="hafalan-form" class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end futuristic-panel mb-6">
              <div>
                <label for="hafalan-tanggal" class="block text-sm font-medium text-theme" id="hafalan-date-label">Tanggal</label>
                <input type="date" id="hafalan-tanggal" class="mt-1 w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="hafalan-setoran" class="block text-sm font-medium text-theme" id="hafalan-setoran-label">Setoran</label>
                <input type="text" id="hafalan-setoran" placeholder="Contoh: An-Naba: 1-20" class="mt-1 w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="hafalan-jenis" class="block text-sm font-medium text-theme" id="hafalan-type-label">Jenis</label>
                <select id="hafalan-jenis" class="mt-1 w-full px-4 py-3 futuristic-panel">
                  <option id="new-hafalan-option">Hafalan Baru</option>
                  <option id="murojaah-option">Muroja'ah</option>
                </select>
              </div>
              <div>
                <label for="hafalan-penilaian" class="block text-sm font-medium text-theme" id="hafalan-grade-label">Penilaian</label>
                <select id="hafalan-penilaian" class="mt-1 w-full px-4 py-3 futuristic-panel">
                  <option id="lancar-option">Lancar</option>
                  <option id="ulang-option">Perlu Diulang</option>
                </select>
              </div>
              <button type="submit" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700" id="add-hafalan-btn">Tambah</button>
            </form>
            <div class="overflow-x-auto">
              <table class="min-w-full futuristic-panel">
                <thead class="bg-gray-900">
                  <tr>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-date-label-2">Tanggal</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-setoran-label-2">Setoran</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-type-label-2">Jenis</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-grade-label-2">Penilaian Guru</th>
                    <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase tracking-wider" id="table-action-label">Aksi</th>
                  </tr>
                </thead>
                <tbody id="guru-hafalan-table" class="divide-y divide-border-color"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div id="guru-management-page" class="hidden fade-in p-4">
        <header class="mb-4">
          <button onclick="window.backToGuruDashboard()" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-guru-dashboard-btn-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali ke Panel Guru
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 class="text-2xl font-bold mb-6 text-yellow-400" id="manage-guru-title">Kelola Data Guru</h2>
          <form id="guru-form" class="space-y-4 futuristic-panel mb-8">
            <input type="hidden" id="guru-id">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
              <div>
                <label for="guru-nama" class="block text-sm font-medium text-theme" id="guru-name-label">Nama Guru (Ustadz/Ustadzah)</label>
                <input type="text" id="guru-nama" class="mt-1 block w-full px-4 py-3 futuristic-panel" required>
              </div>
              <div>
                <label for="guru-kelas" class="block text-sm font-medium text-theme" id="guru-class-label">Mengajar Kelas</label>
                <select id="guru-kelas" class="mt-1 block w-full px-4 py-3 futuristic-panel" required></select>
              </div>
              <button type="submit" class="px-6 py-2 bg-yellow-400 text-black rounded-md hover:bg-yellow-500 w-full" id="save-guru-btn">Simpan Guru</button>
            </div>
          </form>
          <h3 class="text-xl font-bold mb-4 text-yellow-400" id="registered-guru-list">Daftar Guru Terdaftar</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full futuristic-panel">
              <thead class="bg-gray-900">
                <tr>
                  <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase" id="guru-table-name">Nama Guru</th>
                  <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase" id="guru-table-class">Mengajar Kelas</th>
                  <th class="py-3 px-6 text-left text-xs font-medium text-yellow-400 uppercase" id="guru-table-action">Aksi</th>
                </tr>
              </thead>
              <tbody id="guru-list-table" class="divide-y divide-border-color">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="menghafal-page" class="hidden fade-in p-4">
        <header class="mb-4">
          <button onclick="window.showPage('roleSelection')" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-role-4">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6" id="menghafal-title">Keistimewaan dan Metode Menghafal Al-Qur'an</h2>
          <div class="space-y-8 text-theme-secondary leading-relaxed" id="menghafal-content">
            
            <p>
              Inti dari perjalanan ini terletak pada pemahaman bahwa Al-Qur'an diturunkan bukan hanya untuk dilafalkan, tetapi juga untuk direnungkan dan diamalkan. Merujuk pada firman Allah dalam Surah Shad ayat 29, Al-Qur'an adalah kitab yang diturunkan agar orang-orang yang berakal sehat dapat merenungi ayat-ayatnya dan mengambil pelajaran darinya. Perjalanan hafalan, oleh karena itu, merupakan upaya holistik yang menyatukan hati, akal, dan lidah. Semangat untuk mengkhatamkan hafalan tanpa berusaha memahami maknanya dapat mengikis kelezatan spiritual yang seharusnya dirasakan, sebagaimana disampaikan oleh Al-Hasan Al-Bashriy. Dengan demikian, laporan ini akan mengintegrasikan aspek spiritual dan teknis secara harmonis, mengakui bahwa fondasi keikhlasan adalah prasyarat untuk setiap rutinitas hafalan.
            </p>
            
            ---
            
            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">II. Fondasi Utama: Pilar Keberhasilan Menghafal</h3>
              <p>Sebelum merancang jadwal atau memilih metode, terdapat pilar-pilar fundamental yang harus ditegakkan untuk memastikan proses hafalan berjalan dengan lancar dan penuh berkah. Pilar-pilar ini mencakup aspek spiritual dan teknis.</p>
              
              <h4 class="text-xl font-semibold text-yellow-400 mt-6 mb-2">Pilar Spiritual</h4>
              <ul class="list-disc list-inside pl-4 space-y-2">
                <li>
                  (Niat yang Ikhlas) Semua amal perbuatan dalam Islam dimulai dengan niat yang tulus. Dalam konteks menghafal Al-Qur'an, niat harus sepenuhnya diarahkan untuk mencari ridha Allah semata, bukan untuk meraih pengakuan, popularitas, atau gelar. Rasulullah SAW bersabda, “Sesungguhnya segala perbuatan itu bergantung pada niatnya, dan setiap orang akan mendapatkan apa yang diniatkannya.” Niat yang lurus adalah fondasi spiritual yang menumbuhkan keyakinan, mengurangi rasa lelah, dan membantu menjaga konsistensi (istiqomah) dalam menghadapi berbagai rintangan. Tanpa fondasi ini, rutinitas teknis apa pun akan mudah goyah saat dihadapkan pada tantangan.
                </li>
                <li>
                  (Peran Guru Pembimbing) Kehadiran seorang guru (muhaffizh/muhaffizhah) merupakan elemen yang tak tergantikan dalam proses hafalan. Guru tidak hanya berfungsi sebagai tempat setoran hafalan, tetapi juga sebagai korektor, pembimbing, dan motivator. Tugas utama seorang guru adalah mengoreksi bacaan (makhraj dan tajwid), yang sangat krusial karena kesalahan dalam pengucapan dapat mengubah makna ayat. Sebuah studi perbandingan antara metode Wahdah (dengan bimbingan langsung) dan Sima'i (mengandalkan rekaman audio) menemukan bahwa bimbingan guru secara langsung jauh lebih efektif dalam menghasilkan hafalan yang "melekat kuat". Hal ini terjadi karena media audio tidak dapat memberikan koreksi instan. Kesalahan dalam pelafalan yang diulang-ulang akan terekam dalam memori, sehingga sulit untuk diperbaiki di kemudian hari. Oleh karena itu, kehadiran seorang guru bukan sekadar pilihan, melainkan prasyarat penting untuk mencapai hafalan yang mutqin (sempurna dan tidak mudah lupa).
                </li>
              </ul>
              
              <h4 class="text-xl font-semibold text-yellow-400 mt-6 mb-2">Pilar Teknis Awal</h4>
              <ul class="list-disc list-inside pl-4 space-y-2">
                <li>
                  (Memperbaiki Bacaan Tahsin) Sebelum memulai hafalan, sangat dianjurkan untuk terlebih dahulu membenahi kualitas bacaan. Memastikan penguasaan tajwid dan makhraj adalah langkah fundamental agar hafalan yang dibangun tidak cacat. Memperbaiki bacaan tidak hanya meningkatkan kualitas hafalan, tetapi juga menambah keberkahan dalam prosesnya.
                </li>
                <li>
                  (Menggunakan Satu Jenis Mushaf) Disarankan untuk selalu menggunakan satu jenis mushaf yang sama sepanjang perjalanan hafalan. Hal ini bertujuan untuk memanfaatkan daya ingat visual. Otak manusia cenderung merekam "peta visual" atau letak spesifik ayat-ayat pada halaman mushaf. Perubahan mushaf akan mengganggu "peta" ini, sehingga dapat memperlambat dan mempersulit proses menghafal.
                </li>
              </ul>
            </section>
            
            ---

            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">III. Model Jadwal Komprehensif: Pilihan Jalur Hafalan</h3>
              <p>Keberhasilan dalam menghafal Al-Qur'an sangat bergantung pada kesesuaian jadwal dengan kapasitas dan kondisi individu. Tidak ada satu jadwal tunggal yang cocok untuk semua orang. Laporan ini menyajikan beberapa model jadwal yang dapat disesuaikan, dengan menekankan bahwa istiqomah (konsistensi) lebih berharga daripada kecepatan semata.</p>
              
              <div class="overflow-x-auto my-4">
                <table class="min-w-full futuristic-panel">
                  <thead>
                    <tr class="bg-gray-900">
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Model Jalur</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Jangka Waktu</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Target Hafalan Harian</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Catatan</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">Ekspres (Tidak Sibuk)</td>
                      <td class="py-2 px-4 border-b border-border-color">1-2 Tahun</td>
                      <td class="py-2 px-4 border-b border-border-color">5-10 halaman</td>
                      <td class="py-2 px-4 border-b border-border-color">Membutuhkan fokus penuh dan komitmen tinggi.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">Ideal (Setengah Sibuk)</td>
                      <td class="py-2 px-4 border-b border-border-color">2-4 Tahun</td>
                      <td class="py-2 px-4 border-b border-border-color">2-4 halaman</td>
                      <td class="py-2 px-4 border-b border-border-color">Jadwal yang realistis, memberikan ruang untuk muraja'ah.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4">Fleksibel (Sangat Sibuk)</td>
                      <td class="py-2 px-4">8-10 Tahun</td>
                      <td class="py-2 px-4">1-2 halaman</td>
                      <td class="py-2 px-4">Menekankan konsistensi (istiqomah) di atas kecepatan.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            ---

            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">IV. Membangun Rutinitas Harian yang Efektif</h3>
              <p>Inti dari rutinitas harian yang efektif adalah sistem muraja'ah atau pengulangan. Pepatah lama mengatakan, "menghafal Al-Qur'an lebih mudah daripada menjaganya." Tanpa pengulangan yang ketat, hafalan akan mudah hilang. Rasulullah SAW menggambarkan hafalan Al-Qur'an seperti unta yang diikat. Jika pemiliknya terus memegang tali, ia akan tetap miliknya, tetapi jika dilepaskan, ia akan pergi. Sistem muraja'ah yang terbukti efektif membagi pengulangan menjadi tiga jenis utama:</p>

              <ul class="list-disc list-inside pl-4 mt-4 space-y-2">
                <li>
                  Sabaq: Merupakan hafalan baru yang disetorkan pada hari itu. Bagian ini wajib diulang berkali-kali untuk "menanamkan" ayat-ayat ke dalam memori.
                </li>
                <li>
                  Sabqi: Merupakan hafalan dari beberapa hari terakhir. Pengulangan harian dari hafalan ini bertujuan untuk memperkuat transisi dari memori jangka pendek ke memori jangka panjang.
                </li>
                <li>
                  Manzil/Maqra': Merupakan hafalan lama yang sudah jauh. Pengulangan Manzil berfungsi untuk menjaga kualitas hafalan keseluruhan dan memastikan tidak ada bagian yang terlupakan.
                </li>
              </ul>
              
              <div class="overflow-x-auto my-4">
                <table class="min-w-full futuristic-panel">
                  <thead>
                    <tr class="bg-gray-900">
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Waktu</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Aktivitas Utama</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Jenis Muraja'ah</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Tujuan</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">Pagi (Ba'da Subuh)</td>
                      <td class="py-2 px-4 border-b border-border-color">Hafalan Baru (Sabaq)</td>
                      <td class="py-2 px-4 border-b border-border-color">Tikrar & Setoran Sabaq</td>
                      <td class="py-2 px-4 border-b border-border-color">Menambahkan hafalan baru pada waktu optimal dengan pikiran yang segar.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">Siang/Sore</td>
                      <td class="py-2 px-4 border-b border-border-color">Muraja'ah Sabqi & Manzil</td>
                      <td class="py-2 px-4 border-b border-border-color">Pengulangan Hafalan 1-7 Hari Terakhir & Hafalan Lama</td>
                      <td class="py-2 px-4 border-b border-border-color">Menguatkan hafalan jangka pendek dan menjaga hafalan jangka panjang.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4">Malam (Ba'da Maghrib/Isya)</td>
                      <td class="py-2 px-4">Muraja'ah Intensif</td>
                      <td class="py-2 px-4">Pengulangan Total Hafalan Hari Ini & Sebelumnya</td>
                      <td class="py-2 px-4">Memperkuat memori sebelum tidur, mengulang kembali seluruh capaian harian.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </section>

            ---

            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">V. Analisis Mendalam Metode dan Teknik Hafalan</h3>
              <p>Setiap individu memiliki gaya belajar yang berbeda, oleh karena itu, penting untuk memahami berbagai metode hafalan yang populer untuk menemukan yang paling sesuai. Berikut adalah perbandingan beberapa metode yang telah terbukti efektif: </p>
              
              <div class="overflow-x-auto my-4">
                <table class="min-w-full futuristic-panel">
                  <thead>
                    <tr class="bg-gray-900">
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Metode</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Prinsip Utama</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Keunggulan</th>
                      <th class="py-2 px-4 text-left text-xs font-medium text-yellow-400 uppercase">Kekurangan & Catatan</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">3T+1M</td>
                      <td class="py-2 px-4 border-b border-border-color">Talqin, Tafahhum, Tikrar, Muraja'ah</td>
                      <td class="py-2 px-4 border-b border-border-color">Komprehensif, mencakup aspek pengajaran, pemahaman, dan pengulangan.</td>
                      <td class="py-2 px-4 border-b border-border-color">Memerlukan bimbingan guru dan konsistensi tinggi.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">Wahdah</td>
                      <td class="py-2 px-4 border-b border-border-color">Membaca & menghafal dengan satu mushaf.</td>
                      <td class="py-2 px-4 border-b border-border-color">Efektif untuk memori visual, menghasilkan hafalan yang lebih "melekat."</td>
                      <td class="py-2 px-4 border-b border-border-color">Kurang cocok untuk audial learner, tanpa guru rawan kesalahan.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4 border-b border-border-color">Sima'i</td>
                      <td class="py-2 px-4 border-b border-border-color">Mendengarkan rekaman audio.</td>
                      <td class="py-2 px-4 border-b border-border-color">Fleksibel, dapat dilakukan di mana saja, membantu penguasaan irama.</td>
                      <td class="py-2 px-4 border-b border-border-color">Kurang efektif tanpa bimbingan guru karena tidak ada koreksi langsung.</td>
                    </tr>
                    <tr>
                      <td class="py-2 px-4">Talaqqi</td>
                      <td class="py-2 px-4">Guru membacakan, murid menirukan.</td>
                      <td class="py-2 px-4">Metode asli dari Rasulullah, sangat akurat untuk tajwid & makhraj.</td>
                      <td class="py-2 px-4">Kurang mandiri, membutuhkan bimbingan intensif dari guru.</td>
                    </tr>
                  </tbody>
                </table>
              </div>
              <p>Metode **3T+1M** (Talqin, Tafahhum, Tikrar, Muroja'ah) merupakan pendekatan yang sangat holistik. **Talqin dan Tasmi'** memastikan bacaan benar melalui bimbingan guru. **Tafahhum** (pemahaman makna) membantu mempercepat hafalan karena otak dapat menciptakan koneksi kognitif dengan isi ayat. **Tikrar** (pengulangan) yang terstruktur, seperti membaca satu ayat 10-20 kali lalu menggabungkannya dengan ayat lain, memperkuat memori. Sementara itu, metode **Wahdah** menonjolkan kekuatan memori visual dengan menggunakan satu jenis mushaf, yang secara empiris terbukti menghasilkan hafalan yang lebih kuat dan tidak mudah hilang.
              </p>
            </section>
            
            ---

            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">VI. Tadabbur: Kunci Penguat Hafalan dan Kedekatan Hati</h3>
              <p>Tadabbur, yang secara harfiah berarti merenungkan, adalah tujuan utama dari membaca dan menghafal Al-Qur'an. Tanpa tadabbur, hafalan cenderung menjadi hafalan lisan belaka yang tidak menyentuh hati. Para ulama, seperti Ibnu Jarir ath-Thabariy, merasa takjub pada orang yang menghafal Al-Qur'an tetapi tidak mengetahui tafsirnya, bertanya-tanya bagaimana mereka dapat merasakan kelezatan dari bacaan mereka.</p>
              <p>Proses tadabbur memiliki hubungan timbal balik yang penting dengan kualitas hafalan. Ketika seseorang memahami makna sebuah ayat, ia menciptakan koneksi emosional dan intelektual dengan ayat tersebut. Koneksi ini secara signifikan memperkuat daya ingat, membuat hafalan menjadi lebih solid dan tidak mudah hilang. Hal ini mengubah hafalan dari tugas kognitif menjadi pengalaman spiritual yang menyenangkan dan bermakna.</p>
            </section>
            
            ---
            
            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">VII. Kiat-Kiat Penunjang dan Menjaga Konsistensi Jangka Panjang</h3>
              <p>Beberapa kiat praktis dapat membantu Anda dalam perjalanan menghafal:</p>
              <ul class="list-disc list-inside pl-4 mt-4 space-y-2">
                <li>
                  (Memanfaatkan Teknologi) Aplikasi Al-Qur'an, audio murattal, dan video pembelajaran dapat membantu dalam familiarisasi dengan ayat-ayat dan memperkuat irama bacaan.
                </li>
                <li>
                 (Dukungan Sosial dan Lingkungan) Bergabung dengan kelompok hafalan atau komunitas yang sejalan dapat meningkatkan semangat dan memberikan kesempatan untuk saling menyimak dan mengoreksi hafalan.
                </li>
                <li>
                  (Mengatasi Tantangan) Seseorang dapat menerapkan "Aturan Dua Menit," yaitu memulai aktivitas hafalan minimal 2 menit. Biasanya, setelah memulai, akan lebih mudah untuk melanjutkan.
                </li>
              </ul>
            </section>

            ---

            <section>
              <h3 class="text-2xl font-bold text-yellow-400 mb-4">VIII. Kesimpulan</h3>
              <p>
                Perjalanan menghafal Al-Qur'an 30 juz adalah sebuah komitmen seumur hidup yang melampaui sekadar hafalan lisan. Keberhasilan dalam perjalanan ini didasarkan pada fondasi yang kokoh, terdiri dari niat yang ikhlas, bimbingan guru yang kompeten, dan konsistensi yang teguh. Pemilihan jadwal yang sesuai dengan kapasitas pribadi, dengan memprioritaskan istiqomah di atas kecepatan, adalah kunci untuk mencapai tujuan tanpa kehilangan momentum.
              </p>
              <p>
                Analisis mendalam terhadap sistem muraja'ah harian (Sabaq, Sabqi, Manzil) menunjukkan bahwa pengulangan yang terstruktur adalah nafas dari setiap hafalan. Pada akhirnya, tadabbur menjadi esensi yang menghubungkan hafalan dengan hati, mengubahnya dari sekadar tugas menjadi ibadah yang bermakna dan menyenangkan. Dengan memadukan semua pilar ini, seseorang dapat menapaki jalan hafalan dengan ilmu dan keyakinan, menjadikannya sebuah pengalaman spiritual yang memperkuat iman dan membawa keberkahan.
              </p>
            </section>

          </div>
        </div>
      </div>
      <div id="about-page" class="hidden fade-in p-4">
        <header class="mb-4">
          <button onclick="window.showPage('roleSelection')" class="mb-4 flex items-center text-yellow-400 hover:text-yellow-500 font-semibold" id="back-to-role-5">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
            </svg>
            Kembali
          </button>
        </header>
        <div class="p-8 rounded-xl shadow-lg max-w-4xl mx-auto relative main-content">
          <h2 class="text-3xl font-bold text-center text-yellow-400 mb-6" id="about-title">Tentang Aplikasi Monitoring Hafalan</h2>
          <div class="space-y-6 text-theme-secondary leading-relaxed" id="about-content">
            <section>
              <h3 class="text-xl font-semibold text-yellow-400 mb-2" id="about-background-title">Latar Belakang Pembuatan</h3>
              <p>
                Dalam dunia pendidikan Islam, khususnya di pondok pesantren tahfidz, proses memonitor perkembangan hafalan Al-Qur'an setiap santri adalah sebuah tugas yang krusial namun seringkali menantang. Guru (Ustadz/Ustadzah) harus mencatat setiap setoran, mengidentifikasi kelemahan, dan melaporkannya kepada wali santri. Di sisi lain, wali santri seringkali merasa kesulitan untuk mendapatkan informasi yang real-time dan terstruktur mengenai progres anak-anak mereka. Proses yang masih manual menggunakan buku atau catatan terpisah rentan terhadap kesalahan, kehilangan data, dan memakan waktu. Aplikasi ini lahir dari kebutuhan untuk menjembatani kesenjangan komunikasi tersebut dan mendigitalisasi proses monitoring agar lebih efisien, transparan, dan akurat.
              </p>
            </section>
            <section>
              <h3 class="text-xl font-semibold text-yellow-400 mb-2" id="about-goal-title">Tujuan Utama Aplikasi</h3>
              <p>
                Tujuan utama kami mengembangkan platform ini adalah untuk menciptakan sebuah ekosistem digital yang terintegrasi bagi pondok pesantren, yang berfokus pada tiga pilar utama:
              </p>
              <ul class="list-disc list-inside pl-4 mt-2 space-y-1">
                <li><strong id="goal-1-title">Memudahkan Guru:</strong> <span id="goal-1-text">Menyediakan alat yang praktis bagi para guru untuk mencatat, mengelola, dan menganalisis data hafalan santri dengan cepat dan mudah, sehingga mereka dapat lebih fokus pada proses pengajaran.</span></li>
                <li><strong id="goal-2-title">Memberikan Ketenangan bagi Wali Santri:</strong> <span id="goal-2-text">Memberikan akses langsung kepada wali santri untuk memantau pencapaian, riwayat setoran, dan target hafalan anak mereka kapan saja dan di mana saja.</span></li>
                <li><strong id="goal-3-title">Meningkatkan Motivasi Santri:</strong> <span id="goal-3-text">Dengan adanya target yang jelas dan progres yang dapat dilihat secara visual, kami berharap para santri akan lebih termotivasi untuk mencapai target hafalan mereka.</span></li>
                <br>
                
              </ul>
            </section>
            <section>
              <p class="text-center italic text-theme-secondary pt-4 border-t border-border-color mt-8" id="about-quote">
                Kami percaya bahwa teknologi dapat menjadi alat yang ampuh untuk mendukung pendidikan Al-Qur'an. Semoga aplikasi ini dapat memberikan manfaat yang luas dan menjadi bagian dari ladang amal jariyah kita semua. Aamiin.
              </p>
            </section>
          </div>
        </div>
      </div>
    </div>
    <audio id="azan-alarm" src="https://archive.org/download/AzanMakkah/Azan%20Makkah.mp3" preload="auto"></audio>
    <div id="alarm-notification" class="hidden fixed bottom-5 right-5 bg-yellow-400 text-black p-4 rounded-lg shadow-2xl z-50 transform transition-all duration-300">
      <div class="flex items-start">
        <div class="mr-3">
          <p class="font-bold text-lg" id="alarm-text"></p>
          <p class="text-sm">Waktunya menunaikan salat.</p>
        </div>
        <button onclick="window.dismissAlarm()" class="text-gray-800 hover:text-black">&times;</button>
      </div>
    </div>
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-5 right-5 z-50"></div>
    <audio id="success-ding" src="https://actions.google.com/sounds/v1/foley/ding_a_ling.ogg" preload="auto"></audio>
<div id="feed-page" class="hidden fixed inset-0 z-50 bg-black flex-col">
        <div id="feed-top-bar" class="absolute top-0 w-full z-10 p-4 flex justify-between items-center bg-gradient-to-b from-black/50 to-transparent">
          <button onclick="window.goBackFromFeed()" class="text-white text-2xl"><i class="fas fa-arrow-left"></i></button>
          <h1 class="text-xl font-bold text-white">Beranda</h1>
          <button id="upload-video-btn" onclick="window.showUploadModal()" class="text-white bg-yellow-400 p-2 rounded-full hidden"><i class="fas fa-cloud-upload-alt"></i></button>
        </div>

        <div id="video-feed-container" class="w-full h-full overflow-y-scroll snap-y snap-mandatory">
          </div>

        <div id="feed-bottom-nav" class="absolute bottom-0 w-full z-10 p-4 flex justify-around items-center bg-black/50">
          <button class="text-white text-3xl" onclick="window.showFeedPage('wali')"><i class="fas fa-home"></i></button>
          <button onclick="window.goBackFromFeed()" class="text-gray-400 text-3xl"><i class="fas fa-list"></i></button>
          <button onclick="window.showPage('jadwalDonasi')" class="text-gray-400 text-3xl"><i class="fas fa-mosque"></i></button>
        </div>

        <div id="upload-modal" class="hidden fixed inset-0 bg-black/80 z-50 items-center justify-center p-4">
            <div class="bg-panel-bg p-6 rounded-xl w-full max-w-md space-y-4">
                <h3 class="text-2xl font-bold text-yellow-400">Unggah Video Santri</h3>
                <form id="video-upload-form" class="space-y-4">
                    <input type="file" id="video-file" name="video" accept="video/mp4,video/mov,video/avi,video/webm" class="w-full text-theme p-3 futuristic-panel" required>
                    <p id="video-duration-status" class="text-sm text-red-500 hidden">Durasi maksimal 2 menit (120 detik).</p>
                    <div>
                        <label for="video-caption" class="block text-sm font-medium text-theme">Judul/Deskripsi</label>
                        <textarea id="video-caption" class="w-full mt-1 p-3 futuristic-panel" rows="3" placeholder="Contoh: Setoran hafalan terbaik hari ini"></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="document.getElementById('upload-modal').classList.add('hidden')" class="px-4 py-2 bg-gray-500 text-white rounded-md">Batal</button>
                        <button type="submit" id="upload-submit-btn" class="px-4 py-2 bg-yellow-400 text-black rounded-md disabled:bg-gray-400" disabled>Unggah</button>
                    </div>
                </form>
            </div>
        </div>
      </div>  
    <script type="module">
    const pages = {
        roleSelection: document.getElementById('role-selection-page'),
        pondokRegister: document.getElementById('pondok-register-page'),
        pondokLogin: document.getElementById('pondok-login-page'),
        accessCode: document.getElementById('access-code-page'),
        waliDashboard: document.getElementById('wali-dashboard-page'),
        detailSantri: document.getElementById('detail-santri-page'),
        guruDashboard: document.getElementById('guru-dashboard-page'),
        guruForm: document.getElementById('guru-form-page'),
        guruManagement: document.getElementById('guru-management-page'),
        jadwalDonasi: document.getElementById('jadwal-donasi-page'),
        menghafal: document.getElementById('menghafal-page'),
        about: document.getElementById('about-page'),
        feed: document.getElementById('feed-page'), // Halaman BARU
    };
    let appDataCache = {};
    let loginContext = null;
    let alarmInterval = null;
    let prayerTimesToday = {};
    let myChart = null;
    
    // --- Semua Fungsi-Fungsi Aplikasi Anda ---
    
    window.showPage = function(pageName) {
        Object.values(pages).forEach(page => {
            if (page) {
                page.classList.add('hidden');
                page.classList.remove('flex');
            }
        });
        if (pages[pageName]) {
            pages[pageName].classList.remove('hidden');
            pages[pageName].classList.add('flex');
        }
    }
    window.showHomePage = function() {
        showPage('roleSelection');
    }

    window.checkLoginState = function() {
        const role = sessionStorage.getItem('role');
        const pondokDbId = sessionStorage.getItem('currentPondokId');
        if (role && pondokDbId) {
            if (role === 'guru') {
                renderGuruDashboard();
                showPage('guruDashboard');
            } else if (role === 'wali') {
                renderWaliDashboard();
                showPage('waliDashboard');
            }
        } else {
            showPage('roleSelection');
        }
    }

    window.goBackFromJadwal = function() {
        const role = sessionStorage.getItem('role');
        if (role === 'guru') {
            backToGuruDashboard();
        } else if (role === 'wali') {
            backToWaliDashboard();
        } else {
            showPage('roleSelection');
        }
    }

    window.backToWaliDashboard = function() {
        renderWaliDashboard();
        showPage('waliDashboard');
    }

    window.backToGuruDashboard = function() {
        renderGuruDashboard();
        showPage('guruDashboard');
    }

    // --- FUNGSI BERANDA (FEED) BARU DIMULAI ---
    
    window.showFeedPage = function(role) {
        window.showPage('feed');
        window.renderVideoFeed(role);
    }

    window.goBackFromFeed = function() {
        const role = sessionStorage.getItem('role');
        if (role === 'guru') {
            window.backToGuruDashboard();
        } else if (role === 'wali') {
            window.backToWaliDashboard();
        } else {
            window.showPage('roleSelection');
        }
    }

    window.showUploadModal = function() {
        document.getElementById('upload-modal').classList.remove('hidden');
        document.getElementById('upload-modal').classList.add('flex');
        document.getElementById('video-upload-form').reset();
        document.getElementById('video-duration-status').classList.add('hidden');
        document.getElementById('upload-submit-btn').disabled = true;
    }

    window.renderVideoFeed = async function(role) {
        const container = document.getElementById('video-feed-container');
        const uploadBtn = document.getElementById('upload-video-btn');
        const navBottom = document.getElementById('feed-bottom-nav');
        container.innerHTML = '<div class="text-white text-center p-10">Memuat Feed Video...</div>';

        // Show/Hide upload button based on role
        if (role === 'guru') {
            uploadBtn.classList.remove('hidden');
            navBottom.classList.add('hidden'); // Guru doesn't need the bottom nav
        } else {
            uploadBtn.classList.add('hidden');
            navBottom.classList.remove('hidden'); // Wali uses the bottom nav
        }
        // --- GANTI BLOK FAKE DATA LAMA DENGAN KODE BARU INI ---
    let videos = [];
    const pondokId = sessionStorage.getItem('currentPondokId');

    try {
        const response = await fetch('/api/get-feed', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pondokDbId: pondokId })
        });
        const result = await response.json();
        if (result.success && result.videos) {
            videos = result.videos; // Ambil data video dari backend
            window.showToast('success', 'Feed video berhasil dimuat dari server!');
        } else {
             // Jika gagal, tampilkan pesan error
             container.innerHTML = `<div class="text-white text-center p-10">Gagal memuat feed: ${result.message || 'Server error.'}</div>`;
             return;
        }
    } catch (error) {
        container.innerHTML = `<div class="text-white text-center p-10">Error koneksi: Tidak dapat terhubung ke server feed.</div>`;
        return;
    }
    
    // Jika tidak ada video, tampilkan pesan
    if (videos.length === 0) {
        container.innerHTML = '<div class="text-white text-center p-10">Belum ada unggahan video di pondok ini.</div>';
        return;
    }
        // Render video cards
        container.innerHTML = videos.map(v => `
            <div class="video-card w-full h-full snap-center relative flex items-center justify-center">
                <video id="video-${v.id}" class="w-full h-full object-cover" src="${v.mediaUrl}" loop muted playsinline 
                       onclick="this.paused ? this.play() : this.pause()" poster="https://placehold.co/400x700/000/fff?text=Loading+Video">
                <source src="${v.mediaUrl}" type="video/mp4">
                </video>

                <div class="absolute bottom-20 left-0 p-4 text-white z-20 w-full bg-gradient-to-t from-black/80 to-transparent">
                    <p class="font-bold">${v.author} <span class="text-sm font-normal">(${v.authorRole})</span></p>
                    <p class="text-sm">${v.text}</p>
                    <p class="text-xs text-gray-300">${v.time}</p>
                </div>

                <div class="absolute right-0 bottom-20 p-4 flex flex-col space-y-6 text-white text-center z-20">
                    <div class="flex flex-col items-center cursor-pointer" onclick="window.likePost(${v.id}, 'video')">
                        <i class="fas fa-heart text-3xl transition-colors duration-200 hover:text-red-500"></i>
                        <span class="text-xs">${v.likes}</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer" onclick="window.showCommentModal(${v.id})">
                        <i class="fas fa-comment-dots text-3xl transition-colors duration-200 hover:text-yellow-400"></i>
                        <span class="text-xs">${v.comments}</span>
                    </div>
                    <div class="flex flex-col items-center cursor-pointer" onclick="window.sharePost(${v.id}, '${v.mediaUrl}')">
                        <i class="fas fa-share text-3xl transition-colors duration-200 hover:text-green-400"></i>
                        <span class="text-xs">Bagikan</span>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Logic to play/pause video on scroll
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                const video = entry.target;
                if (entry.isIntersecting) {
                    video.play().catch(e => console.log("Video playback blocked."));
                } else {
                    video.pause();
                }
            });
        }, { threshold: 0.75 }); // 75% of video must be visible

        container.querySelectorAll('video').forEach(video => {
            observer.observe(video);
            // Ensure video starts playing when feed loads (for first video)
            if (video.id === 'video-1') { 
                video.play().catch(e => console.log("Video playback blocked."));
            }
        });
    }

    // --- Video Interaction Stubs (Wali Santri) ---

    window.likePost = async function(postId, type) {
    window.showToast('info', `Menyukai Post ID ${postId}...`);

    try {
        const response = await fetch('/api/like-post', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ postId: postId })
        });
        const result = await response.json();

        if (result.success) {
            window.showToast('success', 'Postingan disukai!');
            
            // --- LOGIKA PEMBARUAN JUMLAH LIKE DI TAMPILAN (FRONTEND) ---
            const likeCountElement = document.getElementById(`like-count-${postId}`);
            if (likeCountElement) {
                // Konversi ke angka, tambahkan 1, lalu set kembali
                let currentLikes = parseInt(likeCountElement.textContent) || 0;
                likeCountElement.textContent = currentLikes + 1;
            }
            // -----------------------------------------------------------

        } else {
            window.showToast('error', `Gagal menyukai postingan: ${result.message}`);
        }
    } catch (error) {
        console.error('Error liking post:', error);
        window.showToast('error', 'Koneksi gagal saat mencoba menyukai postingan.');
    }
};
	window.updateCommentCount = function(postId) {
    const countElement = document.getElementById(`comment-count-${postId}`);
    if (countElement) {
        let currentCount = parseInt(countElement.textContent) || 0;
        countElement.textContent = currentCount + 1;
    }
}
    window.showCommentModal = async function(postId) {
    const post = appDataCache.posts.find(p => p.id === postId);
    if (!post) return;

    // 1. Ambil data komentar dari backend (kita gunakan /api/get-data, tapi filter di frontend)
    // Sebaiknya buat endpoint khusus get-comments-by-post-id di backend di masa depan.
    const allComments = (await window.fetchData()).allComments || [];
    const postComments = allComments.filter(c => c.post_id === postId);

    // Fungsi utilitas untuk memformat komentar
    const formatComment = (comment) => `
        <div class="p-2 border-b border-gray-700/50">
            <span class="font-semibold text-sm text-yellow-300">${comment.author}</span>
            <p class="text-white text-sm mt-1">${comment.text}</p>
        </div>
    `;

    // Buat konten komentar yang sudah ada
    const commentsHtml = postComments.map(formatComment).join('') || 
                         '<div class="text-center text-gray-500 py-4">Belum ada komentar.</div>';

    // 2. Tampilkan Modal Komentar
    window.showModal(
        `Komentar: ${post.author}`,
        `
        <div id="comments-container" class="max-h-80 overflow-y-auto mb-4 bg-gray-800 rounded p-2">
            ${commentsHtml}
        </div>
        <form id="comment-form-${postId}" class="mt-4">
            <input type="hidden" name="postId" value="${postId}">
            <textarea name="text" rows="2" placeholder="Tulis komentar..." class="w-full p-2 bg-gray-700 text-white rounded focus:ring-yellow-500 focus:border-yellow-500 border border-gray-600"></textarea>
            <button type="submit" class="w-full mt-2 futuristic-panel bg-yellow-600 hover:bg-yellow-700 text-white py-2 rounded-lg font-semibold transition duration-300">
                Kirim Komentar
            </button>
        </form>
        `
    );
	
    // 3. Tambahkan Event Listener untuk Kirim Komentar
    document.getElementById(`comment-form-${postId}`).addEventListener('submit', async function(e) {
        e.preventDefault();
        const commentText = this.elements['text'].value.trim();
        const currentRole = sessionStorage.getItem('currentRole');
        const currentUserName = currentRole === 'guru' ? sessionStorage.getItem('currentGuruName') : 'Wali Santri';
        
        if (!commentText || !currentUserName) {
            window.showToast('error', 'Komentar atau nama pengguna tidak valid.');
            return;
        }

        const commentData = {
            author: currentUserName,
            text: commentText
        };

        try {
            const response = await fetch('/api/add-comment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ postId: postId, commentData: commentData })
            });
            const result = await response.json();

            if (result.success) {
                window.showToast('success', 'Komentar berhasil dikirim!');
                this.elements['text'].value = ''; // Kosongkan input

                // Tambahkan komentar baru secara instan ke modal (tanpa reload)
                const newComment = { 
                    author: commentData.author, 
                    text: commentData.text 
                };
                document.getElementById('comments-container').insertAdjacentHTML('beforeend', formatComment(newComment));
                
                // Tambahkan jumlah komentar di feed
                window.updateCommentCount(postId);

            } else {
                window.showToast('error', `Gagal mengirim komentar: ${result.message}`);
            }
        } catch (error) {
            window.showToast('error', 'Koneksi gagal saat mengirim komentar.');
        }
    });
};

    window.sharePost = function(postId, mediaUrl) {
        if (navigator.share) {
            navigator.share({
                title: 'SantriQ Video Feed',
                text: `Lihat video keren ini dari SantriQ: ${mediaUrl}`,
                url: window.location.href, // Gunakan URL aplikasi saat ini
            }).then(() => {
                window.showToast('success', 'Berbagi berhasil!');
            }).catch((error) => {
                window.showToast('error', `Gagal berbagi: ${error.message}`);
            });
        } else {
            window.showToast('info', 'API Share tidak didukung. Silakan salin URL video.');
        }
    }

    // --- FUNGSI ASLI YANG SUDAH ADA (DIMODIFIKASI UNTUK UPLOAD FILE) ---

    window.showToast = function(type, message) {
        const toastContainer = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `p-4 mb-3 rounded-lg shadow-xl text-white transform transition-all duration-300 translate-x-full opacity-0`;
        
        let bgColor = '';
        if (type === 'success') {
            bgColor = 'bg-green-500';
        } else if (type === 'error') {
            bgColor = 'bg-red-500';
        } else if (type === 'info') {
            bgColor = 'bg-blue-500';
        } else if (type === 'notification') {
            bgColor = 'bg-yellow-400';
        }
        
        toast.classList.add(bgColor);
        toast.innerHTML = `<div class="flex items-center"><div class="flex-shrink-0"><i class="fa-solid ${type === 'success' ? 'fa-check-circle' : 'fa-info-circle'} mr-2"></i></div><div><p class="font-bold">${message}</p></div></div>`;
        toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.classList.remove('translate-x-full', 'opacity-0');
            toast.classList.add('translate-x-0', 'opacity-100');
        }, 100);

        setTimeout(() => {
            toast.classList.remove('translate-x-0', 'opacity-100');
            toast.classList.add('translate-x-full', 'opacity-0');
            toast.addEventListener('transitionend', () => toast.remove());
        }, 5000);
    }

    window.copyAccessCode = function() {
        const codeEl = document.getElementById('unique-access-code');
        const range = document.createRange();
        range.selectNode(codeEl);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('success', 'Kode akses berhasil disalin!');
            }
        } catch (err) {
            console.error('Failed to copy text:', err);
            showToast('error', "Gagal menyalin kode. Silakan salin manual: " + codeEl.textContent);
        }
        window.getSelection().removeAllRanges();
    }

    window.copyDonationNumber = function() {
        const numberEl = document.getElementById('donation-number');
        const range = document.createRange();
        range.selectNode(numberEl);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                showToast('success', 'Nomor telepon berhasil disalin!');
            }
        } catch (err) {
            console.error('Failed to copy text:', err);
            showToast('error', "Gagal menyalin nomor. Silakan salin manual: " + numberEl.textContent);
        }
        window.getSelection().removeAllRanges();
    }

    window.fetchData = async function() {
        const pondokDbId = sessionStorage.getItem('currentPondokId');
        if (!pondokDbId) return null;
        if (appDataCache[pondokDbId]) {
            return appDataCache[pondokDbId];
        }
        try {
            const response = await fetch('/api/get-data', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ pondokDbId: pondokDbId })
            });
            const result = await response.json();
            if (result.success) {
                appDataCache[pondokDbId] = result.data;
                return appDataCache[pondokDbId];
            } else {
                console.error("Gagal mengambil data dari server:", result.message);
                return null;
            }
        } catch (error) {
            console.error("Gagal mengirim data ke server:", error);
            return null;
        }
    }

    window.saveData = async function(endpoint, payload) {
        const currentPondokId = sessionStorage.getItem('currentPondokId');
        if (!currentPondokId) {
            showToast('error', "Sesi login berakhir. Silakan login kembali.");
            logout();
            return false;
        }
        try {
            const response = await fetch(endpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            if (result.success) {
                appDataCache = {};
                // Play a success sound for the guru when data is saved
                const successDing = document.getElementById('success-ding');
                if (successDing) {
                    successDing.play().catch(e => console.error("Error playing success sound:", e));
                }
                return true;
            } else {
                console.error("Gagal menyimpan data:", result.message);
                showToast('error', "Gagal menyimpan data: " + result.message);
                return false;
            }
        } catch (error) {
            console.error("Gagal mengirim data ke server:", error);
            showToast('error', "Error koneksi ke server.");
            return false;
        }
    }

    // FUNGSI INI DITINGKATKAN
    window.uploadFile = async function(file) {
        const formData = new FormData();
        formData.append('file', file);
        try {
            // Endpoint diubah dari /unggah menjadi /api/upload-file
            const response = await fetch('/api/upload-file', {
                method: 'POST',
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                return result.file_url;
            } else {
                showToast('error', 'Gagal mengunggah foto: ' + result.message);
                return null;
            }
        } catch (error) {
            showToast('error', 'Error koneksi saat mengunggah foto.');
            return null;
        }
    }

    window.requestNotificationPermission = function() {
        if (!("Notification" in window)) {
            console.log("Browser ini tidak mendukung notifikasi desktop");
        } else if (Notification.permission === "granted") {
            console.log("Izin notifikasi sudah diberikan.");
        } else if (Notification.permission !== "denied") {
            Notification.requestPermission().then(function (permission) {
                if (permission === "granted") {
                    showToast('info', "Notifikasi diaktifkan!");
                }
            });
        }
    }

    window.sendNotification = function(title, body) {
        if (Notification.permission === "granted") {
            const options = {
                body: body,
                icon: 'https://placehold.co/64x64/2a9d8f/ffffff?text=SQ'
            };
            const notification = new Notification(title, options);
            notification.onclick = function(event) {
                event.preventDefault();
                window.focus();
            }
        } else {
            console.log("Izin notifikasi tidak diberikan.");
        }
    }

    window.sendNotificationToGuardian = function(santriName, setoran, penilaian) {
        sendNotification("Update Hafalan Santri", `${santriName} telah selesai menyetorkan hafalannya. Setoran: ${setoran}. Penilaian: ${penilaian}.`);
    }

    window.handleRoleSelection = function(role) {
        loginContext = role;
        if (role === 'wali') {
            showPage('accessCode');
        } else if (role === 'guru') {
            showPage('pondokLogin');
        }
    }

    window.logout = function() {
        sessionStorage.clear();
        loginContext = null;
        const accessCodeInput = document.getElementById('access-code');
        if (accessCodeInput) {
            accessCodeInput.value = '';
        }
        const pondokLoginForm = document.getElementById('pondok-login-form');
        if (pondokLoginForm) {
            pondokLoginForm.reset();
        }
        showPage('roleSelection');
    }

    window.renderWaliDashboard = async function() {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) return;
        const kelasListContainer = document.getElementById('kelas-list-container');
        const santriListContainer = document.getElementById('santri-list-container');
        if (kelasListContainer) kelasListContainer.classList.remove('hidden');
        if (santriListContainer) santriListContainer.classList.add('hidden');
        const kelasGrid = document.getElementById('kelas-grid');
        if (!kelasGrid) return;
        kelasGrid.innerHTML = '';
        
        const uniqueKelas = [...new Set(pondokData.santri.map(s => s.kelas))].sort();
        uniqueKelas.forEach(kelas => {
            const card = document.createElement('div');
            card.className = 'text-center cursor-pointer p-6 rounded-lg shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 futuristic-panel';
            card.innerHTML = `<div class="flex items-center justify-center mb-4 text-4xl text-yellow-400"><i class="fas fa-mosque"></i></div><h3 class="text-xl font-bold text-yellow-400">Kelas ${kelas}</h3><p class="text-sm text-theme-secondary mt-2">Lihat daftar santri</p>`;
            card.onclick = () => window.showSantriListByKelas(kelas);
            kelasGrid.appendChild(card);
        });
    }
        
    window.showSantriDetail = async function(santriId) {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) {
            console.error("Gagal memuat data pondok.");
            showPage('waliDashboard');
            showToast('error', "Gagal memuat detail santri. Silakan coba lagi.");
            return;
        }
        
        const santri = pondokData.santri.find(s => s.id === santriId);
        if (!santri) {
            console.error("Santri tidak ditemukan di data.");
            showPage('waliDashboard');
            showToast('error', "Santri tidak ditemukan.");
            return;
        }
        
        sessionStorage.setItem('currentWaliKelas', santri.kelas);
        const guru = pondokData.guru.find(g => g.mengajar_kelas === santri.kelas);
        const allHafalan = pondokData.hafalan
            .filter(h => h.santri_id === santriId)
            .sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal)); // Urutkan berdasarkan tanggal
        
        document.getElementById('detail-foto').src = santri.foto || 'https://placehold.co/400x400?text=No+Photo';
        document.getElementById('detail-nama').textContent = santri.nama;
        document.getElementById('detail-kelas').textContent = `Kelas ${santri.kelas}`;
        document.getElementById('detail-pengajar').textContent = guru ? `Pengajar: ${guru.nama}` : 'Pengajar belum diatur';
        
        const statusEl = document.getElementById('detail-status-target');
        if (santri.tercapai) {
            statusEl.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-green-100 text-green-800';
            statusEl.innerHTML = `✅ Mencapai Target`;
        } else {
            statusEl.className = 'mt-4 inline-flex items-center px-4 py-2 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800';
            statusEl.innerHTML = `⚠️ Belum Mencapai Target`;
        }
        
        const target = santri.target || {};
        document.getElementById('total-hafalan-juz').textContent = santri.total_hafalan_juz || '-';
        document.getElementById('target-harian').textContent = target.harian || '-';
        document.getElementById('target-mingguan').textContent = target.mingguan || '-';
        document.getElementById('target-bulanan').textContent = target.bulanan || '-';
        document.getElementById('target-tahunan').textContent = target.tahunan || '-';
        
        // --- LOGIKA PERHITUNGAN GRAFIK DINAMIS ---
        
        // 1. Kumpulkan semua tanggal unik yang ada di riwayat hafalan
        const uniqueDates = [...new Set(allHafalan.map(h => h.tanggal))].sort();
        
        // 2. Tentukan skor awal
        let scoreHafalanBaru = 0;
        let scoreMurojaah = 0;
        
        // 3. Hitung data untuk setiap tanggal
        const dataHarian = uniqueDates.map(date => {
            const recordsToday = allHafalan.filter(h => h.tanggal === date);
            let dailyScoreNew = 0;
            let dailyScoreMur = 0;

            recordsToday.forEach(h => {
                const score = h.penilaian === 'Lancar' ? 1 : -1;
                if (h.jenis === 'Hafalan Baru') {
                    dailyScoreNew += score;
                } else if (h.jenis === 'Muroja\'ah') {
                    dailyScoreMur += score;
                }
            });

            // Terapkan kenaikan/penurunan skor kumulatif
            scoreHafalanBaru += dailyScoreNew;
            scoreMurojaah += dailyScoreMur;

            // Hitung skor bulanan untuk data Target
            // Ambil nilai target bulanan (contoh: "1 Juz") dan konversi ke angka jika bisa
            let targetBulananValue = 0;
            if (target.bulanan && target.bulanan.toLowerCase().includes('juz')) {
                targetBulananValue = parseFloat(target.bulanan.match(/\d+(\.\d+)?/));
                if(isNaN(targetBulananValue)) targetBulananValue = 0;
            } else {
                 // Jika formatnya bukan Juz, asumsikan angka biasa
                targetBulananValue = parseFloat(target.bulanan) || 0;
            }
            
            // Logika Target Bulanan: Naik jika tercapai, turun jika tidak (Sederhana)
            // Catatan: Karena kita tidak punya data 'kapan' target bulanan dievaluasi, 
            // kita hanya bisa mencerminkan status 'tercapai' saat ini di sepanjang grafik.
            // Untuk simulasi dinamis, kita akan buat Target Bulanan sebagai garis rata-rata.
            const isTargetAchievedToday = santri.tercapai; // Status target saat ini (Sederhana)

            return {
                date: date,
                newHafalanScore: scoreHafalanBaru,
                murojaahScore: scoreMurojaah,
                monthlyTargetStatus: isTargetAchievedToday ? 10 : 0 // Representasi visual target
            };
        });
        
        const labels = dataHarian.map(d => new Date(d.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' }));
        const dataNewHafalan = dataHarian.map(d => d.newHafalanScore);
        const dataMurojaah = dataHarian.map(d => d.murojaahScore);

        // Logika Target Bulanan: Naik jika status saat ini 'tercapai', turun jika 'tidak tercapai'.
        // Catatan: Karena Target Bulanan biasanya dievaluasi sebulan sekali, di sini kita buat garis lurus
        // yang mencerminkan status performa santri saat ini (tercapai: 10, tidak tercapai: 0)
        const dataMonthlyTarget = dataHarian.map((d, i) => {
            // Untuk simulasi tren, kita bisa ambil status 'tercapai' dan menjadikannya nilai konstan.
            // Jika ingin dinamis, kita perlu data historis status 'tercapai'.
            // Untuk sementara, kita gunakan nilai '10' dan '0' untuk memvisualisasikan status.
            return santri.tercapai ? 10 : -5; 
        });


        // Destroy old chart if it exists
        const existingChart = Chart.getChart("hafalan-progres-chart");
        if (existingChart) {
            existingChart.destroy();
        }
        
        const chartCtx = document.getElementById('hafalan-progres-chart');
        if (chartCtx) {
            // Konfigurasi Warna untuk Light/Dark Mode
            const isDark = document.body.classList.contains('dark-mode');
            const colorNewHafalan = '#72A0C1'; // Biru Langit
            const colorMurojaah = '#DC2626'; // Merah (Red-600)
            const colorMonthlyTarget = isDark ? '#6B7280' : '#4B5563'; // Abu-abu Tua
            const gridColor = getComputedStyle(document.body).getPropertyValue('--graph-grid-color');
            const textColor = getComputedStyle(document.body).getPropertyValue('--graph-text-color');

            myChart = new Chart(chartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Setoran Hafalan Baru (Skor Akumulatif)',
                            data: dataNewHafalan,
                            borderColor: colorNewHafalan,
                            backgroundColor: 'rgba(114, 160, 193, 0.3)', // Isi Biru Langit transparan
                            fill: true,
                            tension: 0.2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Muroja\'ah (Skor Akumulatif)',
                            data: dataMurojaah,
                            borderColor: colorMurojaah,
                            backgroundColor: 'rgba(220, 38, 38, 0.3)', // Isi Merah transparan
                            fill: true,
                            tension: 0.2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                            borderWidth: 3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Status Target Bulanan (Naik/Turun)',
                            data: dataMonthlyTarget,
                            borderColor: colorMonthlyTarget,
                            backgroundColor: 'transparent',
                            fill: false,
                            borderDash: [10, 5], // Garis putus-putus
                            tension: 0, // Garis lurus
                            pointRadius: 0,
                            borderWidth: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => {
                                    return `Tanggal: ${context[0].label}`;
                                },
                                label: (context) => {
                                    let label = context.dataset.label || '';
                                    if (label.includes('Setoran')) {
                                        label += `: ${context.raw}`;
                                    } else if (label.includes('Target')) {
                                        label = `Status Target: ${santri.tercapai ? 'Mencapai' : 'Belum Mencapai'}`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Tanggal Setoran',
                                color: textColor
                            },
                            ticks: {
                                color: textColor,
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: gridColor
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Skor Progres Akumulatif (Lancar: +1, Perlu Diulang: -1)',
                                color: textColor
                            },
                            ticks: {
                                color: textColor,
                                stepSize: 1
                            },
                            grid: {
                                color: gridColor
                            }
                        }
                    }
                }
            });
        }


        
        const historyBody = document.getElementById('hafalan-history');
        if (historyBody) {
            historyBody.innerHTML = '';
            if (allHafalan.length > 0) {
                allHafalan.forEach(h => {
                    const row = historyBody.insertRow();
                    row.innerHTML = `<td class="py-4 px-6 text-sm text-theme">${new Date(h.tanggal).toLocaleDateString('id-ID')}</td><td class="py-4 px-6 text-sm text-theme font-medium">${h.setoran}</td><td class="py-4 px-6 text-sm text-theme-secondary">${h.jenis}</td><td class="py-4 px-6 text-sm"><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${h.penilaian === 'Lancar' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${h.penilaian}</span></td>`;
                });
            } else {
                historyBody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-theme-secondary">Belum ada riwayat setoran.</td></tr>';
            }
        }
        showPage('detailSantri');
    }

    window.renderGuruDashboard = async function() {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) return;
        const uniqueAccessCodeElement = document.getElementById('unique-access-code');
        if (uniqueAccessCodeElement) {
            uniqueAccessCodeElement.textContent = pondokData.uniqueAccessCode || 'Tidak ada kode';
        }
        const whatsappLinkElement = document.getElementById('whatsapp-link');
        if (whatsappLinkElement) {
            whatsappLinkElement.href = `https://wa.me/?text=${encodeURIComponent('Halo, wali santri! Berikut adalah kode akses unik untuk monitoring hafalan anak Anda: ' + pondokData.uniqueAccessCode)}`;
        }
        const listContainer = document.getElementById('guru-santri-list');
        if (listContainer) {
            listContainer.innerHTML = '';
            pondokData.santri.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(santri => {
                const fotoUrl = santri.foto || 'https://placehold.co/400x400?text=No+Photo';
                const card = document.createElement('div');
                card.className = 'text-center cursor-pointer group santri-card futuristic-panel p-4 rounded-lg shadow-md';
                card.onclick = () => window.showGuruForm(`${santri.id}`);
                card.innerHTML = `
                    <div class="relative">
                        <img src="${fotoUrl}" alt="Foto ${santri.nama}" class="w-full h-auto aspect-square rounded-full object-cover transition-transform duration-300 group-hover:scale-105 border-4 border-yellow-400 shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';">
                    </div>
                    <p class="mt-4 font-semibold text-theme">${santri.nama}</p>
                    <p class="text-sm text-theme-secondary">${santri.kelas}</p>
                    <div class="flex space-x-2 mt-4 justify-center">
                        <button onclick="event.stopPropagation(); window.showGuruForm('${santri.id}')" class="px-2 py-1 text-xs font-semibold text-black bg-yellow-400 rounded-md hover:bg-yellow-500">Ubah Data</button>
                        <button onclick="event.stopPropagation(); window.deleteSantri('${santri.id}')" class="px-2 py-1 text-xs font-semibold text-white bg-red-600 rounded-md hover:bg-red-700">Hapus</button>
                    </div>
                `;
                listContainer.appendChild(card);
            });
        }
    }

    window.showGuruForm = async function(santriIdString) {
        const santriId = santriIdString === 'null' ? null : parseInt(santriIdString);
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.santri) {
            console.error("Data pondok tidak ditemukan atau tidak memiliki properti 'santri'.");
            showToast('error', "Gagal memuat data santri. Silakan coba lagi.");
            return;
        }
        const form = document.getElementById('santri-form');
        if (form) form.reset();
        const hafalanSection = document.getElementById('hafalan-management-section');
        if (hafalanSection) hafalanSection.classList.add('hidden');
        const santriIdInput = document.getElementById('santri-id');
        if (santriIdInput) santriIdInput.value = santriId || '';
        const fotoStatus = document.getElementById('foto-status');

        if (santriId) {
            const santri = pondokData.santri.find(s => s.id === santriId);
            if (!santri) {
                console.error(`Santri dengan ID ${santriId} tidak ditemukan.`);
                showToast('error', "Santri tidak ditemukan.");
                return;
            }
            const formTitle = document.getElementById('form-title');
            if (formTitle) formTitle.textContent = `Ubah Data: ${santri.nama}`;
            const namaInput = document.getElementById('nama');
            if (namaInput) namaInput.value = santri.nama;
            const kelasSelect = document.getElementById('kelas');
            if (kelasSelect) kelasSelect.value = santri.kelas;
            
            const currentPhotoUrl = document.getElementById('current-photo-url');
            if (currentPhotoUrl) currentPhotoUrl.value = santri.foto || '';
            if (fotoStatus) fotoStatus.textContent = santri.foto ? 'Foto sudah ada, tidak perlu diunggah lagi.' : 'Belum ada foto. Unggah sekarang.';

            const target = santri.target || {};
            const totalHafalanJuzInput = document.getElementById('total-hafalan-juz-guru');
            if (totalHafalanJuzInput) totalHafalanJuzInput.value = santri.total_hafalan_juz || '';
            const formTargetHarian = document.getElementById('form-target-harian');
            if (formTargetHarian) formTargetHarian.value = target.harian || '';
            const formTargetMingguan = document.getElementById('form-target-mingguan');
            if (formTargetMingguan) formTargetMingguan.value = target.mingguan || '';
            const formTargetBulanan = document.getElementById('form-target-bulanan');
            if (formTargetBulanan) formTargetBulanan.value = target.bulanan || '-';
            const formTargetTahunan = document.getElementById('form-target-tahunan');
            if (formTargetTahunan) formTargetTahunan.value = target.tahunan || '-';
            
            // Set radio button status
            const tercapaiRadio = document.querySelector(`input[name="tercapai"][value="${santri.tercapai === true}"]`);
            if (tercapaiRadio) {
                tercapaiRadio.checked = true;
            } else {
                // Set default if value is undefined/null
                const defaultRadio = document.querySelector(`input[name="tercapai"][value="false"]`);
                if (defaultRadio) defaultRadio.checked = true;
            }

            if (hafalanSection) hafalanSection.classList.remove('hidden');
            window.renderGuruHafalanTable(santriId);
        } else {
            const formTitle = document.getElementById('form-title');
            if (formTitle) formTitle.textContent = 'Tambah Santri Baru';
            if (fotoStatus) fotoStatus.textContent = 'Unggah foto baru untuk santri ini.';
            const totalHafalanJuzInput = document.getElementById('total-hafalan-juz-guru');
            if (totalHafalanJuzInput) totalHafalanJuzInput.value = '';
            // Set default radio button for new santri
            const defaultRadio = document.querySelector(`input[name="tercapai"][value="false"]`);
            if (defaultRadio) defaultRadio.checked = true;
        }
        showPage('guruForm');
    }

    window.deleteSantri = async function(santriIdString) {
        const santriId = parseInt(santriIdString);
        if (!confirm('Apakah Anda yakin ingin menghapus data santri ini? Semua data hafalan yang terkait juga akan dihapus.')) {
            return;
        }
        const saveSuccess = await saveData('/api/delete-santri', { santriId });
        if (saveSuccess) {
            showToast('success', 'Data santri berhasil dihapus!');
            window.renderGuruDashboard();
        } else {
            showToast('error', "Gagal menghapus data di server.");
        }
    }

    window.showGuruManagementPage = async function() {
        const guruForm = document.getElementById('guru-form');
        if (guruForm) guruForm.reset();
        const guruIdInput = document.getElementById('guru-id');
        if (guruIdInput) guruIdInput.value = '';
        await window.renderGuruList();
        showPage('guruManagement');
    }

    window.renderGuruList = async function() {
        const pondokData = await fetchData();
        if (!pondokData || !pondokData.guru) return;
        const tableBody = document.getElementById('guru-list-table');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        pondokData.guru.sort((a, b) => a.nama.localeCompare(b.nama)).forEach(guru => {
            const row = tableBody.insertRow();
            row.innerHTML = `<td class="py-4 px-6 text-sm font-medium text-theme">${guru.nama}</td><td class="py-4 px-6 text-sm text-theme-secondary">${guru.mengajar_kelas}</td><td class="py-4 px-6 text-sm font-medium space-x-2"><button onclick="window.editGuru('${guru.id}')" class="text-yellow-400 hover:text-yellow-500">Ubah</button><button onclick="window.deleteGuru('${guru.id}')" class="text-red-600 hover:text-red-700">Hapus</button></td>`;
        });
    }

    // Tambahkan kode fungsi-fungsi ini di sini
    window.togglePasswordVisibility = function(inputId, toggleButton) {
        const input = document.getElementById(inputId);
        const eyeIcon = `<i class="fas fa-eye text-theme-secondary"></i>`;
        const eyeSlashIcon = `<i class="fas fa-eye-slash text-theme-secondary"></i>`;
        if (input.type === "password") {
            input.type = "text";
            toggleButton.innerHTML = eyeSlashIcon;
        } else {
            input.type = "password";
            toggleButton.innerHTML = eyeIcon;
        }
    }
    window.showAboutPage = function() { showPage('about'); }
    window.playWelcomeAnimation = function() {
        const modal = document.getElementById('welcome-modal');
        const title = document.getElementById('welcome-title');
        const subtitle = document.getElementById('welcome-subtitle');
        const message = document.getElementById('welcome-message');

        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            if (title) {
                setTimeout(() => { title.classList.remove('-translate-y-10', 'opacity-0'); title.classList.add('translate-y-0', 'opacity-100'); }, 100);
            }
            if (subtitle) {
                setTimeout(() => { subtitle.classList.remove('translate-y-10', 'opacity-0'); subtitle.classList.add('translate-y-0', 'opacity-100'); }, 600);
            }
            if (message) {
                setTimeout(() => { message.classList.remove('translate-y-10', 'opacity-0'); message.classList.add('translate-y-0', 'opacity-100'); }, 1100);
            }
            
            setTimeout(() => { 
                modal.classList.add('hidden'); 
                showPage('roleSelection'); 
            }, 3000);
        } else {
            // If modal is not found, just show the role selection page
            showPage('roleSelection');
        }
    }
    window.showJadwalDonasiPage = function() { window.fetchJadwalSholat(); showPage('jadwalDonasi'); }
    window.getCoordinates = function() {
        return new Promise((resolve, reject) => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => resolve({ latitude: position.coords.latitude, longitude: position.coords.longitude }),
                    error => reject(error)
                );
            } else {
                reject(new Error("Geolocation is not supported by this browser."));
            }
        });
    }
	    window.fetchJadwalSholat = async function() {
	    const container = document.getElementById('jadwal-sholat-container');
	    const lokasiEl = document.getElementById('jadwal-lokasi');
	    if (!container || !lokasiEl) return;

	    container.innerHTML = `<div class="col-span-full text-center text-theme-secondary">Memuat...</div>`;
	    let latitude = -6.2088; // Default Jakarta
	    let longitude = 106.8456; // Default Jakarta
	    let locationName = "Jakarta, Indonesia";
	    // Format tanggal hari ini (DD-MM-YYYY)
	    const today = new Date();
	    const formattedDate = `${String(today.getDate()).padStart(2, '0')}-${String(today.getMonth() + 1).padStart(2, '0')}-${today.getFullYear()}`;
    
        try {
            // Mendapatkan Koordinat Lokasi
            const coords = await window.getCoordinates();
            latitude = coords.latitude;
            longitude = coords.longitude;
            
            // Mengubah Koordinat menjadi Nama Lokasi (API BigDataCloud)
            const geoNameResponse = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${latitude}&longitude=${longitude}&localityLanguage=id`);
            if (geoNameResponse.ok) {
                const geoNameData = await geoNameResponse.json();
                locationName = `${geoNameData.city || geoNameData.locality}, ${geoNameData.countryName}`;
            } else {
                locationName = "Lokasi Anda Saat Ini";
            }

            // MENGAMBIL JADWAL SHOLAT DARI ALADHAN API (Methode: Kemenag Indonesia=11)
            const prayerApiUrl = `https://api.aladhan.com/v1/timingsByCity/${formattedDate}?city=${locationName.split(',')[0]}&country=${locationName.split(',')[1]}&method=11`;
            const prayerResponse = await fetch(prayerApiUrl);
            const prayerData = await prayerResponse.json();
            
            if (prayerData.code === 200) {
                const timings = prayerData.data.timings;
                // Filter dan simpan waktu salat yang relevan ke variabel global
                prayerTimesToday = {
                    Fajr: timings.Fajr,
                    Dhuhr: timings.Dhuhr,
                    Asr: timings.Asr,
                    Maghrib: timings.Maghrib,
                    Isha: timings.Isha
                };

                // Menampilkan Jadwal ke UI
                lokasiEl.textContent = `Jadwal Solat di: ${locationName}`;
                container.innerHTML = ''; // Bersihkan kontainer
                
                const prayerNames = { Fajr: "Subuh", Dhuhr: "Zuhur", Asr: "Asar", Maghrib: "Magrib", Isha: "Isya", Sunrise: "Terbit" };
                
                // Urutan waktu yang ingin ditampilkan di UI
                const displayOrder = ['Fajr', 'Sunrise', 'Dhuhr', 'Asr', 'Maghrib', 'Isha'];

                displayOrder.forEach(key => {
                    const timeValue = timings[key];
                    if (timeValue) {
                        container.innerHTML += `
                            <div class="futuristic-panel p-4 rounded-lg shadow-sm">
                                <p class="text-lg font-semibold text-yellow-400">${prayerNames[key]}</p>
                                <p class="text-3xl font-bold text-theme">${timeValue}</p>
                            </div>
                        `;
                    }
                });
	    
	            window.setupPrayerAlarm(); // Mulai alarm setelah data didapat
	            
	        } else {
	            lokasiEl.textContent = `Jadwal Solat: Gagal memuat data waktu salat.`;
	            container.innerHTML = `<div class="col-span-full text-center text-red-500">Gagal memuat jadwal solat dari API eksternal.</div>`;
	        }
	        
	    } catch (error) {
	        container.innerHTML = `<div class="col-span-full text-center text-red-500">Gagal memuat jadwal solat. Pastikan Anda mempunyai sambungan internet.</div>`;
	        console.error("Error fetching prayer times:", error);
	    }
	}
    window.handleAlarmToggleChange = function() {
        const isChecked = document.getElementById('alarm-toggle').checked;
        localStorage.setItem('alarmEnabled', isChecked);
        if (isChecked) {
            const audio = document.getElementById('azan-alarm');
            audio.play().then(() => audio.pause()).catch(e => console.log("User interaction needed to play audio."));
            window.setupPrayerAlarm();
            window.showToast('info', 'Alarm Azan diaktifkan. Notifikasi akan muncul saat waktu salat tiba.');
        } else {
            if (alarmInterval) clearInterval(alarmInterval);
            window.showToast('info', 'Alarm Azan dinonaktifkan.');
        }
    }
	    window.setupPrayerAlarm = function() {
        if (alarmInterval) clearInterval(alarmInterval);
        const alarmEnabled = localStorage.getItem('alarmEnabled') === 'true';
        if (!alarmEnabled) return;
        alarmInterval = setInterval(window.checkPrayerTimes, 30000);
	    }
	    window.checkPrayerTimes = function() {
	    const now = new Date();
	    // Gunakan format HH:MM (Contoh: 09:00)
	    const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
	    // Definisikan nama salat untuk dipanggil ke playAlarm
	    const prayerNames = { Fajr: "Subuh", Dhuhr: "Zuhur", Asr: "Asar", Maghrib: "Magrib", Isha: "Isya" };

	    // Cek setiap waktu salat yang telah tersimpan
	    for (const [prayerKey, time] of Object.entries(prayerTimesToday)) {
	        if (time === currentTime) {
	            const prayerName = prayerNames[prayerKey];
	            window.playAlarm(prayerName);
	        }
	    }
	    }
	    window.playAlarm = function(prayerName) {
	    const audio = document.getElementById('azan-alarm');
	    const notification = document.getElementById('alarm-notification');
	    const alarmText = document.getElementById('alarm-text');

	    // 1. Memainkan Audio
	    audio.pause();
	    audio.currentTime = 0;
	    // Panggil play() dan tangani error jika browser memblokir putar otomatis
	    audio.play().catch(e => console.error("Gagal memutar Azan, perlu interaksi pengguna:", e)); 

	    // 2. Menampilkan Notifikasi Pop-up (di dalam aplikasi)
	    if (alarmText) {
	        alarmText.textContent = `Waktu Salãt ${prayerName} Tiba!`;
	    }
	    // Hapus 'hidden' dan tampilkan dengan transisi
	    notification.classList.remove('hidden', 'translate-x-full', 'opacity-0');
	    notification.classList.add('translate-x-0', 'opacity-100');
	    
	    // 3. Mengirim Notifikasi Desktop (opsional)
	    window.sendNotification("Waktu Salãt Tiba!", `Sudah masuk waktu salãt ${prayerName}. Mari tunaikan ibadah.`);

	    // Sembunyikan notifikasi setelah beberapa saat
	    setTimeout(() => {
	        window.dismissAlarm();
	    }, 15000); // Notifikasi akan hilang setelah 15 detik
	    }
	    window.dismissAlarm = function() {
	    const audio = document.getElementById('azan-alarm');
	    const notification = document.getElementById('alarm-notification');
	    
	    // Hentikan audio
	    audio.pause();
	    audio.currentTime = 0;
	    
	    // Sembunyikan notifikasi dengan transisi
	    notification.classList.remove('translate-x-0', 'opacity-100');
	    notification.classList.add('translate-x-full', 'opacity-0');
	    
	    // Sembunyikan elemen secara total setelah transisi selesai
	    setTimeout(() => {
	        notification.classList.add('hidden');
	    }, 300); 
	    }
    window.showSantriListByKelas = function(kelas) {
        // 1. Ambil data dengan kunci yang sudah diubah ke angka
        const pondokId = sessionStorage.getItem('currentPondokId');
        const pondokData = appDataCache[pondokId];
        if (!pondokData) {
            // Jika data tidak ada, kembali ke halaman utama
            window.showPage('waliDashboard');
            return;
        }
        
        //  Tangani navigasi antar halaman utama
        //    showPage akan menyembunyikan halaman detail dan menampilkan dashboard wali
        window.showPage('waliDashboard');
        //  Tangani navigasi antar sub-halaman
        //    Ini yang membedakan tampilan kelas dan tampilan daftar santri
        const kelasListContainer = document.getElementById('kelas-list-container');
        const santriListContainer = document.getElementById('santri-list-container');
        if (kelasListContainer) kelasListContainer.classList.add('hidden');
        if (santriListContainer) santriListContainer.classList.remove('hidden');
        const filteredSantri = pondokData.santri.filter(s => s.kelas === kelas).sort((a, b) => a.nama.localeCompare(b.nama));
        const currentClassTitle = document.getElementById('current-class-title');
        const santriGallery = document.getElementById('santri-gallery');
        if (currentClassTitle) {
        currentClassTitle.textContent = `Daftar Santri Kelas ${kelas}`;
        }

        sessionStorage.setItem('currentWaliKelas', kelas);
        if (santriGallery) {
            santriGallery.innerHTML = '';
            if (filteredSantri.length === 0) {
                santriGallery.innerHTML = '<p class="text-center text-theme-secondary py-10">Tidak ada santri di kelas ini.</p>';
            } else {
                filteredSantri.forEach(santri => {
                    const fotoUrl = santri.foto || 'https://placehold.co/400x400?text=No+Photo';
                    const card = document.createElement('div');
                    card.className = 'text-center cursor-pointer group santri-card';
                    card.dataset.name = santri.nama;
                    card.innerHTML = `<div class="relative"><img src="${fotoUrl}" alt="Foto ${santri.nama}" class="w-full h-auto aspect-square rounded-full object-cover transition-transform duration-300 group-hover:scale-105 border-4 border-yellow-400 shadow-lg" onerror="this.onerror=null;this.src='https://placehold.co/400x400?text=Error';"><div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-50 rounded-full transition-all duration-300 flex items-center justify-center"><span class="text-white opacity-0 group-hover:opacity-100 font-bold">Lihat Detail</span></div></div><p class="mt-4 font-semibold text-theme">${santri.nama}</p><p class="text-sm text-theme-secondary">Kelas ${santri.kelas}</p>`;
                    card.onclick = () => window.showSantriDetail(santri.id);
                    santriGallery.appendChild(card);
                });
            }
        }
    }
    window.editGuru = async function(guruIdString) {
        const guruId = parseInt(guruIdString);
        const pondokData = await window.fetchData();
        if (!pondokData || !pondokData.guru) return;
        const guru = pondokData.guru.find(g => g.id === guruId);
        if (guru) {
            document.getElementById('guru-id').value = guru.id;
            document.getElementById('guru-nama').value = guru.nama;
            document.getElementById('guru-kelas').value = guru.mengajar_kelas;
            window.scrollTo(0, 0);
        }
    }

    window.deleteGuru = async function(guruIdString) {
        const guruId = parseInt(guruIdString);
        if (!confirm('Apakah Anda yakin ingin menghapus data guru ini?')) {
            return;
        }
        const pondokId = sessionStorage.getItem('currentPondokId');
        const saveSuccess = await window.saveData('/api/delete-guru', { pondokId, guruId });
        if (saveSuccess) {
            window.showToast('success', 'Data guru berhasil dihapus!');
            window.renderGuruList();
        } else {
            window.showToast('error', "Gagal menghapus data guru.");
        }
    }

    window.renderGuruHafalanTable = async function(santriId) {
        const pondokData = await window.fetchData();
        if (!pondokData || !pondokData.hafalan) return;
        const tableBody = document.getElementById('guru-hafalan-table');
        if (!tableBody) return;
        tableBody.innerHTML = '';
        const hafalanList = pondokData.hafalan.filter(h => h.santri_id === santriId).sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
        if (hafalanList.length === 0) {
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-theme-secondary">Belum ada setoran.</td></tr>';
            return;
        }
        hafalanList.forEach(h => {
            const row = tableBody.insertRow();
            row.innerHTML = `<td class="py-2 px-4 text-theme">${h.tanggal}</td><td class="py-2 px-4 font-medium text-theme">${h.setoran}</td><td class="py-2 px-4 text-theme">${h.jenis}</td><td class="py-2 px-4 text-theme">${h.penilaian}</td><td class="py-2 px-4"><button onclick="window.deleteHafalan('${h.id}', '${santriId}')" class="text-red-500 hover:text-red-700">Hapus</button></td>`;
        });
    }
    window.deleteHafalan = async function(hafalanIdString, santriIdString) {
        const hafalanId = parseInt(hafalanIdString);
        const santriId = parseInt(santriIdString);
        if (!confirm('Apakah Anda yakin ingin menghapus setoran hafalan ini?')) {
            return;
        }
        const pondokId = sessionStorage.getItem('currentPondokId');
        const saveSuccess = await window.saveData('/api/delete-hafalan', { pondokId, hafalanId });
        if (saveSuccess) {
            window.showToast('success', 'Setoran hafalan berhasil dihapus!');
            window.renderGuruHafalanTable(santriId);
        } else {
            window.showToast('error', "Gagal menghapus setoran hafalan.");
        }
    }
    
    window.updateTotalHafalan = async function() {
        // Ambil ID santri dari input tersembunyi
        const santriId = document.getElementById('santri-id').value;
        
        // Ambil nilai total hafalan juz dari input
        const totalHafalanJuzInput = document.getElementById('total-hafalan-juz-guru').value;

        console.log("ID Santri saat ini:", santriId);
        console.log("Total Hafalan Juz:", totalHafalanJuzInput);

        // Periksa apakah ID santri dan nilai total hafalan juz ada
        if (!santriId || totalHafalanJuzInput === "") {
            console.error("ID Santri atau total hafalan juz tidak ditemukan.");
            window.showToast('error', "ID Santri atau total hafalan juz tidak ditemukan.");
            return;
        }
        
        // Pastikan nilai yang dimasukkan adalah angka
        const totalHafalanJuz = parseInt(totalHafalanJuzInput);
        if (isNaN(totalHafalanJuz)) {
            console.error("Total Hafalan Juz harus berupa angka.");
            window.showToast('error', "Total Hafalan Juz harus berupa angka.");
            return;
        }
        
        const santri = (await window.fetchData()).santri.find(s => s.id === santriId);
        if (!santri) {
            window.showToast('error', "Santri tidak ditemukan.");
            return;
        }

        const santriData = {
            ...santri,
            total_hafalan_juz: totalHafalanJuz,
            target: { ...santri.target }
        };

        const saveSuccess = await window.saveData('/api/save-santri', { pondokId: sessionStorage.getItem('currentPondokId'), santriData: santriData });
        if (saveSuccess) {
            console.log("Total hafalan berhasil diperbarui!");
            window.showToast('success', "Total hafalan berhasil diperbarui!");
            // Perbarui cache data setelah perubahan
            await window.fetchData();
        } else {
            console.error("Gagal memperbarui total hafalan.");
            window.showToast('error', "Gagal memperbarui total hafalan.");
        }
    }


    // --- INITIALIZATION DAN EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
        // Dark/Light Mode
        const themeToggleBtn = document.getElementById('theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');

        const setInitialTheme = () => {
            let theme = localStorage.getItem('theme');
            if (!theme) {
                theme = prefersDark.matches ? 'dark' : 'light';
            }
            document.body.classList.toggle('dark-mode', theme === 'dark');
            themeIcon.textContent = theme === 'dark' ? '🌙' : '🌞';
        };

        themeToggleBtn.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            themeIcon.textContent = isDarkMode ? '🌙' : '🌞';
            if(myChart) {
                const textColor = getComputedStyle(document.body).getPropertyValue('--graph-text-color');
                const gridColor = getComputedStyle(document.body).getPropertyValue('--graph-grid-color');
                const colorMonthlyTarget = isDarkMode ? '#6B7280' : '#4B5563'; // Abu-abu Tua

                myChart.options.scales.x.ticks.color = textColor;
                myChart.options.scales.y.ticks.color = textColor;
                myChart.options.scales.x.grid.color = gridColor;
                myChart.options.scales.y.grid.color = gridColor;
                myChart.options.plugins.legend.labels.color = textColor;
                
                // Update warna dataset target bulanan
                const targetDataset = myChart.data.datasets.find(d => d.label.includes('Target Bulanan'));
                if (targetDataset) {
                    targetDataset.borderColor = colorMonthlyTarget;
                }
                
                myChart.update();
            }
        });
        setInitialTheme();
        // End Dark/Light Mode

        // --- Inisialisasi awal
        
        const alarmToggle = document.getElementById('alarm-toggle');
        if (alarmToggle) {
            alarmToggle.checked = localStorage.getItem('alarmEnabled') === 'true';
            alarmToggle.addEventListener('change', window.handleAlarmToggleChange);
        }
        
        const genderedKelas = [];
        for (let i = 65; i <= 90; i++) {
            const letter = String.fromCharCode(i);
            genderedKelas.push(`Kelas ${letter} putra`, `Kelas ${letter} putri`);
        }
        
        const kelasSelectSantri = document.getElementById('kelas');
        if (kelasSelectSantri) {
            kelasSelectSantri.innerHTML = '';
            genderedKelas.forEach(kelas => {
                kelasSelectSantri.add(new Option(kelas, kelas));
            });
        }
        const kelasSelectGuru = document.getElementById('guru-kelas');
        if (kelasSelectGuru) {
            kelasSelectGuru.innerHTML = '';
            genderedKelas.forEach(kelas => {
                kelasSelectGuru.add(new Option(kelas, kelas));
            });
        }

        const targetHarianSelect = document.getElementById('form-target-harian');
        if (targetHarianSelect) {
            targetHarianSelect.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                targetHarianSelect.add(new Option(`${i} Halaman`, `${i} Halaman`));
            }
        }
        const targetMingguanSelect = document.getElementById('form-target-mingguan');
        if (targetMingguanSelect) {
            targetMingguanSelect.innerHTML = '';
            for (let i = 1; i <= 20; i++) {
                targetMingguanSelect.add(new Option(`${i} Halaman`, `${i} Halaman`));
            }
        }
        
        // --- EVENT LISTENER BARU UNTUK UNGGAH VIDEO ---
        const videoFileEl = document.getElementById('video-file');
        const durationStatusEl = document.getElementById('video-duration-status');
        const uploadSubmitBtn = document.getElementById('upload-submit-btn');

        if (videoFileEl) {
            videoFileEl.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const tempVideo = document.createElement('video');
                    tempVideo.preload = 'metadata';
                    tempVideo.onloadedmetadata = function() {
                        window.URL.revokeObjectURL(tempVideo.src);
                        const duration = tempVideo.duration;
                        if (duration > 120) { // Max 2 minutes = 120 seconds
                            durationStatusEl.textContent = 'Durasi video terlalu panjang: ' + Math.floor(duration) + ' detik. Maksimal 120 detik.';
                            durationStatusEl.classList.remove('hidden');
                            uploadSubmitBtn.disabled = true;
                        } else {
                            durationStatusEl.classList.add('hidden');
                            uploadSubmitBtn.disabled = false;
                        }
                    }
                    tempVideo.src = URL.createObjectURL(file);
                } else {
                    uploadSubmitBtn.disabled = true;
                }
            });
        }

        const videoUploadForm = document.getElementById('video-upload-form');
        if(videoUploadForm) {
            videoUploadForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                uploadSubmitBtn.disabled = true;
                
                const videoFile = document.getElementById('video-file').files[0];
                const caption = document.getElementById('video-caption').value;
                const pondokId = sessionStorage.getItem('currentPondokId');
                const authorName = sessionStorage.getItem('pondokName'); 
                
                if (!videoFile || !pondokId) {
                     window.showToast('error', 'File video atau ID Pondok tidak ditemukan.');
                     uploadSubmitBtn.disabled = false;
                     return;
                }
                
                const formData = new FormData();
                formData.append('video', videoFile);
                formData.append('caption', caption);
                formData.append('pondokId', pondokId);
                formData.append('authorName', authorName);
                
                try {
                    const response = await fetch('/api/videos/upload', {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    if (result.success) {
                        window.showToast('success', 'Video berhasil diunggah!');
                        document.getElementById('upload-modal').classList.add('hidden');
                        window.renderVideoFeed('guru'); // Refresh feed
                    } else {
                        window.showToast('error', 'Gagal mengunggah video: ' + result.message);
                    }
                } catch (error) {
                    window.showToast('error', 'Error koneksi saat mengunggah video.');
                } finally {
                    uploadSubmitBtn.disabled = false;
                }
            });
        }
        
        // --- Semua Event Listener yang Sudah Ada (LANJUTKAN DI BAWAH INI) ---
        const pondokRegisterForm = document.getElementById('pondok-register-form');
        if (pondokRegisterForm) {
            pondokRegisterForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const pondokId = document.getElementById('register-pondok-id').value.trim();
                const password = document.getElementById('register-password').value;
         
                const errorEl = document.getElementById('register-error');
                if (!pondokId.includes('#') || password.length < 6) {
                    errorEl.textContent = "Format Nama Pondok salah atau kata sandi terlalu pendek.";
                    errorEl.classList.remove('hidden');
      
                    return;
                }
                const pondokName = pondokId.split('#')[0].trim();
                try {
              
                    const response = await fetch('/api/register', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        
                        body: JSON.stringify({ pondokId, password, pondokName })
                    });
                    const result = await response.json();
                    if (result.success) {
                        window.showToast('success', `Pendaftaran berhasil! Kode Akses Unik Anda: ${result.accessCode}. Salin kode ini dan berikan kepada wali santri.`);
                        window.showPage('pondokLogin');
                    } else {
                        errorEl.textContent = result.message;
                        errorEl.classList.remove('hidden');
                    }
                } catch (error) {
                    errorEl.textContent = "Terjadi kesalahan saat mendaftar.";
                    errorEl.classList.remove('hidden');
                }
            });
        }

        const pondokLoginForm = document.getElementById('pondok-login-form');
        if (pondokLoginForm) {
            pondokLoginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const pondokId = document.getElementById('login-pondok-id').value.trim();
                const password = document.getElementById('login-password').value;
         
                const errorEl = document.getElementById('pondok-login-error');
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
       
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ pondokId, password })
                    });
                   
                    const result = await response.json();
                    if (result.success) {
                        sessionStorage.setItem('currentPondokId', result.pondokDbId);
                        sessionStorage.setItem('pondokName', result.pondokName);
                        sessionStorage.setItem('role', 'guru');
                        window.checkLoginState();
                    } else {
                        errorEl.textContent = result.message;
                        errorEl.classList.remove('hidden');
                    }
                } catch (error) {
                    errorEl.textContent = "Terjadi kesalahan saat login.";
                    errorEl.classList.remove('hidden');
                }
            });
        }

        const accessCodeForm = document.getElementById('access-code-form');
        if (accessCodeForm) {
            accessCodeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const accessCode = document.getElementById('access-code').value.trim();
                const errorEl = document.getElementById('access-code-error');
        
                errorEl.classList.add('hidden');
                try {
                    const response = await fetch('/api/wali-login', {
                        method: 'POST',
         
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ accessCode })
                    });
                    const result 
                        = await response.json();
                    if (result.success) {
                        sessionStorage.setItem('currentPondokId', result.pondokDbId);
                        sessionStorage.setItem('pondokName', result.pondokName);
          
                        sessionStorage.setItem('role', 'wali');
                        window.checkLoginState();
                    } else {
                        errorEl.textContent = result.message;
                        errorEl.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("Error:", error);
                    errorEl.textContent = "Terjadi kesalahan koneksi. Silakan coba lagi.";
                    errorEl.classList.remove('hidden');
                }
            });
        }

        const santriForm = document.getElementById('santri-form');
        if (santriForm) {
            santriForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const form = this;
                const pondokId = sessionStorage.getItem('currentPondokId');
         
                const fotoInput = document.getElementById('foto');
                const currentPhotoUrl = document.getElementById('current-photo-url').value;
                let fotoUrl = currentPhotoUrl || null;
                if (fotoInput.files.length > 0) {
              
                    fotoUrl = await window.uploadFile(fotoInput.files[0]);
                    if (!fotoUrl) return;
                }
                const santriId = document.getElementById('santri-id').value ? parseInt(document.getElementById('santri-id').value) : null;
              
                const nama = document.getElementById('nama').value;
                const kelas = document.getElementById('kelas').value;
                
                const totalHafalanJuz = document.getElementById('total-hafalan-juz-guru').value;
                const harian = document.getElementById('form-target-harian').value;
                const mingguan = document.getElementById('form-target-mingguan').value;
                const bulanan = document.getElementById('form-target-bulanan').value;
                const tahunan = document.getElementById('form-target-tahunan').value;
                // Ambil nilai radio button. Perhatikan bahwa nilai yang disimpan adalah string 'true' atau 'false'
                const tercapaiValue = document.querySelector('input[name="tercapai"]:checked')?.value;
                const tercapai = tercapaiValue === 'true'; // Konversi ke boolean
                
                const santriData = {
                    id: santriId,
                   
                    nama: nama,
                    kelas: kelas,
                    foto: fotoUrl,
                    total_hafalan_juz: totalHafalanJuz,
                   
                    target: { harian, mingguan, bulanan, tahunan },
                    tercapai: tercapai // Simpan sebagai boolean
                };

                const saveSuccess = await window.saveData('/api/save-santri', { pondokId: pondokId, santriData: santriData });
                if (saveSuccess) {
                    window.showToast('success', 'Data santri berhasil disimpan!');
                    // Perbarui cache data setelah perubahan
                    await window.fetchData();
                    window.backToGuruDashboard();
                } else {
                    window.showToast('error', "Gagal menyimpan data di server.");
                }
            });
        }

        const guruForm = document.getElementById('guru-form');
        if (guruForm) {
            guruForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const pondokId = sessionStorage.getItem('currentPondokId');
                if (!pondokId) return;
                const guruId = document.getElementById('guru-id').value ? parseInt(document.getElementById('guru-id').value) : null;
                const nama = document.getElementById('guru-nama').value;
                const kelas = document.getElementById('guru-kelas').value;
                const guruData = { id: guruId, nama, mengajar_kelas: kelas };
                const saveSuccess = await window.saveData('/api/save-guru', { pondokId, guruData });
                if (saveSuccess) {
                    window.renderGuruList();
                    this.reset();
                    document.getElementById('guru-id').value = '';
                    window.showToast('success', 'Data guru berhasil disimpan!');
                } else {
                    window.showToast('error', "Gagal menyimpan data guru.");
                }
            });
        }
        
        const hafalanForm = document.getElementById('hafalan-form');
        if (hafalanForm) {
            hafalanForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const pondokId = sessionStorage.getItem('currentPondokId');
                if (!pondokId) return;
                const santriId = parseInt(document.getElementById('santri-id').value);
                const newHafalan = {
                    tanggal: document.getElementById('hafalan-tanggal').value,
                    setoran: document.getElementById('hafalan-setoran').value,
                    jenis: document.getElementById('hafalan-jenis').value,
                    penilaian: document.getElementById('hafalan-penilaian').value,
                    santriId: santriId
                };
                const saveSuccess = await window.saveData('/api/save-hafalan', { pondokId, hafalanData: newHafalan });
                if (saveSuccess) {
                    const santri = (await window.fetchData()).santri.find(s => s.id === santriId);
                    window.sendNotificationToGuardian(santri.nama, newHafalan.setoran, newHafalan.penilaian);
                    window.showToast('success', 'Data hafalan berhasil disimpan!');
                    window.renderGuruHafalanTable(santriId);
                    this.reset();
                } else {
                    window.showToast('error', "Gagal menambahkan setoran hafalan.");
                }
            });
        }
        
        // --- Panggil Fungsi Inisialisasi Aplikasi ---
        window.playWelcomeAnimation();
    });
</script>
  </body>
</html>
